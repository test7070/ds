z_tran_ds12:--z_tran_ds12    z_tran_ds.txt
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10) = '[1]'
	declare @t_name nvarchar(20) = '[2]'
	
	declare @t_bdate nvarchar(10) = case when '#non'=[3] then '' else [3] end
	declare @t_edate nvarchar(10) = case when '#non'=[4] then CHAR(255) else [4] end
	declare @t_btrandate nvarchar(10) = case when '#non'=[5] then '' else [5] end
	declare @t_etrandate nvarchar(10) = case when '#non'=[6] then CHAR(255) else [6] end	
	--------------------------------------------------------------------------------------
	declare @tmpa table(
		sel int identity(1,1)
		,accy nvarchar(10)
		,noa nvarchar(20)
		,noq nvarchar(10)
		,trandate nvarchar(20)
		,custno nvarchar(20)
		,cust nvarchar(100)
		,driverno nvarchar(20)
		,driver nvarchar(100)
		,total float
		,total2 float
	)
	
	insert into @tmpa(accy,noa,noq,trandate,custno,cust,driverno,driver,total,total2)
	select a.accy,a.noa,a.noq,a.trandate,a.custno,a.comp,a.driverno,a.driver,a.total,a.total2
	from view_trans a
	where a.trandate between @t_btrandate and @t_etrandate
	and not(ISNULL(a.total,0)=0 and ISNULL(a.total2,0)=0)
	--------------------------------------------------------------------------------------
	declare @tmpb table(
		sel int identity(1,1)
		,datea nvarchar(20)
		,accc3 nvarchar(20)
		,noq nvarchar(10)
		,accc5 nvarchar(20)
		,accc6 nvarchar(max)
		,accc7 nvarchar(max)
		,dmoney float
		,cmoney float
	)
	
	declare @tablea nvarchar(20)

	declare cursor_table cursor for
		select [name]
		from sys.tables
		where [name] like 'acccs[0-9][0-9][0-9]_[0-9]'
		order by [name]
	open cursor_table
	fetch next from cursor_table
	into @tablea
	while(@@FETCH_STATUS <> -1)
	begin
		insert into @tmpb(datea,accc3,noq,accc5,accc6,accc7,dmoney,cmoney)
		select substring(@tablea,6,3)+'/'+a.accc2
			,a.accc3,a.noq,a.accc5,a.accc6,a.accc7,a.dmoney,a.cmoney
		from acccs106_1 a
		left join accc106_1 b on a.accc3=b.accc3
		where b.accc3 is not null
		and substring(@tablea,6,3)+'/'+a.accc2 between @t_btrandate and @t_etrandate
		and (LEFT(a.accc5,1)='5' or LEFT(a.accc5,1)='6' or LEFT(a.accc5,1)='8') 
		and left(a.accc5,4)!='5850'
		
		fetch next from cursor_table
		into @tablea
	end
	close cursor_table
	deallocate cursor_table
	--------------------------------------------------------------------------------------
	declare @tmp table(
		sel int identity(1,1)
		,gno nvarchar(10)
		,pno int
		,recno int
		,itemno nvarchar(20)
		,item nvarchar(50)
		,money01 float
		,money02 float
		,money03 float
	)
	insert into @tmp(gno,pno,itemno,item,money01,money02)
	select '1',1,a.custno,isnull(b.comp,'')
		,sum(isnull(a.total,0)),sum(isnull(a.total2,0))
	from @tmpa a 
	left join cust b on a.custno=b.noa
	group by a.custno,b.comp
	
	-------------------------------------------------------------------------------------------------------
	insert into @tmp(gno,pno,itemno,item,money01,money02)
	select '2',2,a.accc5,a.accc6,sum(isnull(a.cmoney,0)),sum(isnull(a.dmoney,0))
	from @tmpb a
	group by accc5,accc6
	-------------------------------------------------------------------------------------------------------
	update @tmp set money03 = money01-money02
	update @tmp set recno=b.recno
	from @tmp a
	left join(select sel,ROW_NUMBER()over(order by money03 desc,itemno) recno from @tmp) b on a.sel=b.sel
	-- 總計
	insert into @tmp(gno,pno,itemno,item,money01,money02,money03)
	select '3',3,'','',SUM(ISNULL(money01,0)),SUM(ISNULL(money02,0)),SUM(ISNULL(money03,0)) 
	from @tmp 
	
	declare @titlea nvarchar(max)
	if @t_btrandate=@t_etrandate
	begin
		set @titlea = '日期：'+@t_btrandate
	end
	else
	begin
		set @titlea = '日期：'+@t_btrandate + '～' +@t_etrandate
	end
	
	select gno
		,@titlea titlea
		,recno rr
		,itemno a01
		,item a02
		,dbo.getComma(money01,-1) a03
		,dbo.getComma(money02,-1) a04
		,dbo.getComma(money03,-1) a05
	from @tmp
	order by pno,recno;


z_tran_dh01:--z_tran_dh01    z_tran_ds.txt
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10) = '[1]'
	declare @t_name nvarchar(20) = '[2]'
	
	declare @t_bdate nvarchar(10) = case when '#non'=[3] then '' else [3] end
	declare @t_edate nvarchar(10) = case when '#non'=[4] then CHAR(255) else [4] end
	declare @t_btrandate nvarchar(10) = case when '#non'=[5] then '' else [5] end
	declare @t_etrandate nvarchar(10) = case when '#non'=[6] then CHAR(255) else [6] end
	
	declare @t_bcustno nvarchar(20) = case when '#non'=[7] then '' else [7] end
	declare @t_ecustno nvarchar(20) = case when '#non'=[8] then CHAR(255) else [8] end
	declare @t_baddrno nvarchar(20) = case when '#non'=[9] then '' else [9] end
	declare @t_eaddrno nvarchar(20) = case when '#non'=[10] then CHAR(255) else [10] end
	declare @t_bdriverno nvarchar(20) = case when '#non'=[11] then '' else [11] end
	declare @t_edriverno nvarchar(20) = case when '#non'=[12] then CHAR(255) else [12] end	
	declare @t_carno nvarchar(20) = case when '#non'=[13] then '' else [13] end
	declare @t_po nvarchar(20) = case when '#non'=[14] then '' else [14] end
	
	declare @t_carkind  nvarchar(max)  = case when '#non'=[15] then '' else [15] end
	declare @t_carteamno  nvarchar(max)  = case when '#non'=[16] then '' else [16] end
	declare @t_calctypes  nvarchar(max)  = case when '#non'=[17] then '' else [17] end	
	
	declare @t_rate01 nvarchar(10) = case when '#non'=[18] then '' else [18] end
	declare @t_filter01 nvarchar(max) = case when '#non'=[19] then '' else [19] end
	declare @t_option01 nvarchar(max) = case when '#non'=[20] then '' else [20] end
	declare @t_sort01 nvarchar(max) = case when '#non'=[21] then '' else [21] end
	declare @t_sort03 nvarchar(max) = case when '#non'=[22] then '' else [22] end
	declare @t_filter04 nvarchar(max) = case when '#non'=[23] then '' else [23] end
	declare @t_sort04 nvarchar(max) = case when '#non'=[24] then '' else [24] end
	declare @t_sort05 nvarchar(max) = case when '#non'=[25] then '' else [25] end	
	declare @t_straddrno nvarchar(max) = case when '#non'=[32] then '' else [32] end
	declare @t_endaddrno nvarchar(max) = case when '#non'=[33] then '' else [33] end 	
	----------------------------------------------------------------------------------------
	declare @tmp table(
		sel int identity(1,1)
		,gno nvarchar(10)
		,tranaccy nvarchar(10)
		,tranno nvarchar(20)
		,trannoq nvarchar(10)
		,datea nvarchar(20)
		,trandate nvarchar(20)
		,custno nvarchar(20)
		,cust nvarchar(50)
		,driverno nvarchar(20)
		,driver nvarchar(20)
		,carno nvarchar(20)
		,productno nvarchar(20)
		,product nvarchar(50)
		,straddrno nvarchar(20)
		,straddr nvarchar(20)
		,endaddrno nvarchar(20)
		,endaddr nvarchar(20)
		,mount float
		,price float
		,custdiscount float
		,total float
		
		,mount2 float
		,price2 float
		,price3 float
		,discount float
		,total2 float
	)
	insert into @tmp(gno,tranaccy,tranno,trannoq,datea,trandate,custno,cust,driverno,driver,carno
		,productno,product,straddrno,straddr,endaddrno,endaddr
		,mount,price,custdiscount,total,mount2,price2,price3,discount,total2)
	select '1',accy,noa,noq,datea,trandate,custno,nick,driverno,driver,carno,uccno
		,product,straddrno,straddr,endaddrno,endaddr
		,mount,price,custdiscount,total,mount2,price2,price3,discount,total2
	from view_trans a
	where isnull(a.datea,'') between @t_bdate and @t_edate
	and isnull(a.trandate,'') between @t_btrandate and @t_etrandate
	and isnull(a.custno,'') between @t_bcustno and @t_ecustno
	and isnull(a.driverno,'') between @t_bdriverno and @t_edriverno
	and (len(@t_straddrno)=0 or  CHARINDEX(','+a.straddrno+',',@t_straddrno)>0)
	and (len(@t_endaddrno)=0 or  CHARINDEX(','+a.endaddrno+',',@t_endaddrno)>0)
	order by a.trandate,a.noa
	
	insert into @tmp(gno,mount,custdiscount,total,mount2,total2)
	select '2',SUM(ISNULL(mount,0)),SUM(ISNULL(custdiscount,0)),SUM(ISNULL(total,0))
		,SUM(ISNULL(mount2,0)),SUM(ISNULL(total2,0))
	from @tmp 
	where gno='1'
	------------------------------------------------------------------------------------------
	declare @string nvarchar(max)
	if len(@t_bdate)>0
		set  @string  =  '登錄日期：'+@t_bdate+'～'+@t_edate
	else
		set  @string   =  '交運日期：'+@t_btrandate+'～'+@t_etrandate
	set @string = '<a style="font-family:'+ "'Times New Roman','標楷體', serif"+char(59)+'">'+@string +'</a>'
	------------------------------------------------------------------------------------------	
	select @string titlea 
		,gno
		,sel rr
		,"trans_bs?noa=\'"+tranno+"\' and "+cast(sel as nvarchar)+"=$rr?"+tranaccy ghref
		,datea a01
		,trandate a02
		,cust a03
		,driver a04
		,carno a05
		,product a06
		,straddr a07
		,endaddr a08
		,dbo.getComma(mount,-1) a09
		,dbo.getComma(price,-1) a10
		,dbo.getComma(custdiscount,-1) a11
		,dbo.getComma(total,-1) a12
		,dbo.getComma(mount2,-1) a13
		,dbo.getComma(ISNULL(price2,0)+isnull(price3,0),-1) a14
		,dbo.getComma(discount,-1) a15
		,dbo.getComma(total2,-1) a16
	from @tmp 
	order by sel;

z_tran_ds05a:--z_tran_ds05a
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10) = '[1]'
	declare @t_name nvarchar(20) = '[2]'
	
	declare @t_bdate nvarchar(10) = case when '#non'=[3] then '' else [3] end
	declare @t_edate nvarchar(10) = case when '#non'=[4] then CHAR(255) else [4] end
	declare @t_btrandate nvarchar(10) = case when '#non'=[5] then '' else [5] end
	declare @t_etrandate nvarchar(10) = case when '#non'=[6] then CHAR(255) else [6] end
	
	declare @t_bcustno nvarchar(20) = case when '#non'=[7] then '' else [7] end
	declare @t_ecustno nvarchar(20) = case when '#non'=[8] then CHAR(255) else [8] end
	declare @t_baddrno nvarchar(20) = case when '#non'=[9] then '' else [9] end
	declare @t_eaddrno nvarchar(20) = case when '#non'=[10] then CHAR(255) else [10] end
	declare @t_bdriverno nvarchar(20) = case when '#non'=[11] then '' else [11] end
	declare @t_edriverno nvarchar(20) = case when '#non'=[12] then CHAR(255) else [12] end	
	declare @t_carno nvarchar(20) = case when '#non'=[13] then '' else [13] end
	declare @t_po nvarchar(20) = case when '#non'=[14] then '' else [14] end
	
	declare @t_carkind  nvarchar(max)  = case when '#non'=[15] then '' else [15] end
	declare @t_carteamno  nvarchar(max)  = case when '#non'=[16] then '' else [16] end
	declare @t_calctypes  nvarchar(max)  = case when '#non'=[17] then '' else [17] end	
	
	declare @t_rate01 nvarchar(10) = case when '#non'=[18] then '' else [18] end
	declare @t_filter01 nvarchar(max) = case when '#non'=[19] then '' else [19] end
	declare @t_option01 nvarchar(max) = case when '#non'=[20] then '' else [20] end
	declare @t_sort01 nvarchar(max) = case when '#non'=[21] then '' else [21] end
	declare @t_sort03 nvarchar(max) = case when '#non'=[22] then '' else [22] end
	declare @t_filter04 nvarchar(max) = case when '#non'=[23] then '' else [23] end
	declare @t_sort04 nvarchar(max) = case when '#non'=[24] then '' else [24] end
	declare @t_sort05 nvarchar(max) = case when '#non'=[25] then '' else [25] end
	
	----------------------------------------------------------------------------------------
	declare @tmp table(
		recno int,
		totrecno int,
		gno nvarchar(3),
		accy nvarchar(20),
		tranno nvarchar(20),
		trannoq nvarchar(10),
		trandate nvarchar(10),
		datea nvarchar(10),
		custno nvarchar(20),
		comp nvarchar(40),
		driverno nvarchar(20),
		namea nvarchar(20),
		carno nvarchar(20),
		straddrno nvarchar(20),
		addr nvarchar(40),
		product nvarchar(40),
		inmount float,
		pton float,
		mount decimal(10,3),
		price float,
		total float,
		outmount decimal(10,3),
		pton2 decimal(10,3),
		mount2 decimal(10,3),
		price2 float,
		price3 float,
		discount decimal(10,3),
		total2 float,
		drivermoney float,
		po nvarchar(30),
		caseno nvarchar(30),
		cc  nvarchar(20),
		tt  nvarchar(20),
		carcount int
	)
	
	set @cmd = 
	" select row_number()over(partition by isnull(a.driverno,''),isnull(a.carno,'') order by a."+@t_sort05+",a.noa)"+
	" ,row_number()over(order by isnull(a.driverno,''),isnull(a.carno,''),a."+@t_sort05+",a.noa)"+
	" ,'1',a.accy,a.noa,a.noq,a.trandate,a.datea,a.custno,a.comp"+
	" ,isnull(a.driverno,''),a.driver,isnull(a.carno,''),a.straddrno,a.straddr,a.product"+
	" ,a.inmount,a.pton,a.mount,a.price,a.total"+
	" ,a.outmount,a.pton2,a.mount2,a.price2,a.price3,a.discount,a.total2"+
	" ,round((price2+price3)*mount2,0)"+
	" ,a.po,a.caseno,c.typea,b.team"+
	" from view_trans a"+
	" left join carteam  b on a.carteamno=b.noa"+	
	" left join calctypes c on a.calctype=c.noa+c.noq"+
	" where a.datea  between  @t_bdate  and  @t_edate"+
	"	and a.trandate  between  @t_btrandate  and  @t_etrandate"+
	"	and a.custno  between  @t_bcustno   and  @t_ecustno"+
	"	and isnull(a.driverno,'') between  @t_bdriverno   and  @t_edriverno"+
	"	and (len(@t_carno)=0  or  a.carno=@t_carno)"+
	"	and (len(@t_po)=0  or  a.po=@t_po)"+
	"	and a.straddrno between @t_baddrno and @t_eaddrno"+
	"	and (len(@t_carteamno)=0 or CHARINDEX(','+a.carteamno+',',','+@t_carteamno+',')>0)"+
	"	and (len(@t_calctypes)=0 or CHARINDEX(','+a.calctype+',',','+@t_calctypes+',')>0)"
	
	insert into @tmp(recno,totrecno,gno,accy,tranno,trannoq,trandate,datea,custno,comp,driverno,namea,carno
		,straddrno,addr,product,inmount,pton,mount,price,total
		,outmount,pton2,mount2,price2,price3,discount,total2,drivermoney,po,caseno,cc,tt)
	execute sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_btrandate nvarchar(10),@t_etrandate nvarchar(10),@t_bcustno nvarchar(20),@t_ecustno nvarchar(20),@t_bdriverno nvarchar(20),@t_edriverno nvarchar(20),@t_carno nvarchar(20),@t_po nvarchar(max),@t_baddrno nvarchar(20),@t_eaddrno nvarchar(20),@t_carteamno nvarchar(max),@t_calctypes nvarchar(max)'
		,@t_bdate=@t_bdate,@t_edate=@t_edate,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno
		,@t_carno=@t_carno,@t_po=@t_po,@t_baddrno=@t_baddrno,@t_eaddrno=@t_eaddrno
		,@t_carteamno=@t_carteamno,@t_calctypes=@t_calctypes
	------------------------------------------------------------------------------------------------
	
	insert into @tmp(gno,driverno,carno,carcount,mount,total,mount2,total2,drivermoney,outmount,pton2,inmount,pton)
	select '2',driverno,carno,count(1),SUM(ISNULL(mount,0)),SUM(ISNULL(total,0))
		,SUM(ISNULL(mount2,0)),SUM(ISNULL(total2,0))
		,SUM(ISNULL(drivermoney,0)),SUM(isnull(outmount,0)),SUM(ISNULL(pton2,0))
		,SUM(ISNULL(inmount,0)),SUM(ISNULL(pton,0))
		 from @tmp 
		where gno='1' group  by  driverno,carno
	
	insert into @tmp(gno,driverno,carno,carcount,mount,total,mount2,total2,drivermoney,outmount,pton2,inmount,pton)
	select '3',CHAR(255),CHAR(255),count(1),SUM(ISNULL(mount,0)),SUM(ISNULL(total,0))
		,SUM(ISNULL(mount2,0)),SUM(ISNULL(total2,0))
		,SUM(ISNULL(drivermoney,0)),SUM(isnull(outmount,0)),SUM(ISNULL(pton2,0))
		,SUM(ISNULL(inmount,0)),SUM(ISNULL(pton,0)) 
		from @tmp 	
		where gno='1'
	------------------------------------------------------------------------------------------
	declare @string nvarchar(max)
	if len(@t_bdate)>0
		set  @string  =  '登錄日期：'+@t_bdate+'～'+@t_edate
	else
		set  @string   =  '交運日期：'+@t_btrandate+'～'+@t_etrandate
	set @string = '<a style="font-family:'+ "'Times New Roman','標楷體', serif"+char(59)+'">'+@string +'</a>'
	------------------------------------------------------------------------------------------	
	select @string titlea 
		,totrecno rr
		,"trans_ds?noa=\'"+tranno+"\' and "+cast(totrecno as nvarchar)+"=$rr?"+accy ghref
		,gno,trandate  aa,custno bb,driverno mm,namea cc,carno dd,carcount ss,straddrno,addr,product ee,inmount pp1,pton qq1,mount ff1,outmount pp2,pton2 qq2,mount2 ff2
		,case when price2=0 then price3 else price2 end gg,discount hh
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total2),1)),4,12)) ii
		,caseno jj,case when right(tranno,1)=char(255) then '' else tranno  end kk
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,drivermoney),1)),4,12)) dm
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) ff3
	from @tmp 
	order by driverno,carno,gno,recno;

z_tran_ds11c:--z_tran_ds11c
	SET QUOTED_IDENTIFIER OFF 
	declare @cmd nvarchar(max) 
	--23
	declare @t_bmon nvarchar(10) = case when '#non'=[30] then '' else [30] end
	declare @t_emon nvarchar(10) = case when '#non'=[31] then char(255) else [31] end
	--3
	declare @t_bcustno nvarchar(20) = case when '#non'=[7] then '' else [7] end
	declare @t_ecustno nvarchar(20) = case when '#non'=[8] then CHAR(255) else [8] end
	--4
	declare @t_baddrno nvarchar(20) = case when '#non'=[9] then '' else [9] end
	declare @t_eaddrno nvarchar(20) = case when '#non'=[10] then CHAR(255) else [10] end
	--5
	declare @t_bdriverno nvarchar(20) = case when '#non'=[11] then '' else [11] end
	declare @t_edriverno nvarchar(20) = case when '#non'=[12] then CHAR(255) else [12] end
	--6
	declare @t_carno nvarchar(max) = case when '#non'=[13] then '' else [13] end
	--7
	declare @t_po nvarchar(max) = case when '#non'=[14] then '' else [14] end
	--9
	declare @t_carteam nvarchar(max) = case when '#non'=[16] then '' else [16] end
	--10
	declare @t_calctype nvarchar(max)  = case when '#non'=[17] then '' else [17] end
	--------------------------------------------------------------------------------
	declare @tmp table(
		tggno nvarchar(20),
		tgg nvarchar(40),
		gno nvarchar(10),
		pno nvarchar(10),
		rno nvarchar(max),
		caryear nvarchar(20),
		carkindno nvarchar(20),
		carkind nvarchar(20),
		oilmount float,
		miles float,
		oilrate float,
		kl float,
		carday float,
		trandate nvarchar(10),
		custno nvarchar(20),
		cust nvarchar(50),
		carno nvarchar(20),
		driverno nvarchar(20),
		driver nvarchar(20),
		insures float,
		money1 float,
		money2 float,
		custplus float,
		custminus float,
		driverplus float,
		driverminus float,
		reserve float,
		tolls float,
		etc float,
		oil float,
		wmoney float,
		wmoneycar float,
		wmoneyplate float,
		cmoney float,
		dmoney float,
		emoney float,
		ticket float,
		bonus float,
		tax float,
		depreciation float,
		driverpay float,
		profit float
	)
	insert into @tmp(custno,cust,gno,pno,insures,money1,money2
		,custplus,custminus,driverplus,driverminus,reserve,tolls,etc,oil
		,wmoney,wmoneycar,wmoneyplate,cmoney,dmoney,emoney,ticket,bonus,tax,depreciation,driverpay)
	select isnull(a.custno,''),isnull(f.nick,''),'1','1'
		,sum(ISNULL(a.insures,0)),sum(ISNULL(a.money1,0)),sum(ISNULL(a.money2,0))
		,sum(ISNULL(a.custplus,0)),sum(ISNULL(a.custminus,0)),sum(ISNULL(a.driverplus,0)),sum(ISNULL(a.driverminus,0))
		,sum(ISNULL(a.reserve,0)),sum(ISNULL(a.tolls,0)),sum(ISNULL(a.etc,0)),sum(ISNULL(a.oil,0))
		,sum(ISNULL(a.wmoney,0)),sum(ISNULL(a.wmoneycar,0)),sum(ISNULL(a.wmoneyplate,0)),sum(ISNULL(a.cmoney,0)),sum(ISNULL(a.dmoney,0)),sum(ISNULL(a.emoney,0))
		,sum(ISNULL(a.ticket,0)),sum(ISNULL(a.bonus,0)),sum(ISNULL(a.tax,0)),sum(ISNULL(a.depreciation,0)) 
		,sum(isnull(a.driverpay,0))
	from trans_sum a
	left join car2 b on a.carno=b.carno
	left join carkind c on b.carkindno=c.noa
	left join view_trans d on a.tranaccy=d.accy and a.tranno=d.noa and a.trannoq=d.noq
	left join tgg e on d.tggno=e.noa
	left join cust f on a.custno=f.noa
	where a.mon between @t_bmon and @t_emon
	and isnull(a.custno,'') between @t_bcustno and @t_ecustno
	and isnull(a.driverno,'') between @t_bdriverno and @t_edriverno
	and isnull(d.straddrno,'') between @t_baddrno and @t_eaddrno
	and (len(@t_carno)=0 or (len(ISNULL(b.carno,''))>0 and CHARINDEX(','+b.carno+',',','+@t_carno+',')>0))
	and (len(@t_calctype)=0 or  CHARINDEX(','+d.calctype+',',','+@t_calctype+',')>0)
	and (len(@t_carteam)=0 or  CHARINDEX(','+d.carteamno+',',','+@t_carteam+',')>0)
	and (len(@t_po)=0 or  CHARINDEX(d.po,@t_po)>0)
	group by isnull(a.custno,''),isnull(f.nick,'')
	
	
	insert into @tmp(custno,gno,pno,insures,money1,money2
		,custplus,custminus,driverplus,driverminus,reserve,tolls,etc,oil
		,wmoney,wmoneycar,wmoneyplate,cmoney,dmoney,emoney,ticket,bonus,tax,depreciation,driverpay)
	select CHAR(255),'2','2',sum(insures),SUM(money1),SUM(money2)
		,SUM(custplus),SUM(custminus),SUM(driverplus),SUM(driverminus),SUM(reserve),SUM(tolls),SUM(etc),SUM(oil)
		,SUM(wmoney),SUM(wmoneycar),SUM(wmoneyplate),SUM(cmoney),SUM(dmoney),SUM(emoney),SUM(ticket),SUM(bonus),SUM(tax),SUM(depreciation)
		,sum(driverpay)
	from @tmp where pno='1' 

	
	update @tmp set profit=money1-money2-insures+custplus-custminus-driverplus+driverminus-reserve-tolls
		-etc-oil-wmoney-cmoney-dmoney-emoney-ticket-bonus-tax-depreciation+driverpay
	update @tmp set gno = '4' where profit<0 and pno='1'
	

	select *
	,caryear m01
	,cast(round(oilrate,0) as nvarchar)+'%' m02
	,cast(kl as decimal(10,1)) m03
	,carday m04
	,carno m05
	,driver m06
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,money1),1)),4,12))  m07
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,custplus),1)),4,12))  m08
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,custminus),1)),4,12))  m09
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,money2),1)),4,12))  m10
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,driverplus),1)),4,12))  m11
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,driverminus),1)),4,12))  m12
--	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,reserve),1)),4,12))  m13
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tolls,0)+ISNULL(etc,0)),1)),4,12))  m14
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,oil),1)),4,12))  m15
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ISNULL(wmoney,0)),1)),4,12))  m16
	--,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,wmoneycar),1)),4,12))  ma16
	--,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,wmoneyplate),1)),4,12))  mb16
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ISNULL(cmoney,0)),1)),4,12))  m17
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ISNULL(dmoney,0)),1)),4,12))  m18
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ISNULL(emoney,0)),1)),4,12))  m19
--	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ticket),1)),4,12))  m18
--	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bonus),1)),4,12)) m19
--	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,tax),1)),4,12))  m20
--	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,depreciation),1)),4,12))  m21
--	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,insures),1)),4,12))  m22
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,profit),1)),4,12))  m24
--	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,driverpay),1)),4,12))  m25
	from @tmp 
	order by case when len(carkindno)=0 then CHAR(255) else carkindno end
		,pno
		,rno
		,caryear
		,case when len(carno)=0 then CHAR(255) else carno end
		;
		
z_tran_ds11b:--z_tran_ds11b
	SET QUOTED_IDENTIFIER OFF 
	declare @cmd nvarchar(max) 
	--23
	declare @t_bmon nvarchar(10) = case when '#non'=[30] then '' else [30] end
	declare @t_emon nvarchar(10) = case when '#non'=[31] then char(255) else [31] end
	--3
	declare @t_bcustno nvarchar(20) = case when '#non'=[7] then '' else [7] end
	declare @t_ecustno nvarchar(20) = case when '#non'=[8] then CHAR(255) else [8] end
	--4
	declare @t_baddrno nvarchar(20) = case when '#non'=[9] then '' else [9] end
	declare @t_eaddrno nvarchar(20) = case when '#non'=[10] then CHAR(255) else [10] end
	--5
	declare @t_bdriverno nvarchar(20) = case when '#non'=[11] then '' else [11] end
	declare @t_edriverno nvarchar(20) = case when '#non'=[12] then CHAR(255) else [12] end
	--6
	declare @t_carno nvarchar(max) = case when '#non'=[13] then '' else [13] end
	--7
	declare @t_po nvarchar(max) = case when '#non'=[14] then '' else [14] end
	--9
	declare @t_carteam nvarchar(max) = case when '#non'=[16] then '' else [16] end
	--10
	declare @t_calctype nvarchar(max)  = case when '#non'=[17] then '' else [17] end
	--------------------------------------------------------------------------------
	declare @tmp table(
		tggno nvarchar(20),
		tgg nvarchar(40),
		gno nvarchar(10),
		pno nvarchar(10),
		rno nvarchar(max),
		caryear nvarchar(20),
		carkindno nvarchar(20),
		carkind nvarchar(20),
		oilmount float,
		miles float,
		oilrate float,
		kl float,
		carday float,
		trandate nvarchar(10),
		custno nvarchar(20),
		cust nvarchar(50),
		carno nvarchar(20),
		driverno nvarchar(20),
		driver nvarchar(20),
		insures float,
		money1 float,
		money2 float,
		custplus float,
		custminus float,
		driverplus float,
		driverminus float,
		reserve float,
		tolls float,
		etc float,
		oil float,
		wmoney float,
		wmoneycar float,
		wmoneyplate float,
		cmoney float,
		dmoney float,
		emoney float,
		ticket float,
		bonus float,
		tax float,
		depreciation float,
		driverpay float,
		profit float
	)
	insert into @tmp(tggno,tgg,gno,pno,insures,money1,money2
		,custplus,custminus,driverplus,driverminus,reserve,tolls,etc,oil
		,wmoney,wmoneycar,wmoneyplate,cmoney,dmoney,emoney,ticket,bonus,tax,depreciation,driverpay)
	select isnull(d.tggno,''),isnull(e.nick,''),'1','1'
		,sum(ISNULL(a.insures,0)),sum(ISNULL(a.money1,0)),sum(ISNULL(a.money2,0))
		,sum(ISNULL(a.custplus,0)),sum(ISNULL(a.custminus,0)),sum(ISNULL(a.driverplus,0)),sum(ISNULL(a.driverminus,0))
		,sum(ISNULL(a.reserve,0)),sum(ISNULL(a.tolls,0)),sum(ISNULL(a.etc,0)),sum(ISNULL(a.oil,0))
		,sum(ISNULL(a.wmoney,0)),sum(ISNULL(a.wmoneycar,0)),sum(ISNULL(a.wmoneyplate,0)),sum(ISNULL(a.cmoney,0)),sum(ISNULL(a.dmoney,0)),sum(ISNULL(a.emoney,0))
		,sum(ISNULL(a.ticket,0)),sum(ISNULL(a.bonus,0)),sum(ISNULL(a.tax,0)),sum(ISNULL(a.depreciation,0)) 
		,sum(isnull(a.driverpay,0))
	from trans_sum a
	left join car2 b on a.carno=b.carno
	left join carkind c on b.carkindno=c.noa
	left join view_trans d on a.tranaccy=d.accy and a.tranno=d.noa and a.trannoq=d.noq
	left join tgg e on d.tggno=e.noa
	where a.mon between @t_bmon and @t_emon
	and isnull(a.custno,'') between @t_bcustno and @t_ecustno
	and isnull(a.driverno,'') between @t_bdriverno and @t_edriverno
	and isnull(d.straddrno,'') between @t_baddrno and @t_eaddrno
	and (len(@t_carno)=0 or (len(ISNULL(b.carno,''))>0 and CHARINDEX(','+b.carno+',',','+@t_carno+',')>0))
	and (len(@t_calctype)=0 or  CHARINDEX(','+d.calctype+',',','+@t_calctype+',')>0)
	and (len(@t_carteam)=0 or  CHARINDEX(','+d.carteamno+',',','+@t_carteam+',')>0)
	and (len(@t_po)=0 or  CHARINDEX(d.po,@t_po)>0)
	group by isnull(d.tggno,''),isnull(e.nick,'')
	
	
	insert into @tmp(tggno,gno,pno,insures,money1,money2
		,custplus,custminus,driverplus,driverminus,reserve,tolls,etc,oil
		,wmoney,wmoneycar,wmoneyplate,cmoney,dmoney,emoney,ticket,bonus,tax,depreciation,driverpay)
	select CHAR(255),'2','2',sum(insures),SUM(money1),SUM(money2)
		,SUM(custplus),SUM(custminus),SUM(driverplus),SUM(driverminus),SUM(reserve),SUM(tolls),SUM(etc),SUM(oil)
		,SUM(wmoney),SUM(wmoneycar),SUM(wmoneyplate),SUM(cmoney),SUM(dmoney),SUM(emoney),SUM(ticket),SUM(bonus),SUM(tax),SUM(depreciation)
		,sum(driverpay)
	from @tmp where pno='1' 

	
	update @tmp set profit=money1-money2-insures+custplus-custminus-driverplus+driverminus-reserve-tolls
		-etc-oil-wmoney-cmoney-dmoney-emoney-ticket-bonus-tax-depreciation+driverpay
	update @tmp set gno = '4' where profit<0 and pno='1'
	
	
	select *
	,caryear m01
	,cast(round(oilrate,0) as nvarchar)+'%' m02
	,cast(kl as decimal(10,1)) m03
	,carday m04
	,carno m05
	,driver m06
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,money1),1)),4,12))  m07
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,custplus),1)),4,12))  m08
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,custminus),1)),4,12))  m09
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,money2),1)),4,12))  m10
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,driverplus),1)),4,12))  m11
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,driverminus),1)),4,12))  m12
--	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,reserve),1)),4,12))  m13
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tolls,0)+ISNULL(etc,0)),1)),4,12))  m14
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,oil),1)),4,12))  m15
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ISNULL(wmoney,0)),1)),4,12))  m16
	--,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,wmoneycar),1)),4,12))  ma16
	--,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,wmoneyplate),1)),4,12))  mb16
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ISNULL(cmoney,0)),1)),4,12))  m17
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ISNULL(dmoney,0)),1)),4,12))  m18
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ISNULL(emoney,0)),1)),4,12))  m19
--	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ticket),1)),4,12))  m18
--	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bonus),1)),4,12)) m19
--	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,tax),1)),4,12))  m20
--	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,depreciation),1)),4,12))  m21
--	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,insures),1)),4,12))  m22
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,profit),1)),4,12))  m24
--	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,driverpay),1)),4,12))  m25
	from @tmp 
	order by case when len(carkindno)=0 then CHAR(255) else carkindno end
		,pno
		,rno
		,caryear
		,case when len(carno)=0 then CHAR(255) else carno end
		;


z_tran_ds11a:--z_tran_ds11a	
	SET QUOTED_IDENTIFIER OFF 
	declare @cmd nvarchar(max) 
	--23
	declare @t_bmon nvarchar(10) = case when '#non'=[30] then '' else [30] end
	declare @t_emon nvarchar(10) = case when '#non'=[31] then char(255) else [31] end
	--3
	declare @t_bcustno nvarchar(20) = case when '#non'=[7] then '' else [7] end
	declare @t_ecustno nvarchar(20) = case when '#non'=[8] then CHAR(255) else [8] end
	--4
	declare @t_baddrno nvarchar(20) = case when '#non'=[9] then '' else [9] end
	declare @t_eaddrno nvarchar(20) = case when '#non'=[10] then CHAR(255) else [10] end
	--5
	declare @t_bdriverno nvarchar(20) = case when '#non'=[11] then '' else [11] end
	declare @t_edriverno nvarchar(20) = case when '#non'=[12] then CHAR(255) else [12] end
	--6
	declare @t_carno nvarchar(max) = case when '#non'=[13] then '' else [13] end
	--7
	declare @t_po nvarchar(max) = case when '#non'=[14] then '' else [14] end
	--9
	declare @t_carteam nvarchar(max) = case when '#non'=[16] then '' else [16] end
	--10
	declare @t_calctype nvarchar(max)  = case when '#non'=[17] then '' else [17] end
	--22
	declare @t_detail nvarchar(max) = case when '#non'=[29] then '' else [29] end
	--------------------------------------------------------------------------------
	declare @tmp table(
		gno nvarchar(10),
		pno nvarchar(10),
		rno nvarchar(max),
		caryear nvarchar(20),
		carkindno nvarchar(20),
		carkind nvarchar(20),
		oilmount float,
		miles float,
		oilrate float,
		kl float,
		carday float,
		trandate nvarchar(10),
		custno nvarchar(20),
		cust nvarchar(50),
		carno nvarchar(20),
		driverno nvarchar(20),
		driver nvarchar(20),
		insures float,
		money1 float,
		money2 float,
		custplus float,
		custminus float,
		driverplus float,
		driverminus float,
		reserve float,
		tolls float,
		etc float,
		oil float,
		wmoney float,
		wmoneycar float,
		wmoneyplate float,
		cmoney float,
		dmoney float,
		emoney float,
		ticket float,
		bonus float,
		tax float,
		depreciation float,
		driverpay float,
		profit float
	)
	insert into @tmp(gno,pno,carkindno,carkind,carno,insures,money1,money2
		,custplus,custminus,driverplus,driverminus,reserve,tolls,etc,oil
		,wmoney,wmoneycar,wmoneyplate,cmoney,dmoney,emoney,ticket,bonus,tax,depreciation,driverpay)
	select '1','1',isnull(b.carkindno,''),ISNULL(c.kind,''),ISNULL(a.carno,'')
		,sum(ISNULL(a.insures,0)),sum(ISNULL(a.money1,0)),sum(ISNULL(a.money2,0))
		,sum(ISNULL(a.custplus,0)),sum(ISNULL(a.custminus,0)),sum(ISNULL(a.driverplus,0)),sum(ISNULL(a.driverminus,0))
		,sum(ISNULL(a.reserve,0)),sum(ISNULL(a.tolls,0)),sum(ISNULL(a.etc,0)),sum(ISNULL(a.oil,0))
		,sum(ISNULL(a.wmoney,0)),sum(ISNULL(a.wmoneycar,0)),sum(ISNULL(a.wmoneyplate,0)),sum(ISNULL(a.cmoney,0)),sum(ISNULL(a.dmoney,0)),sum(ISNULL(a.emoney,0))
		,sum(ISNULL(a.ticket,0)),sum(ISNULL(a.bonus,0)),sum(ISNULL(a.tax,0)),sum(ISNULL(a.depreciation,0)) 
		,sum(isnull(a.driverpay,0))
	from trans_sum a
	left join car2 b on a.carno=b.carno
	left join carkind c on b.carkindno=c.noa
	left join view_trans d on a.tranaccy=d.accy and a.tranno=d.noa and a.trannoq=d.noq
	where a.mon between @t_bmon and @t_emon
	and isnull(a.custno,'') between @t_bcustno and @t_ecustno
	and isnull(a.driverno,'') between @t_bdriverno and @t_edriverno
	and isnull(d.straddrno,'') between @t_baddrno and @t_eaddrno
	and (len(@t_carno)=0 or (len(ISNULL(b.carno,''))>0 and CHARINDEX(','+b.carno+',',','+@t_carno+',')>0))
	and (len(@t_calctype)=0 or  CHARINDEX(','+d.calctype+',',','+@t_calctype+',')>0)
	and (len(@t_carteam)=0 or  CHARINDEX(','+d.carteamno+',',','+@t_carteam+',')>0)
	and (len(@t_po)=0 or  CHARINDEX(d.po,@t_po)>0)
	group by isnull(b.carkindno,''),ISNULL(c.kind,''),ISNULL(a.carno,'')
	
	update @tmp set caryear=b.caryear,oilmount=c.mount,oilrate=case when money1!=0 then oil/money1*100 else 0 end
		,miles=c.miles
		,kl=case when c.mount!=0 then c.miles/c.mount else 0 end
		,carday=d.mount
	from @tmp a
	left join car2 b on a.carno=b.carno
	left join (select carno,SUM(isnull(mount,0)) mount,SUM(ISNULL(miles,0)) miles 
		from oil where LEFT(datea,6) between @t_bmon and @t_emon group by carno) c on a.carno=c.carno
	left join (select carno,count(1) mount 
		from (SELECT DISTINCT isnull(carno,'') carno,trandate from trans_sum where mon between @t_bmon and @t_emon) a 
		group by carno) d on a.carno=d.carno 
	
	insert into @tmp(gno,pno,carkindno,carkind,miles,oilmount,insures,money1,money2
		,custplus,custminus,driverplus,driverminus,reserve,tolls,etc,oil
		,wmoney,wmoneycar,wmoneyplate,cmoney,dmoney,emoney,ticket,bonus,tax,depreciation,driverpay)
	select '2','2',CHAR(255),CHAR(255),SUM(ISNULL(miles,0)),SUM(isnull(oilmount,0)),sum(insures),SUM(money1),SUM(money2)
		,SUM(custplus),SUM(custminus),SUM(driverplus),SUM(driverminus),SUM(reserve),SUM(tolls),SUM(etc),SUM(oil)
		,SUM(wmoney),SUM(wmoneycar),SUM(wmoneyplate),SUM(cmoney),SUM(dmoney),SUM(emoney),SUM(ticket),SUM(bonus),SUM(tax),SUM(depreciation)
		,sum(driverpay)
	from @tmp where pno='1'

	update @tmp set oilrate=case when money1!=0 then oil/money1*100 else 0 end
		,kl = case when oilmount!=0 then miles/oilmount else 0 end
	where pno='2'
	
	update @tmp set profit=money1-money2-insures+custplus-custminus-driverplus+driverminus-reserve-tolls
		-etc-oil-wmoney-cmoney-dmoney-emoney-ticket-bonus-tax-depreciation+driverpay
	update @tmp set gno = '4' where profit<0 and pno='1'
	----------------------------------------------------------------------------------------------------
	if len(@t_detail)>0
	begin
		update @tmp set gno='5',rno=case when len(isnull(caryear,''))>0 then '1' else '2' end+isnull(caryear,'')+carno+CHAR(255) where gno='1'
		update @tmp set gno='6',rno=case when len(isnull(caryear,''))>0 then '1' else '2' end+isnull(caryear,'')+carno where gno='4'
		
		insert into @tmp(gno,pno,rno,carkindno,carkind,trandate,custno,cust,carno,driverno,driver,insures,money1,money2
			,custplus,custminus,driverplus,driverminus,reserve,tolls,etc,oil
			,wmoney,wmoneycar,wmoneyplate,cmoney,dmoney,emoney,ticket,bonus,tax,depreciation,driverpay)
		select '7','1'
			,case when len(isnull(b.caryear,''))>0 then '1' else '2' end+isnull(b.caryear,'')+a.carno
			,isnull(b.carkindno,''),ISNULL(c.kind,''),ISNULL(a.trandate,''),ISNULL(a.custno,''),ISNULL(e.nick,'')
			,ISNULL(a.carno,''),ISNULL(a.driverno,''),ISNULL(d.namea,'')
			,ISNULL(a.insures,0),ISNULL(a.money1,0),ISNULL(a.money2,0)
			,ISNULL(a.custplus,0),ISNULL(a.custminus,0),ISNULL(a.driverplus,0),ISNULL(a.driverminus,0)
			,ISNULL(a.reserve,0),ISNULL(a.tolls,0),ISNULL(a.etc,0),ISNULL(a.oil,0)
			,ISNULL(a.wmoney,0),ISNULL(a.wmoneycar,0),ISNULL(a.wmoneyplate,0),ISNULL(a.cmoney,0),ISNULL(a.dmoney,0),ISNULL(a.emoney,0)
			,ISNULL(a.ticket,0),ISNULL(a.bonus,0),ISNULL(a.tax,0),ISNULL(a.depreciation,0) 
			,isnull(a.driverpay,0)
		from trans_sum a
		left join car2 b on a.carno=b.carno
		left join carkind c on b.carkindno=c.noa
		left join driver d on a.driverno=d.noa
		left join cust e on a.custno=e.noa
		left join view_trans f on a.tranaccy=f.accy and a.tranno=f.noa and a.trannoq=f.noq
		where a.mon between @t_bmon and @t_emon
		and isnull(a.custno,'') between @t_bcustno and @t_ecustno
		and isnull(a.driverno,'') between @t_bdriverno and @t_edriverno
		and isnull(f.straddrno,'') between @t_baddrno and @t_eaddrno
		and (len(@t_carno)=0 or (len(ISNULL(b.carno,''))>0 and CHARINDEX(','+b.carno+',',','+@t_carno+',')>0))
		and (len(@t_calctype)=0 or  CHARINDEX(','+f.calctype+',',','+@t_calctype+',')>0)
		and (len(@t_carteam)=0 or  CHARINDEX(','+f.carteamno+',',','+@t_carteam+',')>0)
		and (len(@t_po)=0 or  CHARINDEX(f.po,@t_po)>0)
		order by a.trandate
	end
	----------------------------------------------------------------------------------------------------
	select *
	,caryear m01
	,cast(round(oilrate,0) as nvarchar)+'%' m02
	,cast(kl as decimal(10,1)) m03
	,carday m04
	,carno m05
	,driver m06
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,money1),1)),4,12))  m07
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,custplus),1)),4,12))  m08
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,custminus),1)),4,12))  m09
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,money2),1)),4,12))  m10
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,driverplus),1)),4,12))  m11
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,driverminus),1)),4,12))  m12
--	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,reserve),1)),4,12))  m13
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tolls,0)+ISNULL(etc,0)),1)),4,12))  m14
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,oil),1)),4,12))  m15
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ISNULL(wmoney,0)),1)),4,12))  m16
	--,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,wmoneycar),1)),4,12))  ma16
	--,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,wmoneyplate),1)),4,12))  mb16
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ISNULL(cmoney,0)),1)),4,12))  m17
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ISNULL(dmoney,0)),1)),4,12))  m18
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ISNULL(emoney,0)),1)),4,12))  m19
--	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ticket),1)),4,12))  m18
--	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bonus),1)),4,12)) m19
--	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,tax),1)),4,12))  m20
--	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,depreciation),1)),4,12))  m21
--	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,insures),1)),4,12))  m22
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,profit),1)),4,12))  m24
--	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,driverpay),1)),4,12))  m25
	from @tmp 
	order by case when len(carkindno)=0 then CHAR(255) else carkindno end
		,pno
		,rno
		,caryear
		,case when len(carno)=0 then CHAR(255) else carno end
		;
		
z_tran_ds09:--z_tran_ds09
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_baddrno nvarchar(20)
	declare @t_eaddrno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(max)
	declare @t_po nvarchar(max)
	declare @t_calctype nvarchar(max)
	declare @t_carteam nvarchar(max)
	declare @t_option08 nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_btrandate = case when '#non'=[5] then '' else [5] end
	set @t_etrandate = case when '#non'=[6] then CHAR(255) else [6] end
	set @t_bcustno = case when '#non'=[7] then '' else [7] end
	set @t_ecustno = case when '#non'=[8] then CHAR(255) else [8] end
	set @t_baddrno = case when '#non'=[9] then '' else [9] end
	set @t_eaddrno = case when '#non'=[10] then CHAR(255) else [10] end
	set @t_bdriverno = case when '#non'=[11] then '' else [11] end
	set @t_edriverno = case when '#non'=[12] then CHAR(255) else [12] end
	set @t_carno = case when '#non'=[13] then '' else [13] end
	set @t_po = case when '#non'=[14] then '' else [14] end
	set @t_carteam = case when '#non'=[16] then '' else [16] end
	set @t_calctype = case when '#non'=[17] then '' else [17] end
	set @t_option08 = case when '#non'=[29] then '' else [29] end
	----------------------------------------------------------------------------------------------
	declare @string nvarchar(max)
	declare @n int
	--解析要計算的種類
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(20)
	)
	set @string = @t_carteam
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#carno')is not null
	BEGIN
		set @cmd = 'drop table #carno'
		EXECUTE sp_executesql @cmd
	END
	create table #carno(
		noa nvarchar(20)
	)
	set @string = @t_carno
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carno select @string
			end
			break
		end
		insert into #carno select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#po')is not null
	BEGIN
		set @cmd = 'drop table #po'
		EXECUTE sp_executesql @cmd
	END
	create table #po(
		noa nvarchar(20)
	)
	set @string = @t_po
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #po select @string
			end
			break
		end
		insert into #po select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(20)
	)
	set @string = @t_calctype
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	----------------------------------------------------------------------------------------------
	declare @mon nvarchar(10)
	declare @datea nvarchar(10)
	declare @custno nvarchar(20)
	declare @nick nvarchar(20)
	declare @carno nvarchar(20)
	declare @driverno nvarchar(20)
	declare @cardealno nvarchar(20)
	declare @cardeal nvarchar(20)
	declare @plus float
	declare @minus float
	declare @curplus float
	declare @curminus float
	declare @custplus float
	declare @custminus float
	declare @carplus float
	declare @carminus float
	declare @diffplus float
	declare @diffminus float
	declare @tranno nvarchar(20)
	declare @trannoq nvarchar(10)
	
	declare @fixa float
	declare @tire float
	declare @item float
	declare @other float
	declare @curfixa float
	declare @curtire float
	declare @curitem float
	declare @curother float
	declare @carfixa float
	declare @cartire float
	declare @caritem float
	declare @carother float
	declare @difffixa float
	declare @difftire float
	declare @diffitem float
	declare @diffother float
	
	declare @oil float
	declare @etc float
	declare @curoil float
	declare @curetc float
	declare @caroil float
	declare @caretc float
	declare @diffoil float
	declare @diffetc float
	
	declare @carteamno nvarchar(20)
	declare @carteam nvarchar(20)
	declare @trandate nvarchar(10)
	declare @addrno nvarchar(20)
	declare @addr nvarchar(40)
	--declare @carno nvarchar(20)
	declare @driver nvarchar(20)
	declare @total float
	declare @total2 float
	declare @reserve float
	declare @tolls float
	--declare @custplus float
	--declare @custminus float
	--declare @carplus float
	--declare @carminus float
	--declare @fixa float
	--declare @tire float
	--declare @ticket float
	--declare @bonus float
	--declare @tax float
	--declare @depreciation float
	declare @profit float
	declare @gno nvarchar(10)
	declare @miles float
	----------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_tmp_ds')is not null
	BEGIN
		set @cmd = 'drop table #z_tmp_ds'
		EXECUTE sp_executesql @cmd
	END
	create table #z_tmp_ds(
		isoutside int,
		tranno nvarchar(20),
		trannoq nvarchar(10),
		datea nvarchar(10),
		trandate nvarchar(10),
		carteamno nvarchar(20),
		carteam nvarchar(20),
		calctype nvarchar(20),
		
		custno nvarchar(20),
		custnick nvarchar(20),
		addrno nvarchar(20),
		addr nvarchar(40),
		cardealno nvarchar(20),
		cardeal nvarchar(40),
		
		carno nvarchar(20),
		driverno nvarchar(20),
		driver nvarchar(20),
		miles float,
		po nvarchar(max),
		
		mount float,
		price float,
		total float,
		
		mount2 float,
		price2 float,
		price3 float,
		discount float,
		total2 float,
		
		reserve float,
		tolls float,
		memo nvarchar(max),
		
		custplus float,
		custminus float,
		
		carplus float,
		carminus float,
		oil float,
		etc float,
		fixa float,
		tire float,
		item float, 	
		other float,
		profit float
	)
	set @cmd = 
	" select isnull(c.isoutside,0),a.noa,a.noq,a.datea,a.trandate,isnull(a.carteamno,''),b.team,a.calctype"+
	" ,isnull(a.custno,''),a.nick,a.straddrno,a.straddr,a.cardealno,d.nick"+
	" ,a.carno,a.driverno,a.driver,isnull(a.miles,0),a.po"+
	" ,a.mount,a.price,a.total"+
	" ,a.mount2,a.price2,a.price3,a.discount,a.total2"+
	" ,a.reserve,a.tolls,a.memo"+
	" from view_trans a"+
	" left join carteam b on a.carteamno = b.noa"+
	" left join calctypes c on a.calctype = c.noa+c.noq"+
	" left join acomp d on a.cardealno=d.noa"+
	" where (left(a.trandate,6) between left(@t_btrandate,6) and left(@t_etrandate,6))"
	
	create index tranno on #z_tmp_ds(tranno,trannoq)
	insert into #z_tmp_ds(isoutside,tranno,trannoq,datea,trandate,carteamno,carteam,calctype
		,custno,custnick,addrno,addr,cardealno,cardeal
		,carno,driverno,driver,miles,po
		,mount,price,total
		,mount2,price2,price3,discount,total2
		,reserve,tolls,memo
	)
	execute sp_executesql @cmd,N'@t_btrandate nvarchar(10),@t_etrandate nvarchar(10)'
	,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate
	----------------------------------------------------------------------------------------------
	--客戶加減項
	declare @tmp01 table(
		mon nvarchar(10),
		custno nvarchar(20),
		plus float,
		minus float,
		custplus float,
		custminus float
	)
	insert into @tmp01(mon,custno,plus,minus)
	select LEFT(a.datea,6),isnull(a.custno,''),SUM(ISNULL(plusmoney,0)),SUM(ISNULL(minusmoney,0)) 
	from custchg a
	--排除 代收、付,暫收
	where (left(a.acc1,4)!='2195') and (left(a.acc1,4)!='1191') 
	and (left(a.acc1,4)!='2191') and (left(a.acc1,4)!='1149') 
	and (left(a.acc1,4)!='1194') and (left(a.acc1,4)!='1129') 
	and (left(a.acc1,4)!='4201') and (left(a.acc1,4)!='4202') 
	and left(a.datea,6) between left(@t_btrandate,6) and left(@t_etrandate,6)
	group by LEFT(a.datea,6),isnull(a.custno,'')
	--收金額合計
	declare @tmp01_a table(
		mon nvarchar(10),
		custno nvarchar(20),
		total float
	)
	insert into @tmp01_a(mon,custno,total)
	select LEFT(a.trandate,6),isnull(a.custno,''),SUM(ISNULL(total,0)) 
	from #z_tmp_ds a
	group by LEFT(a.trandate,6),isnull(a.custno,'') 
	--依收金額比例分配加減項金額
	update #z_tmp_ds
	set custplus = case when ISNULL(c.total,0)=0 then 0 else round(isnull(a.total,0)*ISNULL(b.plus,0)/ISNULL(c.total,0),0)end
		,custminus = case when ISNULL(c.total,0)=0 then 0 else round(isnull(a.total,0)*ISNULL(b.minus,0)/ISNULL(c.total,0),0)end
	from #z_tmp_ds a
	inner join @tmp01 b on left(a.trandate,6)=b.mon and a.custno = b.custno 
	inner join @tmp01_a c on left(a.trandate,6)=c.mon and a.custno = c.custno 
	--檢查有客戶加減項,但當月無收金額的
	insert into #z_tmp_ds(carteamno,custno,trandate,custplus,custminus,addr)
	select 'zzzzz##',a.custno,a.mon,a.plus,a.minus,c.nick+'當月無出車'
	from @tmp01 a
	left join @tmp01_a b on a.mon=b.mon and a.custno=b.custno
	left join cust c on a.custno=c.noa
	where isnull(b.total,0)=0 and (isnull(a.plus,0)!=0 or isnull(a.minus,0)!=0)
	----修正誤差,由收入最高的依序補回一次補1,LOOP
	update @tmp01
	set custplus = ISNULL(b.custplus,0)
		,custminus = ISNULL(b.custminus,0)
	from @tmp01 a
	inner join (select LEFT(ISNULL(trandate,''),6) mon
		,ISNULL(custno,'') custno
		, SUM(ISNULL(custplus,0)) custplus
		,SUM(ISNULL(custminus,0)) custminus 
		from #z_tmp_ds 
		group by LEFT(ISNULL(trandate,''),6),ISNULL(custno,'')) b on a.mon=b.mon and a.custno=b.custno
	
	--修正誤差用
	declare @ztmp01 table(
		recno int,
		custno nvarchar(20),
		mon nvarchar(10),
		tranno nvarchar(20),
		trannoq nvarchar(10),
		custplus float,
		custminus float
		UNIQUE (recno,custno,mon)
	)
	insert into @ztmp01(recno,custno,mon,tranno,trannoq,custplus,custminus)
	select ROW_NUMBER()over(partition by isnull(custno,''),LEFT(isnull(trandate,''),6) order by isnull(total,0) desc,tranno,trannoq) 
	,isnull(custno,''),LEFT(isnull(trandate,''),6),tranno,trannoq,isnull(custplus,0),isnull(custminus,0)
	from #z_tmp_ds
	
	declare cursor_table cursor for
	select mon,custno,custplus-plus,custminus - minus from @tmp01 
	open cursor_table
	fetch next from cursor_table
	into @mon,@custno,@plus,@minus
	while(@@FETCH_STATUS <> -1)
	begin		
		select @n = 1,@curplus=@plus,@curminus=@minus
		while(@curplus!=0 or @curminus!=0)
		begin		
			if not exists(select tranno from @ztmp01 where custno=@custno and @mon=mon and recno=@n)
			begin
				if((@curplus=@plus and @plus!=0) or (@curminus=@minus and @minus!=0))
				begin
					--找第一筆
					if exists(select tranno from @ztmp01 where custno=@custno and @mon=mon and recno=1)
					begin
						select @tranno=tranno,@trannoq=trannoq,@custplus=custplus,@custminus=custminus 
						from @ztmp01 where custno=@custno and @mon=mon and recno=1
						
						update #z_tmp_ds set custplus=isnull(custplus,0)-@custplus
						,custminus=isnull(custminus,0)-@custminus
						where tranno=@tranno and trannoq=@trannoq
						break
					end
					else
					begin
					----避免LOOP
					select '資料異常 @ztmp01 01',@custno,@mon,@n
					return
					end
				return
				end
				set @n = 1
			end
			select @tranno=tranno,@trannoq=trannoq,@custplus=custplus,@custminus=custminus 
			from @ztmp01 where custno=@custno and @mon=mon and recno=@n
			if(@tranno is null)
			begin
				select '資料異常 @ztmp01 02',@custno,@mon,@n
				return
			end
			select @diffplus=0,@diffminus=0 
			if(@custplus!=0)
			begin
				set @diffplus = case when @curplus>0 then -1 when @curplus<0 then 1 else 0 end
				set @curplus = @curplus + @diffplus
			end
			if(@custminus!=0)
			begin
				set @diffminus = case when @curminus>0 then -1 when @curminus<0 then 1 else 0 end
				set @curminus = @curminus + @diffminus
			end			
			update #z_tmp_ds set custplus=isnull(custplus,0)+@diffplus
			,custminus=isnull(custminus,0)+@diffminus 
			where tranno=@tranno and trannoq=@trannoq
			
			set @n = @n + 1
		end
		fetch next from cursor_table
		into @mon,@custno,@plus,@minus
	end
	close cursor_table
	deallocate cursor_table
	----------------------------------------------------------------------------------------------
	--司機加減項
	declare @tmp02 table(
		mon nvarchar(10),
		carno nvarchar(20),
		driverno nvarchar(20),
		plus float,
		minus float,
		carplus float,
		carminus float
	)
	insert into @tmp02(mon,carno,driverno,plus,minus)
	select LEFT(a.datea,6),isnull(a.carno,''),isnull(a.driverno,''),SUM(ISNULL(plusmoney,0)),SUM(ISNULL(minusmoney,0)) 
	from carchg a
	--排除 代收、付,暫收
	--where (left(a.acc1,4)!='2195') and (left(a.acc1,4)!='1191') 
	--and (left(a.acc1,4)!='2191') and (left(a.acc1,4)!='1149') 
	--and (left(a.acc1,4)!='1194') and (left(a.acc1,4)!='1129') 
	--and (left(a.acc1,4)!='4201') and (left(a.acc1,4)!='4202') 
	--有付款廠商的就判斷為代收、代付
	where len(isnull(a.tggno,''))=0
	and left(a.datea,6) between left(@t_btrandate,6) and left(@t_etrandate,6)
	--借支排除
	and charindex('借支',a.minusitem)=0
	group by LEFT(a.datea,6),isnull(a.carno,''),isnull(a.driverno,'')
	--發金額合計
	declare @tmp02_a table(
		mon nvarchar(10),
		carno nvarchar(20),
		driverno nvarchar(20),
		total2 float
	)
	insert into @tmp02_a(mon,carno,driverno,total2)
	select LEFT(a.trandate,6),isnull(a.carno,''),isnull(a.driverno,''),SUM(ISNULL(total2,0)) 
	from #z_tmp_ds a
	group by LEFT(a.trandate,6),isnull(a.carno,''),isnull(a.driverno,'')
	--依發金額比例分配加減項金額
	update #z_tmp_ds
	set carplus = case when ISNULL(c.total2,0)=0 then 0 else round(isnull(a.total2,0)*ISNULL(b.plus,0)/ISNULL(c.total2,0),0)end
		,carminus = case when ISNULL(c.total2,0)=0 then 0 else round(isnull(a.total2,0)*ISNULL(b.minus,0)/ISNULL(c.total2,0),0)end
	from #z_tmp_ds a
	inner join @tmp02 b on left(a.trandate,6)=b.mon and a.carno=b.carno and a.driverno=b.driverno 
	inner join @tmp02_a c on left(a.trandate,6)=c.mon and a.carno=c.carno and a.driverno=c.driverno 
	--檢查有司機加減項,但當月無發金額的
	insert into #z_tmp_ds(carteamno,custno,trandate,carno,driverno,driver,carplus,carminus,addr)
	select 'zzzzz##','zzzzz##',a.mon,a.carno,a.driverno,c.namea,a.plus,a.minus,'當月無出車'
	from @tmp02 a
	left join @tmp02_a b on a.mon=b.mon and a.carno=b.carno and a.driverno=b.driverno
	left join driver c on a.driverno=c.noa
	where isnull(b.total2,0)=0 and (isnull(a.plus,0)!=0 or isnull(a.minus,0)!=0)
	----修正誤差,由發金額最高的依序補回一次補1,LOOP
	update @tmp02
	set carplus = ISNULL(b.carplus,0)
		,carminus = ISNULL(b.carminus,0)
	from @tmp02 a
	inner join (select LEFT(ISNULL(trandate,''),6) mon
		,ISNULL(carno,'') carno
		,ISNULL(driverno,'') driverno
		, SUM(ISNULL(carplus,0)) carplus
		,SUM(ISNULL(carminus,0)) carminus 
		from #z_tmp_ds 
		group by LEFT(ISNULL(trandate,''),6),ISNULL(carno,''),ISNULL(driverno,'')) b 
	on a.mon=b.mon and a.carno=b.carno and a.driverno=b.driverno 
	
	--修正誤差用
	declare @ztmp02 table(
		recno int,
		carno nvarchar(20),
		driverno nvarchar(20),
		mon nvarchar(10),
		tranno nvarchar(20),
		trannoq nvarchar(10),
		carplus float,
		carminus float
		UNIQUE (recno,carno,driverno,mon)
	)
	insert into @ztmp02(recno,carno,driverno,mon,tranno,trannoq,carplus,carminus)
	select ROW_NUMBER()over(partition by isnull(carno,''),isnull(driverno,''),LEFT(isnull(trandate,''),6) order by isnull(total2,0) desc,tranno,trannoq) 
	,isnull(carno,''),isnull(driverno,''),LEFT(isnull(trandate,''),6),tranno,trannoq,isnull(carplus,0),isnull(carminus,0)
	from #z_tmp_ds
	
	declare cursor_table cursor for
	select mon,carno,driverno,carplus-plus,carminus - minus from @tmp02
	open cursor_table
	fetch next from cursor_table
	into @mon,@carno,@driverno,@plus,@minus
	while(@@FETCH_STATUS <> -1)
	begin		
		select @n = 1,@curplus=@plus,@curminus=@minus
		while(@curplus!=0 or @curminus!=0)
		begin		
			if not exists(select tranno from @ztmp02 where carno=@carno and driverno=@driverno and @mon=mon and recno=@n)
			begin
				if((@curplus=@plus and @plus!=0) or (@curminus=@minus and @minus!=0))
				begin
					--避免LOOP
					select '資料異常 @ztmp02 01',@carno,@driverno,@mon,@n,@curplus,@curminus
					return
				return
				end
				set @n = 1
			end
			select @tranno=tranno,@trannoq=trannoq,@carplus=carplus,@carminus=carminus 
			from @ztmp02 where carno=@carno and driverno=@driverno and @mon=mon and recno=@n
			if(@tranno is null)
			begin
				select '資料異常 @ztmp02 02',@carno,@driverno,@mon,@n,@curplus,@curminus
				return
			end
			select @diffplus=0,@diffminus=0 
			if(@carplus!=0)
			begin
				set @diffplus = case when @curplus>0 then -1 when @curplus<0 then 1 else 0 end
				set @curplus = @curplus + @diffplus
			end
			if(@carminus!=0)
			begin
				set @diffminus = case when @curminus>0 then -1 when @curminus<0 then 1 else 0 end
				set @curminus = @curminus + @diffminus
			end			
			update #z_tmp_ds set carplus=isnull(carplus,0)+@diffplus
			,carminus=isnull(carminus,0)+@diffminus 
			where tranno=@tranno and trannoq=@trannoq
			
			set @n = @n + 1
		end
		fetch next from cursor_table
		into @mon,@carno,@driverno,@plus,@minus
	end
	close cursor_table
	deallocate cursor_table
	----------------------------------------------------------------------------------------------
	--維修、輪胎、材料
	declare @tmp03 table(
		mon nvarchar(10),
		carno nvarchar(20),
		driverno nvarchar(20),
		fixa float,
		tire float,
		item float,
		other float,
		carfixa float,
		cartire float,
		caritem float,
		carother float
	)
	insert into @tmp03(mon,carno,driverno,fixa,tire,item,other)
	select mon,carno,driverno,round(SUM(fixa),0),round(SUM(tire),0),round(SUM(item),0),round(SUM(other),0)
	from(
		select LEFT(a.fixadate,6) mon,isnull(a.carno,'') carno,isnull(a.driverno,'') driverno
		,SUM(ISNULL(a.wmoney,0)) fixa,SUM(ISNULL(a.cmoney,0)) tire,SUM(ISNULL(a.dmoney,0)) item,SUM(ISNULL(a.emoney,0)) other
		from fixa a
		where left(a.fixadate,6) between left(@t_btrandate,6) and left(@t_etrandate,6)
		group by LEFT(a.fixadate,6),isnull(a.carno,''),isnull(a.driverno,'')
		union all
		select LEFT(a.outdate,6),isnull(a.carno,''),isnull(a.driverno,'')
		,SUM(ISNULL(a.wmoney,0)) fixa,SUM(ISNULL(a.cmoney,0)) tire,SUM(ISNULL(a.dmoney,0)) item,SUM(ISNULL(a.emoney,0)) other
		from fixout a
		where left(a.outdate,6) between left(@t_btrandate,6) and left(@t_etrandate,6)
		group by LEFT(a.outdate,6),isnull(a.carno,''),isnull(a.driverno,'')
		union all
		select LEFT(a.datea,6),isnull(a.carno,''),isnull(a.driverno,'')
		,SUM(ISNULL(a.wmoney,0)) fixa,SUM(ISNULL(a.cmoney,0)) tire,SUM(ISNULL(a.dmoney,0)) item,SUM(ISNULL(a.emoney,0)) other
		from tire a
		where left(a.datea,6) between left(@t_btrandate,6) and left(@t_etrandate,6)
		group by LEFT(a.datea,6),isnull(a.carno,''),isnull(a.driverno,'')
		)a
	group by mon,carno,driverno 
	
	--收金額合計
	declare @tmp03_a table(
		mon nvarchar(10),
		carno nvarchar(20),
		driverno nvarchar(20),
		total float
	)
	insert into @tmp03_a(mon,carno,driverno,total)
	select LEFT(a.trandate,6),isnull(a.carno,''),isnull(a.driverno,''),SUM(ISNULL(total,0)) 
	from #z_tmp_ds a
	group by LEFT(a.trandate,6),isnull(a.carno,''),isnull(a.driverno,'') 
	--依收金額比例分配維修、輪胎、材料
	update #z_tmp_ds
	set fixa = case when ISNULL(c.total,0)=0 then 0 else round(isnull(a.total,0)*ISNULL(b.fixa,0)/ISNULL(c.total,0),0)end
		,tire = case when ISNULL(c.total,0)=0 then 0 else round(isnull(a.total,0)*ISNULL(b.tire,0)/ISNULL(c.total,0),0)end
		,item = case when ISNULL(c.total,0)=0 then 0 else round(isnull(a.total,0)*ISNULL(b.item,0)/ISNULL(c.total,0),0)end
		,other = case when ISNULL(c.total,0)=0 then 0 else round(isnull(a.total,0)*ISNULL(b.other,0)/ISNULL(c.total,0),0)end
	from #z_tmp_ds a
	inner join @tmp03 b on left(a.trandate,6)=b.mon and a.carno=b.carno and a.driverno=b.driverno 
	inner join @tmp03_a c on left(a.trandate,6)=c.mon and a.carno=c.carno and a.driverno=c.driverno 
	--檢查有維修、輪胎、材料,但當月無收金額的
	insert into #z_tmp_ds(carteamno,custno,trandate,carno,driverno,driver,fixa,tire,item,other,addr)
	select 'zzzzz##','zzzzz##',a.mon,a.carno,a.driverno,c.namea,a.fixa,a.tire,a.item,a.other,'當月無出車'
	from @tmp03 a
	left join @tmp03_a b on a.mon=b.mon and a.carno=b.carno and a.driverno=b.driverno
	left join driver c on a.driverno=c.noa
	where isnull(b.total,0)=0 and (isnull(a.fixa,0)!=0 or isnull(a.tire,0)!=0 or isnull(a.item,0)!=0 or isnull(a.other,0)!=0)
	----修正誤差,由收入最高的依序補回一次補1,LOOP
	update @tmp03
	set carfixa = ISNULL(b.fixa,0)
		,cartire = ISNULL(b.tire,0)
		,caritem = ISNULL(b.item,0)
		,carother = ISNULL(b.other,0)
	from @tmp03 a
	inner join (select LEFT(ISNULL(trandate,''),6) mon
		,ISNULL(carno,'') carno
		,ISNULL(driverno,'') driverno
		,SUM(ISNULL(fixa,0)) fixa
		,SUM(ISNULL(tire,0)) tire
		,SUM(ISNULL(item,0)) item
		,SUM(ISNULL(other,0)) other
		from #z_tmp_ds 
		group by LEFT(ISNULL(trandate,''),6),ISNULL(carno,''),ISNULL(driverno,'')) b 
		on a.mon=b.mon and a.carno=b.carno and a.driverno=b.driverno
	
	--修正誤差用
	declare @ztmp03 table(
		recno int,
		carno nvarchar(20),
		driverno nvarchar(20),
		mon nvarchar(10),
		tranno nvarchar(20),
		trannoq nvarchar(10),
		fixa float,
		tire float,
		item float,
		other float
		UNIQUE (recno,carno,driverno,mon)
	)
	insert into @ztmp03(recno,carno,driverno,mon,tranno,trannoq,fixa,tire,item,other)
	select ROW_NUMBER()over(partition by isnull(carno,''),isnull(driverno,''),LEFT(isnull(trandate,''),6) order by isnull(total,0) desc,tranno,trannoq) 
	,isnull(carno,''),isnull(driverno,''),LEFT(isnull(trandate,''),6),tranno,trannoq,isnull(fixa,0),isnull(tire,0),isnull(item,0),isnull(other,0)
	from #z_tmp_ds
	
	declare cursor_table cursor for
	select mon,carno,driverno,carfixa-fixa,cartire-tire,caritem-item,carother-other from @tmp03 
	open cursor_table
	fetch next from cursor_table
	into @mon,@carno,@driverno,@fixa,@tire,@item,@other
	while(@@FETCH_STATUS <> -1)
	begin		
		select @n = 1,@curfixa=@fixa,@curtire=@tire,@curitem=@item,@curother=@other
		while(@curfixa!=0 or @curtire!=0 or @curitem!=0 or @curother!=0)
		begin		
			if not exists(select tranno from @ztmp03 where carno=@carno and driverno=@driverno and mon=@mon and recno=@n)
			begin
				if((@curfixa=@fixa and @fixa!=0) or (@curtire=@tire and @tire!=0) or (@curitem=@item and @item!=0) or (@curother=@other and @other!=0))
				begin
					--避免LOOP
					select '資料異常 @ztmp03 01',@carno,@driverno,@mon,@n
					return
				return
				end
				set @n = 1
			end
			select @tranno=tranno,@trannoq=trannoq,@carfixa=fixa,@cartire=tire,@caritem=item,@carother=other
			from @ztmp03 where carno=@carno and driverno=@driverno and mon=@mon and recno=@n
			if(@tranno is null)
			begin
				select '資料異常 @ztmp03 02',@carno,@driverno,@mon,@n
				return
			end
			select @difffixa=0,@difftire=0,@diffitem=0,@diffother=0
			if(@carfixa!=0)
			begin
				set @difffixa = case when @curfixa>0 then -1 when @curfixa<0 then 1 else 0 end
				set @curfixa = @curfixa + @difffixa
			end
			if(@cartire!=0)
			begin
				set @difftire = case when @curtire>0 then -1 when @curtire<0 then 1 else 0 end
				set @curtire = @curtire + @difftire
			end
			if(@caritem!=0)
			begin
				set @diffitem = case when @curitem>0 then -1 when @curitem<0 then 1 else 0 end
				set @curitem = @curitem + @diffitem
			end
			if(@carother!=0)
			begin
				set @diffother = case when @curother>0 then -1 when @curother<0 then 1 else 0 end
				set @curother = @curother + @diffother
			end	
			update #z_tmp_ds set fixa=isnull(fixa,0)+@difffixa
			,tire=isnull(tire,0)+@difftire
			,item=isnull(item,0)+@diffitem
			,other=isnull(other,0)+@diffother
			where tranno=@tranno and trannoq=@trannoq
			
			set @n = @n + 1
		end
		fetch next from cursor_table
		into @mon,@carno,@driverno,@fixa,@tire,@item,@other
	end
	close cursor_table
	deallocate cursor_table
	----------------------------------------------------------------------------------------------
	--加油,ETC
	declare @tmp2 table(
		carno nvarchar(20),
		oil float,
		oil1 float,--修正用
		oil2 float--修正用
	)
	insert into @tmp2(carno,oil)
	select carno,SUM(ISNULL([money],0)) [money] 
	from oil 
	where left(datea,6)between left(@t_btrandate,6) and left(@t_etrandate,6) and ISNULL([money],0)!=0
	group by carno
	
	update #z_tmp_ds set oil=case when b.total=0 then 0 else round(a.total/b.total*c.oil,0) end
	from #z_tmp_ds a
	right join (select carno,SUM(total) total from #z_tmp_ds where isnull(total,0)>0 group by carno) b on a.carno=b.carno
	right join @tmp2 c on a.carno=c.carno
	where isnull(a.total,0)>0
	--==修正金額
	update @tmp2 set oil1=b.mm1
	from @tmp2 a
	right join (select carno,SUM(ISNULL(oil,0)) mm1 from #z_tmp_ds group by carno) b on a.carno=b.carno
	
	update @tmp2 set oil2= ISNULL(oil,0)-ISNULL(oil1,0)	
	delete @tmp2 where ISNULL(oil2,0)=0 
	--==在平均分攤金額再加總時,多少會有誤差,因此依money1一次補1調整,LOOP 直到沒誤差
	update #z_tmp_ds set oil = a.oil + case when d.oil2<0 then -1 else 1 end * (floor(ABS(d.oil2)/c.nn)+case when (cast(ABS(d.oil2) as int)%c.nn)>=b.recno then 1 else 0 end)
	from #z_tmp_ds a
	right join(select ROW_NUMBER()over(partition by carno order by total) recno
		,tranno,trannoq from #z_tmp_ds where total!=0) b on a.tranno=b.tranno and a.trannoq=b.trannoq
	right join(select carno,COUNT(1) nn from #z_tmp_ds where total!=0 group by carno) c on a.carno=c.carno
	right join @tmp2 d on a.carno=d.carno	
	--==無出車單的另外寫入
	update @tmp2 set oil1=b.mm1
	from @tmp2 a
	right join (select carno,SUM(ISNULL(oil,0)) mm1 from #z_tmp_ds group by carno) b on a.carno=b.carno
	update @tmp2 set oil2= ISNULL(oil,0)-ISNULL(oil1,0)	
	delete @tmp2 where ISNULL(oil2,0)=0 
	insert into #z_tmp_ds(carteamno,custno,carno,oil)
	select 'zzzzz##','zzzzz##',carno,oil2 from @tmp2
	
	declare @tmp5 table(
		carno nvarchar(20),
		driverno nvarchar(20),
		datea nvarchar(10),
		etc float,
		etc1 float,--修正用
		etc2 float--修正用
	)
	insert into @tmp5(carno,driverno,datea,etc)
	select carno,driverno,datea,SUM(ISNULL([money],0)) [money] 
	from etc
	where left(datea,6)between left(@t_btrandate,6) and left(@t_etrandate,6) and ISNULL([money],0)!=0
	and (typea='ETC' or typea='CASH')
	group by carno,driverno,datea
	
	update #z_tmp_ds set etc=case when b.total=0 then 0 else round(a.total/b.total*c.etc,0) end
	from #z_tmp_ds a
	right join (select carno,driverno,SUM(total) total from #z_tmp_ds where isnull(total,0)>0 group by carno,driverno) b on a.carno=b.carno and a.driverno=b.driverno
	right join @tmp5 c on a.carno=c.carno and a.driverno=c.driverno and a.trandate=c.datea
	where isnull(a.total,0)>0

	----==修正金額
	update @tmp5 set etc1=b.mm1
	from @tmp5 a
	right join (select carno,driverno,trandate,SUM(ISNULL(etc,0)) mm1 from #z_tmp_ds group by carno,driverno,trandate) b on a.carno=b.carno and a.driverno=b.driverno and a.datea=b.trandate
	update @tmp5 set etc2= ISNULL(etc,0)-ISNULL(etc1,0)	
	delete @tmp5 where ISNULL(etc2,0)=0 
	--==在平均分攤金額再加總時,多少會有誤差,因此依money1一次補1調整,LOOP 直到沒誤差
	update #z_tmp_ds set etc = a.etc + case when d.etc2<0 then -1 else 1 end * (floor(ABS(d.etc2)/c.nn)+case when (cast(ABS(d.etc2) as int)%c.nn)>=b.recno then 1 else 0 end)
	from #z_tmp_ds a
	right join(select ROW_NUMBER()over(partition by carno,trandate order by total) recno
		,tranno,trannoq from #z_tmp_ds where total!=0) b on a.tranno=b.tranno and a.trannoq=b.trannoq
	right join(select carno,driverno,trandate,COUNT(1) nn from #z_tmp_ds where total!=0 group by carno,driverno,trandate) c on a.carno=c.carno and a.driverno=c.driverno and a.trandate=c.trandate
	right join @tmp5 d on a.carno=d.carno and a.driverno=d.driverno and a.trandate=d.datea	
	--==無出車單的另外寫入
	update @tmp5 set etc1=b.mm1
	from @tmp5 a
	right join (select carno,driverno,trandate,SUM(ISNULL(etc,0)) mm1 from #z_tmp_ds group by carno,driverno,trandate) b on a.carno=b.carno and a.driverno=b.driverno and a.datea=b.trandate
	update @tmp5 set etc2= ISNULL(etc,0)-ISNULL(etc1,0)	
	delete @tmp5 where ISNULL(etc2,0)=0 
	insert into #z_tmp_ds(carteamno,custno,carno,driverno,trandate,etc)
	select 'zzzzz##','zzzzz##',carno,driverno,datea,etc2 from @tmp5
	--declare @tmp06 table(
	--	datea nvarchar(10),
	--	carno nvarchar(20),
	--	oil float,
	--	etc float,
	--	caroil float,
	--	caretc float
	--)
	--insert into @tmp06(datea,carno,oil,etc)
	--select a.datea,a.carno,SUM(a.oil),SUM(a.etc)
	--from
	--	(select a.datea,isnull(a.carno,'') carno,SUM(ISNULL(a.[money],0)) oil,0  etc
	--	from oil a
	--	where left(a.datea,6) between left(@t_btrandate,6) and left(@t_etrandate,6)
	--	group by a.datea,isnull(a.carno,'')
	--	union all
	--	select a.datea,isnull(a.carno,''),0,SUM(ISNULL(a.[money],0))
	--	from etc a
	--	where (typea='ETC' or typea='CASH')
	--	and left(a.datea,6) between left(@t_btrandate,6) and left(@t_etrandate,6)
	--	group by a.datea,isnull(a.carno,'')) a
	--group by a.datea,a.carno
	----收金額合計
	--declare @tmp06_a table(
	--	datea nvarchar(10),
	--	carno nvarchar(20),
	--	total float
	--)
	--insert into @tmp06_a(datea,carno,total)
	--select a.trandate,isnull(a.carno,''),SUM(ISNULL(total,0)) 
	--from #z_tmp_ds a
	--group by a.trandate,isnull(a.carno,'')
	----依收金額比例分配加減項金額
	--update #z_tmp_ds
	--set oil = case when ISNULL(c.total,0)=0 then 0 else round(isnull(a.total,0)*ISNULL(b.oil,0)/ISNULL(c.total,0),0)end
	--	,etc = case when ISNULL(c.total,0)=0 then 0 else round(isnull(a.total,0)*ISNULL(b.etc,0)/ISNULL(c.total,0),0)end
	--from #z_tmp_ds a
	--inner join @tmp06 b on a.trandate=b.datea and a.carno = b.carno
	--inner join @tmp06_a c on a.trandate=c.datea and a.carno = c.carno
	----檢查有加油或ETC,但當天無收金額的
	--insert into #z_tmp_ds(carteamno,custno,trandate,carno,oil,etc,addr)
	--select 'zzzzz##','zzzzz##',a.datea,a.carno,a.oil,a.etc,'當日無出車'
	--from @tmp06 a
	--left join @tmp06_a b on a.datea=b.datea and a.carno=b.carno
	--where isnull(b.total,0)=0 and (isnull(a.oil,0)!=0 or isnull(a.etc,0)!=0)
	------修正誤差,由收入最高的依序補回一次補1,LOOP
	--update @tmp06
	--set caroil = ISNULL(b.oil,0)
	--	,caretc = ISNULL(b.etc,0)
	--from @tmp06 a
	--inner join (select ISNULL(trandate,'') datea
	--	,ISNULL(carno,'') carno
	--	,SUM(ISNULL(oil,0)) oil
	--	,SUM(ISNULL(etc,0)) etc
	--	from #z_tmp_ds 
	--	group by ISNULL(trandate,''),ISNULL(carno,'')) b on a.datea=b.datea and a.carno=b.carno
	
	----修正誤差用
	--declare @ztmp06 table(
	--	recno int,
	--	carno nvarchar(20),
	--	datea nvarchar(10),
	--	tranno nvarchar(20),
	--	trannoq nvarchar(10),
	--	oil float,
	--	etc float
	--	UNIQUE (recno,carno,datea)
	--)
	--insert into @ztmp06(recno,carno,datea,tranno,trannoq,oil,etc)
	--select ROW_NUMBER()over(partition by isnull(carno,''),isnull(trandate,'') order by isnull(total,0) desc,tranno,trannoq) 
	--,isnull(carno,''),isnull(trandate,''),tranno,trannoq,isnull(oil,0),isnull(etc,0)
	--from #z_tmp_ds
	
	--declare cursor_table cursor for
	--select datea,carno,caroil-oil,caretc - etc from @tmp06
	--open cursor_table
	--fetch next from cursor_table
	--into @datea,@carno,@oil,@etc
	--while(@@FETCH_STATUS <> -1)
	--begin		
	--	select @n = 1,@curoil=@oil,@curetc=@etc
	--	while(@curoil!=0 or @curetc!=0)
	--	begin		
	--		if not exists(select tranno from @ztmp06 where carno=@carno and datea=@datea and recno=@n)
	--		begin
	--			if((@curoil=@oil and @oil!=0) or (@curetc=@etc and @etc!=0))
	--			begin
	--				--避免LOOP
	--				select '資料異常 @ztmp01 01',@carno,@datea,@n
	--				return
	--			return
	--			end
	--			set @n = 1
	--		end
	--		select @tranno=tranno,@trannoq=trannoq,@caroil=oil,@caretc=etc 
	--		from @ztmp06 where carno=@carno and datea=@datea and recno=@n
	--		if(@tranno is null)
	--		begin
	--			select '資料異常 @ztmp01 02',@carno,@datea,@n
	--			return
	--		end
	--		select @diffoil=0,@diffetc=0 
	--		if(@caroil!=0)
	--		begin
	--			set @diffoil = case when @curoil>0 then -1 when @curoil<0 then 1 else 0 end
	--			set @curoil = @curoil + @diffoil
	--		end
	--		if(@caretc!=0)
	--		begin
	--			set @diffetc = case when @curetc>0 then -1 when @curetc<0 then 1 else 0 end
	--			set @curetc = @curetc + @diffetc
	--		end			
	--		update #z_tmp_ds set oil=isnull(oil,0)+@diffoil
	--		,etc=isnull(etc,0)+@diffetc
	--		where tranno=@tranno and trannoq=@trannoq
			
	--		set @n = @n + 1
	--	end
	--	fetch next from cursor_table
	--	into @datea,@carno,@oil,@etc
	--end
	--close cursor_table
	--deallocate cursor_table
	----------------------------------------------------------------------------------------------
	update #z_tmp_ds set profit = isnull(total,0)-isnull(total2,0)-isnull(reserve,0)-isnull(tolls,0)
		+isnull(custplus,0)-isnull(custminus,0)-isnull(carplus,0)+isnull(carminus,0)-isnull(oil,0)-isnull(etc,0)
		-isnull(fixa,0)-isnull(tire,0)-isnull(item,0)-isnull(other,0)
	
	delete #z_tmp_ds
	from #z_tmp_ds a
	left join #carteam b on a.carteamno = b.noa
	left join #calctype c on a.calctype = c.noa
	where  not((a.carteamno='zzzzz##') or (a.custno='zzzzz##'))
	and((b.noa is null and len(isnull(a.carteamno,''))>0)
	or (c.noa is null and len(isnull(a.calctype,''))>0)
	or not(a.trandate between @t_btrandate and @t_etrandate)
	or not(a.custno between @t_bcustno and @t_ecustno)
	or not(a.addrno between @t_baddrno and @t_eaddrno)
	or not(a.driverno between @t_bdriverno and @t_edriverno))

	if(LEN(@t_carno)>0)
	begin
		delete #z_tmp_ds
		from #z_tmp_ds a
		left join #carno b on a.carno = b.noa
		where b.noa is null 
	end
	if(LEN(@t_po)>0)
	begin
		delete #z_tmp_ds
		from #z_tmp_ds a
		left join #po b on a.po = b.noa
		where b.noa is null 
	end
	----------------------------------------------------------------------------------------------	
	declare @tmp table(
		page int,
		nn int,
		gno nvarchar(10),
		recno int,
		custno nvarchar(20),
		nick nvarchar(20),
		cardealno nvarchar(20),
		cardeal nvarchar(20),
		carteamno nvarchar(20),
		carteam nvarchar(20),
		trandate nvarchar(10),
		addrno nvarchar(20),
		addr nvarchar(40),
		carno nvarchar(20),
		driver nvarchar(20),
		total float,
		total2 float,
		reserve float,
		tolls float,
		custplus float,
		custminus float,
		carplus float,
		carminus float,
		oil float,
		etc float,
		fixa float,
		tire float,
		item float,
		other float,
		profit float,
		miles float
	)
	--------------------------------------------------------------------------------------------
	declare @rowline int -- 每頁可用行數
	declare @endline int -- 頁尾行數
	declare @page int
	declare @recno int
	declare @curline int -- 當前行數
	set @rowline = 31
	set @endline = 1
	set @page=0
	set @curline = 0

	declare @tot int
	update #z_tmp_ds set cardealno = case when len(isnull(cardealno,''))=0  then 'yyyyy##' else cardealno end
	
	declare cursor_table cursor for
	select a.cardealno,a.cardeal,COUNT(1)
	from #z_tmp_ds a
	group by a.cardealno,a.cardeal
	order by a.cardealno
	open cursor_table
	fetch next from cursor_table
	into @cardealno,@cardeal,@tot
	while(@@FETCH_STATUS <> -1)
	begin		
		--小計
		select @total=sum(isnull(total,0)),@total2=sum(isnull(total2,0))
			,@reserve=sum(isnull(reserve,0)),@tolls=sum(isnull(tolls,0))
			,@custplus=sum(isnull(custplus,0)),@custminus=sum(isnull(custminus,0))
			,@carplus=sum(isnull(carplus,0)),@carminus=sum(isnull(carminus,0))
			,@oil=sum(isnull(oil,0)),@etc=sum(isnull(etc,0))
			,@fixa=sum(isnull(fixa,0)),@tire=sum(isnull(tire,0))
			,@item=sum(isnull(item,0))
			,@other=sum(isnull(other,0))
			,@profit=sum(isnull(profit,0))
			,@miles=sum(isnull(miles,0))
		from #z_tmp_ds where cardealno=@cardealno
		select @gno = case when @profit<=0 then '3' else '2' end
		
		if(@t_option08!='detail')
		begin
			if(@curline%@rowline=0)
			begin	
				insert into @tmp(page,nn,gno,cardealno,cardeal)
				select @page,@curline%@rowline,'1',@cardealno,@cardeal
				set @curline = @curline + 1
			end		
			insert into @tmp(page,nn,gno,cardealno,cardeal
				,total,total2,reserve,tolls,custplus,custminus,carplus,carminus
				,oil,etc,fixa,tire,item,other,profit,miles)
			select @page,@curline%@rowline,@gno,@cardealno,@cardeal
				,@total,@total2,@reserve,@tolls,@custplus,@custminus,@carplus,@carminus
				,@oil,@etc,@fixa,@tire,@item,@other,@profit,@miles
			set @curline = @curline + 1
			--是否換頁
			if(@curline%@rowline=0)
			begin
				set @page = @page + 1
			end
		end
		else
		begin
			--要顯示明細
			if(@curline%@rowline>@rowline-4)--少於4行就跳到次頁
			begin
				while(1=1)
				begin
					insert into @tmp(page,nn,gno,cardealno,cardeal)
					select @page,@curline%@rowline,'0',@cardealno,@cardeal
					set @curline = @curline + 1
					if(@curline%@rowline=0)
						break
				end
				set @page = @page + 1
			end
			--G.1
			insert into @tmp(page,nn,gno,cardealno,cardeal)
			select @page,@curline%@rowline,'1',@cardealno,@cardeal
			set @curline = @curline + 1
			
			insert into @tmp(page,nn,gno,cardealno,cardeal
				,total,total2,reserve,tolls,custplus,custminus,carplus,carminus
				,oil,etc,fixa,tire,item,other,profit,miles)
			select @page,@curline%@rowline,@gno,@cardealno,@cardeal
				,@total,@total2,@reserve,@tolls,@custplus,@custminus,@carplus,@carminus
				,@oil,@etc,@fixa,@tire,@item,@other,@profit,@miles
			set @curline = @curline + 1
			--是否換頁
			if(@curline%@rowline=0)
			begin	
				set @page = @page + 1
			end
			--明細	
			set @n=0
			set @recno = 1
			declare cursor_table2 cursor for
			select total,total2,reserve,tolls,custplus,custminus,carplus,carminus,oil,etc
				,fixa,tire,item,other,profit,trandate,carno,driver,addrno,addr,miles
			from #z_tmp_ds where cardealno=@cardealno
			order by trandate,carno,driver
			open cursor_table2
			fetch next from cursor_table2
			into @total,@total2,@reserve,@tolls,@custplus,@custminus,@carplus,@carminus,@oil,@etc
				,@fixa,@tire,@item,@other,@profit,@trandate,@carno,@driver,@addrno,@addr,@miles
			while(@@FETCH_STATUS <> -1)
			begin
				set @n = @n + 1
				if(@recno=1)
				begin
					insert into @tmp(page,nn,gno,cardealno,cardeal)
					select @page,@curline%@rowline,'4',@cardealno,@cardeal
					set @curline = @curline + 1	
				end
				else
				begin
					if(@curline%@rowline=0)
					begin	
						insert into @tmp(page,nn,gno,cardealno,cardeal)
						select @page,@curline%@rowline,'5',@cardealno,@cardeal
						set @curline = @curline + 1	
					end
				end
				if(@curline%@rowline=@rowline-1 or @tot=@n)
					select @gno = case when @profit<=0 then '9' else '8' end
				else
					select @gno = case when @profit<=0 then '7' else '6' end
				insert into @tmp(page,nn,gno,recno,cardealno,cardeal
					,total,total2,reserve,tolls,custplus,custminus,carplus,carminus,oil,etc
					,fixa,tire,item,other,profit,trandate,carno,driver,addrno,addr,miles)
				select @page,@curline%@rowline,@gno,@recno,@cardealno,@cardeal
					,@total,@total2,@reserve,@tolls,@custplus,@custminus,@carplus,@carminus,@oil,@etc
					,@fixa,@tire,@item,@other,@profit,@trandate,@carno,@driver,@addrno,@addr,@miles
				set @curline = @curline + 1
				--是否換頁
				if(@curline%@rowline=0)
				begin	
					set @page = @page + 1
				end
				set @recno = @recno +1
				fetch next from cursor_table2
				into @total,@total2,@reserve,@tolls,@custplus,@custminus,@carplus,@carminus,@oil,@etc
				,@fixa,@tire,@item,@other,@profit,@trandate,@carno,@driver,@addrno,@addr,@miles
			end
			close cursor_table2
			deallocate cursor_table2
		end
		fetch next from cursor_table
		into @cardealno,@cardeal,@tot
	end
	close cursor_table
	deallocate cursor_table	
	
	--總計
	select @total=sum(isnull(total,0)),@total2=sum(isnull(total2,0))
		,@reserve=sum(isnull(reserve,0)),@tolls=sum(isnull(tolls,0))
		,@custplus=sum(isnull(custplus,0)),@custminus=sum(isnull(custminus,0))
		,@carplus=sum(isnull(carplus,0)),@carminus=sum(isnull(carminus,0))
		,@oil=sum(isnull(oil,0)),@etc=sum(isnull(etc,0))
		,@fixa=sum(isnull(fixa,0)),@tire=sum(isnull(tire,0))
		,@item=sum(isnull(item,0))
		,@other=sum(isnull(other,0))
		,@profit=sum(isnull(profit,0))
		,@miles=sum(isnull(miles,0))
	from #z_tmp_ds
	insert into @tmp(page,nn,gno,cardealno
		,total,total2,reserve,tolls,custplus,custminus,carplus,carminus
		,oil,etc,fixa,tire,item,other,profit,miles)
	select @page,@curline%@rowline,'10',CHAR(255)
		,@total,@total2,@reserve,@tolls,@custplus,@custminus,@carplus,@carminus
		,@oil,@etc,@fixa,@tire,@item,@other,@profit,@miles
				
	select a.* 
	,a.cardeal g00
	,a.recno g01
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.total),1)),4,12)) g02
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.custplus),1)),4,12)) g03
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.custminus),1)),4,12)) g04
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.total2),1)),4,12)) g05
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.carplus),1)),4,12)) g06
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.carminus),1)),4,12)) g07
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.reserve),1)),4,12)) g08
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.tolls),1)),4,12)) g09
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.oil),1)),4,12)) g10
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.etc),1)),4,12)) g11
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.fixa),1)),4,12)) g12
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.tire),1)),4,12)) g13
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.item),1)),4,12)) g14
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.profit),1)),4,12)) g15
	,a.trandate g16
	,a.carno g17
	,a.driver g18
	,a.addr g19
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.other),1)),4,12)) g20
	from @tmp a
	order by a.cardealno,page,nn;

z_tran_ds08:--z_tran_ds08
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_baddrno nvarchar(20)
	declare @t_eaddrno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(max)
	declare @t_po nvarchar(max)
	declare @t_calctype nvarchar(max)
	declare @t_carteam nvarchar(max)
	declare @t_option08 nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_btrandate = case when '#non'=[5] then '' else [5] end
	set @t_etrandate = case when '#non'=[6] then CHAR(255) else [6] end
	set @t_bcustno = case when '#non'=[7] then '' else [7] end
	set @t_ecustno = case when '#non'=[8] then CHAR(255) else [8] end
	set @t_baddrno = case when '#non'=[9] then '' else [9] end
	set @t_eaddrno = case when '#non'=[10] then CHAR(255) else [10] end
	set @t_bdriverno = case when '#non'=[11] then '' else [11] end
	set @t_edriverno = case when '#non'=[12] then CHAR(255) else [12] end
	set @t_carno = case when '#non'=[13] then '' else [13] end
	set @t_po = case when '#non'=[14] then '' else [14] end
	set @t_carteam = case when '#non'=[16] then '' else [16] end
	set @t_calctype = case when '#non'=[17] then '' else [17] end
	set @t_option08 = case when '#non'=[29] then '' else [29] end
	----------------------------------------------------------------------------------------------
	declare @string nvarchar(max)
	declare @n int
	--解析要計算的種類
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(20)
	)
	set @string = @t_carteam
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#carno')is not null
	BEGIN
		set @cmd = 'drop table #carno'
		EXECUTE sp_executesql @cmd
	END
	create table #carno(
		noa nvarchar(20)
	)
	set @string = @t_carno
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carno select @string
			end
			break
		end
		insert into #carno select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#po')is not null
	BEGIN
		set @cmd = 'drop table #po'
		EXECUTE sp_executesql @cmd
	END
	create table #po(
		noa nvarchar(20)
	)
	set @string = @t_po
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #po select @string
			end
			break
		end
		insert into #po select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(20)
	)
	set @string = @t_calctype
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	----------------------------------------------------------------------------------------------
	declare @mon nvarchar(10)
	declare @datea nvarchar(10)
	declare @custno nvarchar(20)
	declare @nick nvarchar(20)
	declare @carno nvarchar(20)
	declare @driverno nvarchar(20)
	declare @plus float
	declare @minus float
	declare @curplus float
	declare @curminus float
	declare @custplus float
	declare @custminus float
	declare @carplus float
	declare @carminus float
	declare @diffplus float
	declare @diffminus float
	declare @tranno nvarchar(20)
	declare @trannoq nvarchar(10)
	
	declare @fixa float
	declare @tire float
	declare @item float
	declare @other float
	declare @curfixa float
	declare @curtire float
	declare @curitem float
	declare @curother float
	declare @carfixa float
	declare @cartire float
	declare @caritem float
	declare @carother float
	declare @difffixa float
	declare @difftire float
	declare @diffitem float
	declare @diffother float
	
	declare @oil float
	declare @etc float
	declare @curoil float
	declare @curetc float
	declare @caroil float
	declare @caretc float
	declare @diffoil float
	declare @diffetc float
	
	declare @carteamno nvarchar(20)
	declare @carteam nvarchar(20)
	declare @trandate nvarchar(10)
	declare @addrno nvarchar(20)
	declare @addr nvarchar(40)
	--declare @carno nvarchar(20)
	declare @driver nvarchar(20)
	declare @total float
	declare @total2 float
	declare @reserve float
	declare @tolls float
	--declare @custplus float
	--declare @custminus float
	--declare @carplus float
	--declare @carminus float
	--declare @fixa float
	--declare @tire float
	--declare @ticket float
	--declare @bonus float
	--declare @tax float
	--declare @depreciation float
	declare @profit float
	declare @gno nvarchar(10)
	declare @miles float
	----------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_tmp_ds')is not null
	BEGIN
		set @cmd = 'drop table #z_tmp_ds'
		EXECUTE sp_executesql @cmd
	END
	create table #z_tmp_ds(
		isoutside int,
		tranno nvarchar(20),
		trannoq nvarchar(10),
		datea nvarchar(10),
		trandate nvarchar(10),
		carteamno nvarchar(20),
		carteam nvarchar(20),
		calctype nvarchar(20),
		
		custno nvarchar(20),
		custnick nvarchar(20),
		addrno nvarchar(20),
		addr nvarchar(40),
		cardealno nvarchar(20),
		cardeal nvarchar(40),
		
		carno nvarchar(20),
		driverno nvarchar(20),
		driver nvarchar(20),
		miles float,
		po nvarchar(max),
		
		mount float,
		price float,
		total float,
		
		mount2 float,
		price2 float,
		price3 float,
		discount float,
		total2 float,
		
		reserve float,
		tolls float,
		memo nvarchar(max),
		
		custplus float,
		custminus float,
		
		carplus float,
		carminus float,
		oil float,
		etc float,
		fixa float,
		tire float,
		item float, 
		other float,	
		profit float
	)
	set @cmd = 
	" select isnull(c.isoutside,0),a.noa,a.noq,a.datea,a.trandate,isnull(a.carteamno,''),b.team,a.calctype"+
	" ,isnull(a.custno,''),a.nick,a.straddrno,a.straddr"+
	" ,a.carno,a.driverno,a.driver,isnull(a.miles,0),a.po"+
	" ,a.mount,a.price,a.total"+
	" ,a.mount2,a.price2,a.price3,a.discount,a.total2"+
	" ,a.reserve,a.tolls,a.memo"+
	" from view_trans a"+
	" left join carteam b on a.carteamno = b.noa"+
	" left join calctypes c on a.calctype = c.noa+c.noq"+
	" where (left(a.trandate,6) between left(@t_btrandate,6) and left(@t_etrandate,6))"
	
	create index tranno on #z_tmp_ds(tranno,trannoq)
	insert into #z_tmp_ds(isoutside,tranno,trannoq,datea,trandate,carteamno,carteam,calctype
		,custno,custnick,addrno,addr
		,carno,driverno,driver,miles,po
		,mount,price,total
		,mount2,price2,price3,discount,total2
		,reserve,tolls,memo
	)
	execute sp_executesql @cmd,N'@t_btrandate nvarchar(10),@t_etrandate nvarchar(10)'
	,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate
	----------------------------------------------------------------------------------------------
	--客戶加減項
	declare @tmp01 table(
		mon nvarchar(10),
		custno nvarchar(20),
		plus float,
		minus float,
		custplus float,
		custminus float
	)
	insert into @tmp01(mon,custno,plus,minus)
	select LEFT(a.datea,6),isnull(a.custno,''),SUM(ISNULL(plusmoney,0)),SUM(ISNULL(minusmoney,0)) 
	from custchg a
	--排除 代收、付,暫收
	where (left(a.acc1,4)!='2195') and (left(a.acc1,4)!='1191') 
	and (left(a.acc1,4)!='2191') and (left(a.acc1,4)!='1149') 
	and (left(a.acc1,4)!='1194') and (left(a.acc1,4)!='1129') 
	and (left(a.acc1,4)!='4201') and (left(a.acc1,4)!='4202') 
	and left(a.datea,6) between left(@t_btrandate,6) and left(@t_etrandate,6)
	group by LEFT(a.datea,6),isnull(a.custno,'')
	--收金額合計
	declare @tmp01_a table(
		mon nvarchar(10),
		custno nvarchar(20),
		total float
	)
	insert into @tmp01_a(mon,custno,total)
	select LEFT(a.trandate,6),isnull(a.custno,''),SUM(ISNULL(total,0)) 
	from #z_tmp_ds a
	group by LEFT(a.trandate,6),isnull(a.custno,'') 
	--依收金額比例分配加減項金額
	update #z_tmp_ds
	set custplus = case when ISNULL(c.total,0)=0 then 0 else round(isnull(a.total,0)*ISNULL(b.plus,0)/ISNULL(c.total,0),0)end
		,custminus = case when ISNULL(c.total,0)=0 then 0 else round(isnull(a.total,0)*ISNULL(b.minus,0)/ISNULL(c.total,0),0)end
	from #z_tmp_ds a
	inner join @tmp01 b on left(a.trandate,6)=b.mon and a.custno = b.custno 
	inner join @tmp01_a c on left(a.trandate,6)=c.mon and a.custno = c.custno 
	--檢查有客戶加減項,但當月無收金額的
	insert into #z_tmp_ds(carteamno,custno,trandate,custplus,custminus,addr)
	select 'zzzzz##',a.custno,a.mon,a.plus,a.minus,c.nick+'當月無出車'
	from @tmp01 a
	left join @tmp01_a b on a.mon=b.mon and a.custno=b.custno
	left join cust c on a.custno=c.noa
	where isnull(b.total,0)=0 and (isnull(a.plus,0)!=0 or isnull(a.minus,0)!=0)
	----修正誤差,由收入最高的依序補回一次補1,LOOP
	update @tmp01
	set custplus = ISNULL(b.custplus,0)
		,custminus = ISNULL(b.custminus,0)
	from @tmp01 a
	inner join (select LEFT(ISNULL(trandate,''),6) mon
		,ISNULL(custno,'') custno
		, SUM(ISNULL(custplus,0)) custplus
		,SUM(ISNULL(custminus,0)) custminus 
		from #z_tmp_ds 
		group by LEFT(ISNULL(trandate,''),6),ISNULL(custno,'')) b on a.mon=b.mon and a.custno=b.custno
	
	--修正誤差用
	declare @ztmp01 table(
		recno int,
		custno nvarchar(20),
		mon nvarchar(10),
		tranno nvarchar(20),
		trannoq nvarchar(10),
		custplus float,
		custminus float
		UNIQUE (recno,custno,mon)
	)
	insert into @ztmp01(recno,custno,mon,tranno,trannoq,custplus,custminus)
	select ROW_NUMBER()over(partition by isnull(custno,''),LEFT(isnull(trandate,''),6) order by isnull(total,0) desc,tranno,trannoq) 
	,isnull(custno,''),LEFT(isnull(trandate,''),6),tranno,trannoq,isnull(custplus,0),isnull(custminus,0)
	from #z_tmp_ds
	
	declare cursor_table cursor for
	select mon,custno,custplus-plus,custminus - minus from @tmp01 
	open cursor_table
	fetch next from cursor_table
	into @mon,@custno,@plus,@minus
	while(@@FETCH_STATUS <> -1)
	begin		
		select @n = 1,@curplus=@plus,@curminus=@minus
		while(@curplus!=0 or @curminus!=0)
		begin		
			if not exists(select tranno from @ztmp01 where custno=@custno and @mon=mon and recno=@n)
			begin
				if((@curplus=@plus and @plus!=0) or (@curminus=@minus and @minus!=0))
				begin
					--找第一筆
					if exists(select tranno from @ztmp01 where custno=@custno and @mon=mon and recno=1)
					begin
						select @tranno=tranno,@trannoq=trannoq,@custplus=custplus,@custminus=custminus 
						from @ztmp01 where custno=@custno and @mon=mon and recno=1
						
						update #z_tmp_ds set custplus=isnull(custplus,0)-@custplus
						,custminus=isnull(custminus,0)-@custminus
						where tranno=@tranno and trannoq=@trannoq
						break
					end
					else
					begin
					----避免LOOP
					select '資料異常 @ztmp01 01',@custno,@mon,@n
					return
					end
				return
				end
				set @n = 1
			end
			select @tranno=tranno,@trannoq=trannoq,@custplus=custplus,@custminus=custminus 
			from @ztmp01 where custno=@custno and @mon=mon and recno=@n
			if(@tranno is null)
			begin
				select '資料異常 @ztmp01 02',@custno,@mon,@n
				return
			end
			select @diffplus=0,@diffminus=0 
			if(@custplus!=0)
			begin
				set @diffplus = case when @curplus>0 then -1 when @curplus<0 then 1 else 0 end
				set @curplus = @curplus + @diffplus
			end
			if(@custminus!=0)
			begin
				set @diffminus = case when @curminus>0 then -1 when @curminus<0 then 1 else 0 end
				set @curminus = @curminus + @diffminus
			end			
			update #z_tmp_ds set custplus=isnull(custplus,0)+@diffplus
			,custminus=isnull(custminus,0)+@diffminus 
			where tranno=@tranno and trannoq=@trannoq
			
			set @n = @n + 1
		end
		fetch next from cursor_table
		into @mon,@custno,@plus,@minus
	end
	close cursor_table
	deallocate cursor_table
	----------------------------------------------------------------------------------------------
	--司機加減項
	declare @tmp02 table(
		mon nvarchar(10),
		carno nvarchar(20),
		driverno nvarchar(20),
		plus float,
		minus float,
		carplus float,
		carminus float
	)
	insert into @tmp02(mon,carno,driverno,plus,minus)
	select LEFT(a.datea,6),isnull(a.carno,''),isnull(a.driverno,''),SUM(ISNULL(plusmoney,0)),SUM(ISNULL(minusmoney,0)) 
	from carchg a
	--排除 代收、付,暫收
	--where (left(a.acc1,4)!='2195') and (left(a.acc1,4)!='1191') 
	--and (left(a.acc1,4)!='2191') and (left(a.acc1,4)!='1149') 
	--and (left(a.acc1,4)!='1194') and (left(a.acc1,4)!='1129') 
	--and (left(a.acc1,4)!='4201') and (left(a.acc1,4)!='4202') 
	--有付款廠商的就判斷為代收、代付
	where len(isnull(a.tggno,''))=0
	and left(a.datea,6) between left(@t_btrandate,6) and left(@t_etrandate,6)
	--借支排除
	and charindex('借支',a.minusitem)=0
	group by LEFT(a.datea,6),isnull(a.carno,''),isnull(a.driverno,'')
	--發金額合計
	declare @tmp02_a table(
		mon nvarchar(10),
		carno nvarchar(20),
		driverno nvarchar(20),
		total2 float
	)
	insert into @tmp02_a(mon,carno,driverno,total2)
	select LEFT(a.trandate,6),isnull(a.carno,''),isnull(a.driverno,''),SUM(ISNULL(total2,0)) 
	from #z_tmp_ds a
	group by LEFT(a.trandate,6),isnull(a.carno,''),isnull(a.driverno,'')
	--依發金額比例分配加減項金額
	update #z_tmp_ds
	set carplus = case when ISNULL(c.total2,0)=0 then 0 else round(isnull(a.total2,0)*ISNULL(b.plus,0)/ISNULL(c.total2,0),0)end
		,carminus = case when ISNULL(c.total2,0)=0 then 0 else round(isnull(a.total2,0)*ISNULL(b.minus,0)/ISNULL(c.total2,0),0)end
	from #z_tmp_ds a
	inner join @tmp02 b on left(a.trandate,6)=b.mon and a.carno=b.carno and a.driverno=b.driverno 
	inner join @tmp02_a c on left(a.trandate,6)=c.mon and a.carno=c.carno and a.driverno=c.driverno 
	--檢查有司機加減項,但當月無發金額的
	insert into #z_tmp_ds(carteamno,custno,trandate,carno,driverno,driver,carplus,carminus,addr)
	select 'zzzzz##','zzzzz##',a.mon,a.carno,a.driverno,c.namea,a.plus,a.minus,'當月無出車'
	from @tmp02 a
	left join @tmp02_a b on a.mon=b.mon and a.carno=b.carno and a.driverno=b.driverno
	left join driver c on a.driverno=c.noa
	where isnull(b.total2,0)=0 and (isnull(a.plus,0)!=0 or isnull(a.minus,0)!=0)
	----修正誤差,由發金額最高的依序補回一次補1,LOOP
	update @tmp02
	set carplus = ISNULL(b.carplus,0)
		,carminus = ISNULL(b.carminus,0)
	from @tmp02 a
	inner join (select LEFT(ISNULL(trandate,''),6) mon
		,ISNULL(carno,'') carno
		,ISNULL(driverno,'') driverno
		, SUM(ISNULL(carplus,0)) carplus
		,SUM(ISNULL(carminus,0)) carminus 
		from #z_tmp_ds 
		group by LEFT(ISNULL(trandate,''),6),ISNULL(carno,''),ISNULL(driverno,'')) b 
	on a.mon=b.mon and a.carno=b.carno and a.driverno=b.driverno 
	
	--修正誤差用
	declare @ztmp02 table(
		recno int,
		carno nvarchar(20),
		driverno nvarchar(20),
		mon nvarchar(10),
		tranno nvarchar(20),
		trannoq nvarchar(10),
		carplus float,
		carminus float
		UNIQUE (recno,carno,driverno,mon)
	)
	insert into @ztmp02(recno,carno,driverno,mon,tranno,trannoq,carplus,carminus)
	select ROW_NUMBER()over(partition by isnull(carno,''),isnull(driverno,''),LEFT(isnull(trandate,''),6) order by isnull(total2,0) desc,tranno,trannoq) 
	,isnull(carno,''),isnull(driverno,''),LEFT(isnull(trandate,''),6),tranno,trannoq,isnull(carplus,0),isnull(carminus,0)
	from #z_tmp_ds
	
	declare cursor_table cursor for
	select mon,carno,driverno,carplus-plus,carminus - minus from @tmp02
	open cursor_table
	fetch next from cursor_table
	into @mon,@carno,@driverno,@plus,@minus
	while(@@FETCH_STATUS <> -1)
	begin		
		select @n = 1,@curplus=@plus,@curminus=@minus
		while(@curplus!=0 or @curminus!=0)
		begin		
			if not exists(select tranno from @ztmp02 where carno=@carno and driverno=@driverno and @mon=mon and recno=@n)
			begin
				if((@curplus=@plus and @plus!=0) or (@curminus=@minus and @minus!=0))
				begin
					--避免LOOP
					select '資料異常 @ztmp02 01',@carno,@driverno,@mon,@n,@curplus,@curminus
					return
				return
				end
				set @n = 1
			end
			select @tranno=tranno,@trannoq=trannoq,@carplus=carplus,@carminus=carminus 
			from @ztmp02 where carno=@carno and driverno=@driverno and @mon=mon and recno=@n
			if(@tranno is null)
			begin
				select '資料異常 @ztmp02 02',@carno,@driverno,@mon,@n,@curplus,@curminus
				return
			end
			select @diffplus=0,@diffminus=0 
			if(@carplus!=0)
			begin
				set @diffplus = case when @curplus>0 then -1 when @curplus<0 then 1 else 0 end
				set @curplus = @curplus + @diffplus
			end
			if(@carminus!=0)
			begin
				set @diffminus = case when @curminus>0 then -1 when @curminus<0 then 1 else 0 end
				set @curminus = @curminus + @diffminus
			end			
			update #z_tmp_ds set carplus=isnull(carplus,0)+@diffplus
			,carminus=isnull(carminus,0)+@diffminus 
			where tranno=@tranno and trannoq=@trannoq
			
			set @n = @n + 1
		end
		fetch next from cursor_table
		into @mon,@carno,@driverno,@plus,@minus
	end
	close cursor_table
	deallocate cursor_table
	----------------------------------------------------------------------------------------------
	--維修、輪胎、材料
	declare @tmp03 table(
		mon nvarchar(10),
		carno nvarchar(20),
		driverno nvarchar(20),
		fixa float,
		tire float,
		item float,
		other float,
		carfixa float,
		cartire float,
		caritem float,
		carother float
	)
	insert into @tmp03(mon,carno,driverno,fixa,tire,item,other)
	select mon,carno,driverno,round(SUM(fixa),0),round(SUM(tire),0),round(SUM(item),0),round(SUM(other),0)
	from(
		select LEFT(a.fixadate,6) mon,isnull(a.carno,'') carno,isnull(a.driverno,'') driverno
		,SUM(ISNULL(a.wmoney,0)) fixa,SUM(ISNULL(a.cmoney,0)) tire,SUM(ISNULL(a.dmoney,0)) item,SUM(ISNULL(a.emoney,0)) other
		from fixa a
		where left(a.fixadate,6) between left(@t_btrandate,6) and left(@t_etrandate,6)
		group by LEFT(a.fixadate,6),isnull(a.carno,''),isnull(a.driverno,'')
		union all
		select LEFT(a.outdate,6),isnull(a.carno,''),isnull(a.driverno,'')
		,SUM(ISNULL(a.wmoney,0)) fixa,SUM(ISNULL(a.cmoney,0)) tire,SUM(ISNULL(a.dmoney,0)) item,SUM(ISNULL(a.emoney,0)) other
		from fixout a
		where left(a.outdate,6) between left(@t_btrandate,6) and left(@t_etrandate,6)
		group by LEFT(a.outdate,6),isnull(a.carno,''),isnull(a.driverno,'')
		union all
		select LEFT(a.datea,6),isnull(a.carno,''),isnull(a.driverno,'')
		,SUM(ISNULL(a.wmoney,0)) fixa,SUM(ISNULL(a.cmoney,0)) tire,SUM(ISNULL(a.dmoney,0)) item,SUM(ISNULL(a.emoney,0)) other
		from tire a
		where left(a.datea,6) between left(@t_btrandate,6) and left(@t_etrandate,6)
		group by LEFT(a.datea,6),isnull(a.carno,''),isnull(a.driverno,'')
		)a
	group by mon,carno,driverno 
	
	--收金額合計
	declare @tmp03_a table(
		mon nvarchar(10),
		carno nvarchar(20),
		driverno nvarchar(20),
		total float
	)
	insert into @tmp03_a(mon,carno,driverno,total)
	select LEFT(a.trandate,6),isnull(a.carno,''),isnull(a.driverno,''),SUM(ISNULL(total,0)) 
	from #z_tmp_ds a
	group by LEFT(a.trandate,6),isnull(a.carno,''),isnull(a.driverno,'') 
	--依收金額比例分配維修、輪胎、材料
	update #z_tmp_ds
	set fixa = case when ISNULL(c.total,0)=0 then 0 else round(isnull(a.total,0)*ISNULL(b.fixa,0)/ISNULL(c.total,0),0)end
		,tire = case when ISNULL(c.total,0)=0 then 0 else round(isnull(a.total,0)*ISNULL(b.tire,0)/ISNULL(c.total,0),0)end
		,item = case when ISNULL(c.total,0)=0 then 0 else round(isnull(a.total,0)*ISNULL(b.item,0)/ISNULL(c.total,0),0)end
		,other = case when ISNULL(c.total,0)=0 then 0 else round(isnull(a.total,0)*ISNULL(b.other,0)/ISNULL(c.total,0),0)end
	from #z_tmp_ds a
	inner join @tmp03 b on left(a.trandate,6)=b.mon and a.carno=b.carno and a.driverno=b.driverno 
	inner join @tmp03_a c on left(a.trandate,6)=c.mon and a.carno=c.carno and a.driverno=c.driverno 
	--檢查有維修、輪胎、材料,但當月無收金額的
	insert into #z_tmp_ds(carteamno,custno,trandate,carno,driverno,driver,fixa,tire,item,other,addr)
	select 'zzzzz##','zzzzz##',a.mon,a.carno,a.driverno,c.namea,a.fixa,a.tire,a.item,a.other,'當月無出車'
	from @tmp03 a
	left join @tmp03_a b on a.mon=b.mon and a.carno=b.carno and a.driverno=b.driverno
	left join driver c on a.driverno=c.noa
	where isnull(b.total,0)=0 and (isnull(a.fixa,0)!=0 or isnull(a.tire,0)!=0 or isnull(a.item,0)!=0 or isnull(a.other,0)!=0)
	----修正誤差,由收入最高的依序補回一次補1,LOOP
	update @tmp03
	set carfixa = ISNULL(b.fixa,0)
		,cartire = ISNULL(b.tire,0)
		,caritem = ISNULL(b.item,0)
		,carother = ISNULL(b.other,0)
	from @tmp03 a
	inner join (select LEFT(ISNULL(trandate,''),6) mon
		,ISNULL(carno,'') carno
		,ISNULL(driverno,'') driverno
		,SUM(ISNULL(fixa,0)) fixa
		,SUM(ISNULL(tire,0)) tire
		,SUM(ISNULL(item,0)) item
		,SUM(ISNULL(other,0)) other
		from #z_tmp_ds 
		group by LEFT(ISNULL(trandate,''),6),ISNULL(carno,''),ISNULL(driverno,'')) b 
		on a.mon=b.mon and a.carno=b.carno and a.driverno=b.driverno
	
	--修正誤差用
	declare @ztmp03 table(
		recno int,
		carno nvarchar(20),
		driverno nvarchar(20),
		mon nvarchar(10),
		tranno nvarchar(20),
		trannoq nvarchar(10),
		fixa float,
		tire float,
		item float,
		other float
		UNIQUE (recno,carno,driverno,mon)
	)
	insert into @ztmp03(recno,carno,driverno,mon,tranno,trannoq,fixa,tire,item,other)
	select ROW_NUMBER()over(partition by isnull(carno,''),isnull(driverno,''),LEFT(isnull(trandate,''),6) order by isnull(total,0) desc,tranno,trannoq) 
	,isnull(carno,''),isnull(driverno,''),LEFT(isnull(trandate,''),6),tranno,trannoq,isnull(fixa,0),isnull(tire,0),isnull(item,0),isnull(other,0)
	from #z_tmp_ds
	
	declare cursor_table cursor for
	select mon,carno,driverno,carfixa-fixa,cartire-tire,caritem-item,carother-other from @tmp03 
	open cursor_table
	fetch next from cursor_table
	into @mon,@carno,@driverno,@fixa,@tire,@item,@other
	while(@@FETCH_STATUS <> -1)
	begin		
		select @n = 1,@curfixa=@fixa,@curtire=@tire,@curitem=@item,@curother=@other
		while(@curfixa!=0 or @curtire!=0 or @curitem!=0 or @curother!=0)
		begin		
			if not exists(select tranno from @ztmp03 where carno=@carno and driverno=@driverno and mon=@mon and recno=@n)
			begin
				if((@curfixa=@fixa and @fixa!=0) or (@curtire=@tire and @tire!=0) or (@curitem=@item and @item!=0) or (@curother=@other and @other!=0))
				begin
					--避免LOOP
					select '資料異常 @ztmp03 01',@carno,@driverno,@mon,@n
					return
				return
				end
				set @n = 1
			end
			select @tranno=tranno,@trannoq=trannoq,@carfixa=fixa,@cartire=tire,@caritem=item,@carother=other
			from @ztmp03 where carno=@carno and driverno=@driverno and mon=@mon and recno=@n
			if(@tranno is null)
			begin
				select '資料異常 @ztmp03 02',@carno,@driverno,@mon,@n
				return
			end
			select @difffixa=0,@difftire=0,@diffitem=0,@diffother=0
			if(@carfixa!=0)
			begin
				set @difffixa = case when @curfixa>0 then -1 when @curfixa<0 then 1 else 0 end
				set @curfixa = @curfixa + @difffixa
			end
			if(@cartire!=0)
			begin
				set @difftire = case when @curtire>0 then -1 when @curtire<0 then 1 else 0 end
				set @curtire = @curtire + @difftire
			end
			if(@caritem!=0)
			begin
				set @diffitem = case when @curitem>0 then -1 when @curitem<0 then 1 else 0 end
				set @curitem = @curitem + @diffitem
			end
			if(@carother!=0)
			begin
				set @diffother = case when @curother>0 then -1 when @curother<0 then 1 else 0 end
				set @curother = @curother + @diffother
			end
				
			update #z_tmp_ds set fixa=isnull(fixa,0)+@difffixa
			,tire=isnull(tire,0)+@difftire
			,item=isnull(item,0)+@diffitem
			,other=isnull(other,0)+@diffother
			where tranno=@tranno and trannoq=@trannoq
			
			set @n = @n + 1
		end
		fetch next from cursor_table
		into @mon,@carno,@driverno,@fixa,@tire,@item,@other
	end
	close cursor_table
	deallocate cursor_table
	----------------------------------------------------------------------------------------------
	--加油,ETC
	declare @tmp2 table(
		carno nvarchar(20),
		oil float,
		oil1 float,--修正用
		oil2 float--修正用
	)
	insert into @tmp2(carno,oil)
	select carno,SUM(ISNULL([money],0)) [money] 
	from oil 
	where left(datea,6)between left(@t_btrandate,6) and left(@t_etrandate,6) and ISNULL([money],0)!=0
	group by carno
	
	update #z_tmp_ds set oil=case when b.total=0 then 0 else round(a.total/b.total*c.oil,0) end
	from #z_tmp_ds a
	right join (select carno,SUM(total) total from #z_tmp_ds where isnull(total,0)>0 group by carno) b on a.carno=b.carno
	right join @tmp2 c on a.carno=c.carno
	where isnull(a.total,0)>0
	--==修正金額
	update @tmp2 set oil1=b.mm1
	from @tmp2 a
	right join (select carno,SUM(ISNULL(oil,0)) mm1 from #z_tmp_ds group by carno) b on a.carno=b.carno
	
	update @tmp2 set oil2= ISNULL(oil,0)-ISNULL(oil1,0)	
	delete @tmp2 where ISNULL(oil2,0)=0 
	--==在平均分攤金額再加總時,多少會有誤差,因此依money1一次補1調整,LOOP 直到沒誤差
	update #z_tmp_ds set oil = a.oil + case when d.oil2<0 then -1 else 1 end * (floor(ABS(d.oil2)/c.nn)+case when (cast(ABS(d.oil2) as int)%c.nn)>=b.recno then 1 else 0 end)
	from #z_tmp_ds a
	right join(select ROW_NUMBER()over(partition by carno order by total) recno
		,tranno,trannoq from #z_tmp_ds where total!=0) b on a.tranno=b.tranno and a.trannoq=b.trannoq
	right join(select carno,COUNT(1) nn from #z_tmp_ds where total!=0 group by carno) c on a.carno=c.carno
	right join @tmp2 d on a.carno=d.carno	
	--==無出車單的另外寫入
	update @tmp2 set oil1=b.mm1
	from @tmp2 a
	right join (select carno,SUM(ISNULL(oil,0)) mm1 from #z_tmp_ds group by carno) b on a.carno=b.carno
	update @tmp2 set oil2= ISNULL(oil,0)-ISNULL(oil1,0)	
	delete @tmp2 where ISNULL(oil2,0)=0 
	insert into #z_tmp_ds(carteamno,custno,carno,oil)
	select 'zzzzz##','zzzzz##',carno,oil2 from @tmp2
	
	declare @tmp5 table(
		carno nvarchar(20),
		driverno nvarchar(20),
		datea nvarchar(10),
		etc float,
		etc1 float,--修正用
		etc2 float--修正用
	)
	insert into @tmp5(carno,driverno,datea,etc)
	select carno,driverno,datea,SUM(ISNULL([money],0)) [money] 
	from etc
	where left(datea,6)between left(@t_btrandate,6) and left(@t_etrandate,6) and ISNULL([money],0)!=0
	and (typea='ETC' or typea='CASH')
	group by carno,driverno,datea
	
	update #z_tmp_ds set etc=case when b.total=0 then 0 else round(a.total/b.total*c.etc,0) end
	from #z_tmp_ds a
	right join (select carno,driverno,SUM(total) total from #z_tmp_ds where isnull(total,0)>0 group by carno,driverno) b on a.carno=b.carno and a.driverno=b.driverno
	right join @tmp5 c on a.carno=c.carno and a.driverno=c.driverno and a.trandate=c.datea
	where isnull(a.total,0)>0

	----==修正金額
	update @tmp5 set etc1=b.mm1
	from @tmp5 a
	right join (select carno,driverno,trandate,SUM(ISNULL(etc,0)) mm1 from #z_tmp_ds group by carno,driverno,trandate) b on a.carno=b.carno and a.driverno=b.driverno and a.datea=b.trandate
	update @tmp5 set etc2= ISNULL(etc,0)-ISNULL(etc1,0)	
	delete @tmp5 where ISNULL(etc2,0)=0 
	--==在平均分攤金額再加總時,多少會有誤差,因此依money1一次補1調整,LOOP 直到沒誤差
	update #z_tmp_ds set etc = a.etc + case when d.etc2<0 then -1 else 1 end * (floor(ABS(d.etc2)/c.nn)+case when (cast(ABS(d.etc2) as int)%c.nn)>=b.recno then 1 else 0 end)
	from #z_tmp_ds a
	right join(select ROW_NUMBER()over(partition by carno,trandate order by total) recno
		,tranno,trannoq from #z_tmp_ds where total!=0) b on a.tranno=b.tranno and a.trannoq=b.trannoq
	right join(select carno,driverno,trandate,COUNT(1) nn from #z_tmp_ds where total!=0 group by carno,driverno,trandate) c on a.carno=c.carno and a.driverno=c.driverno and a.trandate=c.trandate
	right join @tmp5 d on a.carno=d.carno and a.driverno=d.driverno and a.trandate=d.datea	
	--==無出車單的另外寫入
	update @tmp5 set etc1=b.mm1
	from @tmp5 a
	right join (select carno,driverno,trandate,SUM(ISNULL(etc,0)) mm1 from #z_tmp_ds group by carno,driverno,trandate) b on a.carno=b.carno and a.driverno=b.driverno and a.datea=b.trandate
	update @tmp5 set etc2= ISNULL(etc,0)-ISNULL(etc1,0)	
	delete @tmp5 where ISNULL(etc2,0)=0 
	insert into #z_tmp_ds(carteamno,custno,carno,driverno,trandate,etc)
	select 'zzzzz##','zzzzz##',carno,driverno,datea,etc2 from @tmp5
	--declare @tmp06 table(
	--	datea nvarchar(10),
	--	carno nvarchar(20),
	--	oil float,
	--	etc float,
	--	caroil float,
	--	caretc float
	--)
	--insert into @tmp06(datea,carno,oil,etc)
	--select a.datea,a.carno,SUM(a.oil),SUM(a.etc)
	--from
	--	(select a.datea,isnull(a.carno,'') carno,SUM(ISNULL(a.[money],0)) oil,0  etc
	--	from oil a
	--	where left(a.datea,6) between left(@t_btrandate,6) and left(@t_etrandate,6)
	--	group by a.datea,isnull(a.carno,'')
	--	union all
	--	select a.datea,isnull(a.carno,''),0,SUM(ISNULL(a.[money],0))
	--	from etc a
	--	where (typea='ETC' or typea='CASH')
	--	and left(a.datea,6) between left(@t_btrandate,6) and left(@t_etrandate,6)
	--	group by a.datea,isnull(a.carno,'')) a
	--group by a.datea,a.carno
	----收金額合計
	--declare @tmp06_a table(
	--	datea nvarchar(10),
	--	carno nvarchar(20),
	--	total float
	--)
	--insert into @tmp06_a(datea,carno,total)
	--select a.trandate,isnull(a.carno,''),SUM(ISNULL(total,0)) 
	--from #z_tmp_ds a
	--group by a.trandate,isnull(a.carno,'')
	----依收金額比例分配加減項金額
	--update #z_tmp_ds
	--set oil = case when ISNULL(c.total,0)=0 then 0 else round(isnull(a.total,0)*ISNULL(b.oil,0)/ISNULL(c.total,0),0)end
	--	,etc = case when ISNULL(c.total,0)=0 then 0 else round(isnull(a.total,0)*ISNULL(b.etc,0)/ISNULL(c.total,0),0)end
	--from #z_tmp_ds a
	--inner join @tmp06 b on a.trandate=b.datea and a.carno = b.carno
	--inner join @tmp06_a c on a.trandate=c.datea and a.carno = c.carno
	----檢查有加油或ETC,但當天無收金額的
	--insert into #z_tmp_ds(carteamno,custno,trandate,carno,oil,etc,addr)
	--select 'zzzzz##','zzzzz##',a.datea,a.carno,a.oil,a.etc,'當日無出車'
	--from @tmp06 a
	--left join @tmp06_a b on a.datea=b.datea and a.carno=b.carno
	--where isnull(b.total,0)=0 and (isnull(a.oil,0)!=0 or isnull(a.etc,0)!=0)
	------修正誤差,由收入最高的依序補回一次補1,LOOP
	--update @tmp06
	--set caroil = ISNULL(b.oil,0)
	--	,caretc = ISNULL(b.etc,0)
	--from @tmp06 a
	--inner join (select ISNULL(trandate,'') datea
	--	,ISNULL(carno,'') carno
	--	,SUM(ISNULL(oil,0)) oil
	--	,SUM(ISNULL(etc,0)) etc
	--	from #z_tmp_ds 
	--	group by ISNULL(trandate,''),ISNULL(carno,'')) b on a.datea=b.datea and a.carno=b.carno
	
	----修正誤差用
	--declare @ztmp06 table(
	--	recno int,
	--	carno nvarchar(20),
	--	datea nvarchar(10),
	--	tranno nvarchar(20),
	--	trannoq nvarchar(10),
	--	oil float,
	--	etc float
	--	UNIQUE (recno,carno,datea)
	--)
	--insert into @ztmp06(recno,carno,datea,tranno,trannoq,oil,etc)
	--select ROW_NUMBER()over(partition by isnull(carno,''),isnull(trandate,'') order by isnull(total,0) desc,tranno,trannoq) 
	--,isnull(carno,''),isnull(trandate,''),tranno,trannoq,isnull(oil,0),isnull(etc,0)
	--from #z_tmp_ds
	
	--declare cursor_table cursor for
	--select datea,carno,caroil-oil,caretc - etc from @tmp06
	--open cursor_table
	--fetch next from cursor_table
	--into @datea,@carno,@oil,@etc
	--while(@@FETCH_STATUS <> -1)
	--begin		
	--	select @n = 1,@curoil=@oil,@curetc=@etc
	--	while(@curoil!=0 or @curetc!=0)
	--	begin		
	--		if not exists(select tranno from @ztmp06 where carno=@carno and datea=@datea and recno=@n)
	--		begin
	--			if((@curoil=@oil and @oil!=0) or (@curetc=@etc and @etc!=0))
	--			begin
	--				--避免LOOP
	--				select '資料異常 @ztmp01 01',@carno,@datea,@n
	--				return
	--			return
	--			end
	--			set @n = 1
	--		end
	--		select @tranno=tranno,@trannoq=trannoq,@caroil=oil,@caretc=etc 
	--		from @ztmp06 where carno=@carno and datea=@datea and recno=@n
	--		if(@tranno is null)
	--		begin
	--			select '資料異常 @ztmp01 02',@carno,@datea,@n
	--			return
	--		end
	--		select @diffoil=0,@diffetc=0 
	--		if(@caroil!=0)
	--		begin
	--			set @diffoil = case when @curoil>0 then -1 when @curoil<0 then 1 else 0 end
	--			set @curoil = @curoil + @diffoil
	--		end
	--		if(@caretc!=0)
	--		begin
	--			set @diffetc = case when @curetc>0 then -1 when @curetc<0 then 1 else 0 end
	--			set @curetc = @curetc + @diffetc
	--		end			
	--		update #z_tmp_ds set oil=isnull(oil,0)+@diffoil
	--		,etc=isnull(etc,0)+@diffetc
	--		where tranno=@tranno and trannoq=@trannoq
			
	--		set @n = @n + 1
	--	end
	--	fetch next from cursor_table
	--	into @datea,@carno,@oil,@etc
	--end
	--close cursor_table
	--deallocate cursor_table
	----------------------------------------------------------------------------------------------
	update #z_tmp_ds set profit = isnull(total,0)-isnull(total2,0)-isnull(reserve,0)-isnull(tolls,0)
		+isnull(custplus,0)-isnull(custminus,0)-isnull(carplus,0)+isnull(carminus,0)-isnull(oil,0)-isnull(etc,0)
		-isnull(fixa,0)-isnull(tire,0)-isnull(item,0)-isnull(other,0)
	
	delete #z_tmp_ds
	from #z_tmp_ds a
	left join #carteam b on a.carteamno = b.noa
	left join #calctype c on a.calctype = c.noa
	where  not((a.carteamno='zzzzz##') or (a.custno='zzzzz##'))
	and((b.noa is null and len(isnull(a.carteamno,''))>0)
	or (c.noa is null and len(isnull(a.calctype,''))>0)
	or not(a.trandate between @t_btrandate and @t_etrandate)
	or not(a.custno between @t_bcustno and @t_ecustno)
	or not(a.addrno between @t_baddrno and @t_eaddrno)
	or not(a.driverno between @t_bdriverno and @t_edriverno))

	if(LEN(@t_carno)>0)
	begin
		delete #z_tmp_ds
		from #z_tmp_ds a
		left join #carno b on a.carno = b.noa
		where b.noa is null 
	end
	if(LEN(@t_po)>0)
	begin
		delete #z_tmp_ds
		from #z_tmp_ds a
		left join #po b on a.po = b.noa
		where b.noa is null 
	end
	----------------------------------------------------------------------------------------------	
	declare @tmp table(
		page int,
		nn int,
		gno nvarchar(10),
		recno int,
		custno nvarchar(20),
		nick nvarchar(20),
		carteamno nvarchar(20),
		carteam nvarchar(20),
		trandate nvarchar(10),
		addrno nvarchar(20),
		addr nvarchar(40),
		carno nvarchar(20),
		driver nvarchar(20),
		total float,
		total2 float,
		reserve float,
		tolls float,
		custplus float,
		custminus float,
		carplus float,
		carminus float,
		oil float,
		etc float,
		fixa float,
		tire float,
		item float,
		other float,
		profit float,
		miles float
	)
	--------------------------------------------------------------------------------------------
	declare @rowline int -- 每頁可用行數
	declare @endline int -- 頁尾行數
	declare @page int
	declare @recno int
	declare @curline int -- 當前行數
	set @rowline = 31
	set @endline = 1
	set @page=0
	set @curline = 0

	declare @tot int
	
	update #z_tmp_ds set carno = case when len(isnull(carno,''))=0  then 'yyyyy##' else carno end
	
	declare cursor_table cursor for
	select a.carno,COUNT(1)
	from #z_tmp_ds a
	left join car2 b on a.carno=b.carno
	group by a.carno,case when len(isnull(b.carkindno,''))=0 then char(255) else b.carkindno end,case when len(isnull(b.caryear,''))=0 then char(255) else b.caryear end
	order by case when len(isnull(b.carkindno,''))=0 then char(255) else b.carkindno end
	,case when len(isnull(b.caryear,''))=0 then char(255) else b.caryear end
	,case  when a.carno=char(255) then 1 when a.carno='yyyyy##' then 2 when len(isnull(a.carno,''))=0 then 3 else 4 end desc
	open cursor_table
	fetch next from cursor_table
	into @carno,@tot
	while(@@FETCH_STATUS <> -1)
	begin		
		--小計
		select @total=sum(isnull(total,0)),@total2=sum(isnull(total2,0))
			,@reserve=sum(isnull(reserve,0)),@tolls=sum(isnull(tolls,0))
			,@custplus=sum(isnull(custplus,0)),@custminus=sum(isnull(custminus,0))
			,@carplus=sum(isnull(carplus,0)),@carminus=sum(isnull(carminus,0))
			,@oil=sum(isnull(oil,0)),@etc=sum(isnull(etc,0))
			,@fixa=sum(isnull(fixa,0)),@tire=sum(isnull(tire,0))
			,@item=sum(isnull(item,0))
			,@other=sum(isnull(other,0))
			,@profit=sum(isnull(profit,0))
			,@miles=sum(isnull(miles,0))
		from #z_tmp_ds where carno=@carno
		select @gno = case when @profit<=0 then '3' else '2' end
		
		if(@t_option08!='detail')
		begin
			if(@curline%@rowline=0)
			begin	
				insert into @tmp(page,nn,gno,carno)
				select @page,@curline%@rowline,'1',@carno
				set @curline = @curline + 1
			end		
			insert into @tmp(page,nn,gno,carno
				,total,total2,reserve,tolls,custplus,custminus,carplus,carminus
				,oil,etc,fixa,tire,item,other,profit,miles)
			select @page,@curline%@rowline,@gno,@carno
				,@total,@total2,@reserve,@tolls,@custplus,@custminus,@carplus,@carminus
				,@oil,@etc,@fixa,@tire,@item,@other,@profit,@miles
			set @curline = @curline + 1
			--是否換頁
			if(@curline%@rowline=0)
			begin
				set @page = @page + 1
			end
		end
		else
		begin
			--要顯示明細
			if(@curline%@rowline>@rowline-4)--少於4行就跳到次頁
			begin
				while(1=1)
				begin
					insert into @tmp(page,nn,gno,carno)
					select @page,@curline%@rowline,'0',@carno
					set @curline = @curline + 1
					if(@curline%@rowline=0)
						break
				end
				set @page = @page + 1
			end
			--G.1
			insert into @tmp(page,nn,gno,carno)
			select @page,@curline%@rowline,'1',@carno
			set @curline = @curline + 1
			
			insert into @tmp(page,nn,gno,carno
				,total,total2,reserve,tolls,custplus,custminus,carplus,carminus
				,oil,etc,fixa,tire,item,other,profit,miles)
			select @page,@curline%@rowline,@gno,@carno
				,@total,@total2,@reserve,@tolls,@custplus,@custminus,@carplus,@carminus
				,@oil,@etc,@fixa,@tire,@item,@other,@profit,@miles
			set @curline = @curline + 1
			--是否換頁
			if(@curline%@rowline=0)
			begin	
				set @page = @page + 1
			end
			--明細	
			set @n=0
			set @recno = 1
			declare cursor_table2 cursor for
			select total,total2,reserve,tolls,custplus,custminus,carplus,carminus,oil,etc
				,fixa,tire,item,other,profit,trandate,carno,driver,addrno,addr,miles
			from #z_tmp_ds where carno=@carno
			order by trandate,carno,driver
			open cursor_table2
			fetch next from cursor_table2
			into @total,@total2,@reserve,@tolls,@custplus,@custminus,@carplus,@carminus,@oil,@etc
				,@fixa,@tire,@item,@other,@profit,@trandate,@carno,@driver,@addrno,@addr,@miles
			while(@@FETCH_STATUS <> -1)
			begin
				set @n = @n + 1
				if(@recno=1)
				begin
					insert into @tmp(page,nn,gno,carno)
					select @page,@curline%@rowline,'4',@carno
					set @curline = @curline + 1	
				end
				else
				begin
					if(@curline%@rowline=0)
					begin	
						insert into @tmp(page,nn,gno,carno)
						select @page,@curline%@rowline,'5',@carno
						set @curline = @curline + 1	
					end
				end
				if(@curline%@rowline=@rowline-1 or @tot=@n)
					select @gno = case when @profit<=0 then '9' else '8' end
				else
					select @gno = case when @profit<=0 then '7' else '6' end
				insert into @tmp(page,nn,gno,recno
					,total,total2,reserve,tolls,custplus,custminus,carplus,carminus,oil,etc
					,fixa,tire,item,other,profit,trandate,carno,driver,addrno,addr,miles)
				select @page,@curline%@rowline,@gno,@recno
					,@total,@total2,@reserve,@tolls,@custplus,@custminus,@carplus,@carminus,@oil,@etc
					,@fixa,@tire,@item,@other,@profit,@trandate,@carno,@driver,@addrno,@addr,@miles
				set @curline = @curline + 1
				--是否換頁
				if(@curline%@rowline=0)
				begin	
					set @page = @page + 1
				end
				set @recno = @recno +1
				fetch next from cursor_table2
				into @total,@total2,@reserve,@tolls,@custplus,@custminus,@carplus,@carminus,@oil,@etc
				,@fixa,@tire,@item,@other,@profit,@trandate,@carno,@driver,@addrno,@addr,@miles
			end
			close cursor_table2
			deallocate cursor_table2
		end
		fetch next from cursor_table
		into @carno,@tot
	end
	close cursor_table
	deallocate cursor_table	
	
	--總計
	select @total=sum(isnull(total,0)),@total2=sum(isnull(total2,0))
		,@reserve=sum(isnull(reserve,0)),@tolls=sum(isnull(tolls,0))
		,@custplus=sum(isnull(custplus,0)),@custminus=sum(isnull(custminus,0))
		,@carplus=sum(isnull(carplus,0)),@carminus=sum(isnull(carminus,0))
		,@oil=sum(isnull(oil,0)),@etc=sum(isnull(etc,0))
		,@fixa=sum(isnull(fixa,0)),@tire=sum(isnull(tire,0))
		,@item=sum(isnull(item,0))
		,@other=sum(isnull(other,0))
		,@profit=sum(isnull(profit,0))
		,@miles=sum(isnull(miles,0))
	from #z_tmp_ds
	insert into @tmp(page,nn,gno,carno
		,total,total2,reserve,tolls,custplus,custminus,carplus,carminus
		,oil,etc,fixa,tire,item,other,profit,miles)
	select @page,@curline%@rowline,'10',CHAR(255)
		,@total,@total2,@reserve,@tolls,@custplus,@custminus,@carplus,@carminus
		,@oil,@etc,@fixa,@tire,@item,@other,@profit,@miles
				
	select a.* 
	,case when a.carno='yyyyy##' then '' else a.carno end g00
	,a.recno g01
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.total),1)),4,12)) g02
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.custplus),1)),4,12)) g03
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.custminus),1)),4,12)) g04
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.total2),1)),4,12)) g05
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.carplus),1)),4,12)) g06
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.carminus),1)),4,12)) g07
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.reserve),1)),4,12)) g08
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.tolls),1)),4,12)) g09
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.oil),1)),4,12)) g10
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.etc),1)),4,12)) g11
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.fixa),1)),4,12)) g12
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.tire),1)),4,12)) g13
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.item),1)),4,12)) g14
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.profit),1)),4,12)) g15
	,a.trandate g16
	,a.carno g17
	,a.driver g18
	,a.addr g19
	,case when ISNULL(total,0)=0 then '' else cast(ROUND(ISNULL(oil,0)/ISNULL(total,0)*100,0)as nvarchar)+'%' end g20
	,case when ISNULL(miles,0)=0 then '' else CAST(ROUND(miles,0)as nvarchar) end g21
	,b.caryear g22
	,c.kind g23
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.other),1)),4,12)) g24
	from @tmp a
	left join car2 b on a.carno=b.carno
	left join carkind c on b.carkindno=c.noa
	order by 
	case when len(isnull(b.carkindno,''))=0 then char(255) else b.carkindno end
	,case when len(isnull(b.caryear,''))=0 then char(255) else b.caryear end
	,case  when a.carno=char(255) then 1 when a.carno='yyyyy##' then 2 when len(isnull(a.carno,''))=0 then 3 else 4 end desc
	,page,nn;

z_tran_ds01:--z_tran_ds01
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10) = '[1]'
	declare @t_name nvarchar(20) = '[2]'
	
	declare @t_bdate nvarchar(10) = case when '#non'=[3] then '' else [3] end
	declare @t_edate nvarchar(10) = case when '#non'=[4] then CHAR(255) else [4] end
	declare @t_btrandate nvarchar(10) = case when '#non'=[5] then '' else [5] end
	declare @t_etrandate nvarchar(10) = case when '#non'=[6] then CHAR(255) else [6] end
	
	declare @t_bcustno nvarchar(20) = case when '#non'=[7] then '' else [7] end
	declare @t_ecustno nvarchar(20) = case when '#non'=[8] then CHAR(255) else [8] end
	declare @t_baddrno nvarchar(20) = case when '#non'=[9] then '' else [9] end
	declare @t_eaddrno nvarchar(20) = case when '#non'=[10] then CHAR(255) else [10] end
	declare @t_bdriverno nvarchar(20) = case when '#non'=[11] then '' else [11] end
	declare @t_edriverno nvarchar(20) = case when '#non'=[12] then CHAR(255) else [12] end	
	declare @t_carno nvarchar(20) = case when '#non'=[13] then '' else [13] end
	declare @t_po nvarchar(20) = case when '#non'=[14] then '' else [14] end
	
	declare @t_carkind  nvarchar(max) = case when '#non'=[15] then '' else [15] end
	declare @t_carteam  nvarchar(max) = case when '#non'=[16] then '' else [16] end
	declare @t_calctypes  nvarchar(max) = case when '#non'=[17] then '' else [17] end	
	
	declare @t_rate01 nvarchar(10) = case when '#non'=[18] then '' else [18] end
	declare @t_filter01 nvarchar(max) = case when '#non'=[19] then '' else [19] end
	declare @t_option01 nvarchar(max) = case when '#non'=[20] then '' else [20] end
	declare @t_sort01 nvarchar(max) = case when '#non'=[21] then '' else [21] end
	----------------------------------------------------------------------------------------------
	set @t_btrandate = case when len(@t_btrandate)=0 then @t_accy+'/01/01' else @t_btrandate end
	set @t_etrandate = case when @t_etrandate=CHAR(255) then @t_accy+'/12/31' else @t_etrandate end
	----------------------------------------------------------------------------------------------
	declare @string nvarchar(max)
	declare @n int
	----------------------------------------------------------------------------------------------
	declare @carno nvarchar(20)
	declare @datea nvarchar(10)
	declare @carkindno  nvarchar(20)
	declare @carkind	nvarchar(20)
	declare @miles float
	declare @tranmoney float
	declare @drivermoney float
	declare @reserve float 
	declare @mount float 
	declare @money float 
	----------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_tran01')is not null
	BEGIN
		set @cmd = 'drop table #z_tran01'
		EXECUTE sp_executesql @cmd
	END
	create table #z_tran01 (
		n float,
		gno nvarchar(3),
		carno nvarchar(20),
		carkindno nvarchar(20),
		carkind nvarchar(20),
		driverno nvarchar(20),
		driver nvarchar(20),
		trandate nvarchar(10),
		miles float,
		tranmoney float,
		drivermoney float,
		oilmount float,
		oilmoney float,
		tolls float,
		ticket float,
		reserve float,
		profit  float,
		memo nvarchar(max),
		rate1 float
	)
	CREATE INDEX noa ON #z_tran01 (carno,trandate)
	----------------------------------------------------------------------------------------------
	
	declare @t_date nvarchar(10)
	declare @t_date1 nvarchar(10)
	declare @t_date2 nvarchar(10)

	set @t_date1 = convert(nvarchar(4),convert(int,LEFT(@t_btrandate,3))+1911)+'-'+SUBSTRING(@t_btrandate,5,2)+'-'+RIGHT(@t_btrandate,2)
	set @t_date2 = convert(nvarchar(4),convert(int,LEFT(@t_etrandate,3))+1911)+'-'+SUBSTRING(@t_etrandate,5,2)+'-'+RIGHT(@t_etrandate,2)
	set @t_date=@t_date1

	if(isdate(@t_date1)=0 or isdate(@t_date2)=0)
	begin
		print '日期錯誤'
		return	
	end
	--if(DATEDIFF(MM,@t_date1,@t_date2)>2)
	--begin
	--	print '查詢區間不可超過三個月'
	--	return	
	--end
	IF OBJECT_ID('tempdb..#listDate')is not null
	BEGIN
		set @cmd = 'drop table #listDate'
		EXECUTE sp_executesql @cmd
	END
	create table #listDate(
		[date] nvarchar(20)
	)

	while (@t_date between @t_date1 and @t_date2)
	begin
		insert into #listDate select right('00'+convert(nvarchar(3),convert(int,YEAR(@t_date))-1911),3)+'/'+right('0'+convert(nvarchar(2),convert(int,MONTH(@t_date))),2)+'/'+right('0'+convert(nvarchar(2),convert(int,DAY(@t_date))),2)
		set @t_date= convert(date,DATEADD(DD,1,@t_date),111)
	end
	----------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#listCarno')is not null
	BEGIN
		set @cmd = 'drop table #listCarno'
		EXECUTE sp_executesql @cmd
	END
	create table #listCarno(
		carno nvarchar(20),	
		carkindno nvarchar(20),
		carkind nvarchar(20)																																				
	)
	insert into #listCarno(carno,carkindno,carkind)
	select  a.carno,isnull(c.noa,''),isnull(c.kind,'') 
	from  view_trans a  
	left join car2 b on a.carno=b.carno
	left join carKind c on b.carkindno=c.noa
	left join calctypes d on d.noa+d.noq=a.calctype
	where ( exists(select * from acomp where CHARINDEX('日光',comp)=0) or (exists(select * from acomp where CHARINDEX('日光',comp)>0) and isnull(d.isoutside,0)=0))
	and (len(@t_carno)=0 or @t_carno=a.carno)
	and ( len(@t_carkind)=0 or CHARINDEX(b.carkindno,c.noa)>0)
	and (LEFT(a.trandate,6)  between LEFT(@t_btrandate,6)  and  LEFT(@t_etrandate,6)) 
	group  by a.carno,isnull(c.noa,''),isnull(c.kind,'')

	----------------------------------------------------------------------------------------------
	
	
	declare cursor_table cursor for
	select carno,carkindno,carkind,[date] from #listCarno,#listDate
	open cursor_table
	fetch next from cursor_table
	into @carno,@carkindno,@carkind,@datea
	while(@@FETCH_STATUS <> -1)
	begin
		insert into #z_tran01(n,gno,carno,carkindno,carkind,trandate,rate1)values(-1,'1',@carno,@carkindno,@carkind,@datea,0)
		fetch next from cursor_table
		into @carno,@carkindno,@carkind,@datea
	end
	close cursor_table
	deallocate cursor_table
	-----------------------------------------------------------------------------------------------------------
	declare @trandate nvarchar(10)
	declare @memo nvarchar(max)
	--出車單
	declare @tmp table(
		carno nvarchar(20),
		trandate nvarchar(20),
		miles float,
		tranmoney float,
		drivermoney float,
		reserve float
	)
	insert into @tmp
	select a.carno,a.trandate
	,sum(ISNULL(e.miles,0))
	--,sum(round(a.price*a.mount,0))
	--,sum(round(a.price2*a.mount2*a.discount,0))
	,sum(round(a.total,0))
	,sum(round(a.total2,0))
	,sum(isnull(a.reserve,0))
	from view_trans a
	left join car2 b on a.carno=b.carno
	left join carKind c on b.carkindno=c.noa
	left  join  calctypes d on d.noa+d.noq=a.calctype 
	outer apply(select sum(ISNULL(miles,0)) miles from oil where carno=a.carno and datea=a.trandate) e
	where ( len(@t_carkind)=0 or CHARINDEX(b.carkindno,c.noa)>0)
	and (patindex('%option01%',@t_option01)=0 or (patindex('%option01%',@t_option01)>0 and isnull(b.option01,0)=1))
	and isnull(d.isoutside,0)=0
	and (a.trandate between @t_btrandate and @t_etrandate)
	group by a.carno,a.trandate
	----------------------------------------------------------------------------------------------
	declare cursor_table cursor for
	select carno,trandate,miles,tranmoney,drivermoney,reserve from @tmp
	open cursor_table
	fetch next from cursor_table
	into @carno,@trandate,@miles,@tranmoney,@drivermoney,@reserve
	while(@@FETCH_STATUS <> -1)
	begin
		update #z_tran01 set miles=@miles,tranmoney=@tranmoney,drivermoney=@drivermoney,reserve=@reserve where carno=@carno and trandate=@trandate
		
		fetch next from cursor_table
		into @carno,@trandate,@miles,@tranmoney,@drivermoney,@reserve
	end
	close cursor_table
	deallocate cursor_table
	
	-----------------------------------------------------------------------------------------------------------
	--油費
	declare cursor_table cursor for
	select a.carno,a.datea,SUM(isnull(a.mount,0)),SUM(isnull(a.[money],0))
	from oil a
	left join car2 b on a.carno=b.carno
	where (a.datea between @t_btrandate and @t_etrandate)
	and patindex('%option01%',@t_option01)=0 or (patindex('%option01%',@t_option01)>0 and isnull(b.option01,0)=1)
	group  by  a.carno,a.datea
	open cursor_table
	fetch next from cursor_table
	into @carno,@datea,@mount,@money
	while(@@FETCH_STATUS <> -1)
	begin
		update #z_tran01 set oilmount=@mount,oilmoney=@money where carno=@carno and trandate=@datea
		
		fetch next from cursor_table
		into @carno,@datea,@mount,@money
	end
	close cursor_table
	deallocate cursor_table
	--加油備註
	declare cursor_table cursor for
	select a.carno,a.datea,a.memo
	from oil a
	left join car2 b on a.carno=b.carno
	where len(isnull(a.memo,''))>1 --排除MEMO  =  .  的
	and (a.datea between @t_btrandate and @t_etrandate)
	and patindex('%option01%',@t_option01)=0 or (patindex('%option01%',@t_option01)>0 and isnull(b.option01,0)=1)
	open cursor_table
	fetch next from cursor_table
	into @carno,@datea,@memo
	while(@@FETCH_STATUS <> -1)
	begin
		set @memo = case when left(@memo,1)='.' then SUBSTRING(@memo,1,LEN(@memo)) else @memo end
		update #z_tran01 set
		memo=ISNULL(memo,'')+case when len(ISNULL(memo,''))>0 then CHAR(59) else '' end + @memo
		where carno=@carno and trandate=@datea
		
		fetch next from cursor_table
		into @carno,@datea,@memo
	end
	close cursor_table
	deallocate cursor_table
	-----------------------------------------------------------------------------------------------------------
	--ETC
	declare cursor_table cursor for
	select a.carno,a.datea,SUM(isnull(a.[money],0))
	from etc a
	left join car2 b on a.carno=b.carno
	where (a.typea='ETC' or a.typea='CASH')
	and (a.datea between @t_btrandate and @t_etrandate)
	and patindex('%option01%',@t_option01)=0 or (patindex('%option01%',@t_option01)>0 and isnull(b.option01,0)=1)
	group  by  a.carno,a.datea
	open cursor_table
	fetch next from cursor_table
	into @carno,@datea,@money
	while(@@FETCH_STATUS <> -1)
	begin
		update #z_tran01 set tolls=@money where carno=@carno and trandate=@datea
		
		fetch next from cursor_table
		into @carno,@datea,@money
	end
	close cursor_table
	deallocate cursor_table
	-----------------------------------------------------------------------------------------------------------
	--罰單
	declare cursor_table cursor for
	select a.carno,a.datea,SUM(isnull(a.comppay,0))
	from carborr a
	left join car2 b on a.carno=b.carno
	where comppay!=0
	and patindex('%option01%',@t_option01)=0 or (patindex('%option01%',@t_option01)>0 and isnull(b.option01,0)=1)
	and (a.datea between @t_btrandate and @t_etrandate)
	group  by  a.carno,a.datea
	open cursor_table
	fetch next from cursor_table
	into @carno,@datea,@money
	while(@@FETCH_STATUS <> -1)
	begin
		update #z_tran01 set ticket=@money where carno=@carno and trandate=@datea
		
		fetch next from cursor_table
		into @carno,@datea,@money
	end
	close cursor_table
	deallocate cursor_table
	----------------------------------------------------------------------------------------------
	update #z_tran01 set profit=ISNULL(tranmoney,0)-ISNULL(drivermoney,0)-ISNULL(oilmoney,0)-ISNULL(tolls,0)-ISNULL(ticket,0)-ISNULL(reserve,0)
	
	delete #z_tran01 where (isnull(tranmoney,0)=0 and isnull(oilmoney,0)=0 and @t_rate01>0) or (isnull(tranmoney,0)!=0 and round(isnull(oilmoney,0)*100/isnull(tranmoney,0),0)<CAST(@t_rate01 as float))
	
	---------------------------------------------------------------------------------------------
	insert  into  #z_tran01
	select  2,'2',CHAR(255),'','','','',CHAR(255)
	,SUM(ISNULL(miles,0)),SUM(ISNULL(tranmoney,0)),SUM(ISNULL(drivermoney,0)),SUM(ISNULL(oilmount,0)),SUM(ISNULL(oilmoney,0))
	,SUM(ISNULL(tolls,0)),SUM(ISNULL(ticket,0)),SUM(ISNULL(reserve,0)),SUM(ISNULL(profit,0)),'',0
	from  #z_tran01 where gno='1'
	
	update #z_tran01 set rate1 = cast(case when isnull(tranmoney,0)=0 then 0 else round(isnull(oilmoney,0)*100/isnull(tranmoney,0),0) end as nvarchar)
	----------------------------------------------------------------------------------------------
	declare @driver nvarchar(40)
	declare @straddr nvarchar(40)
	declare @total float
	declare @str varchar(max)
	declare @bool bit
	declare @rate1 float
	declare @oilstation nvarchar(20)
	declare @price float
	declare @bmiles float
	declare @emiles float
	declare @oilmoney float
	declare @profit float
	if(patindex('%trans%',@t_filter01)>0 or patindex('%oil%',@t_filter01)>0)
	begin
		declare cursor_table cursor for
		select trandate,carkindno,carno,isnull(rate1,0),tranmoney,oilmoney,profit from #z_tran01 where gno='1'
		open cursor_table
		fetch next from cursor_table
		into @trandate,@carkindno,@carno,@rate1,@tranmoney,@oilmoney,@profit
		while(@@FETCH_STATUS <> -1)
		begin
			--出車明細
			set @bool = 0
			set @cmd ="if exists(select noa from view_trans where carno=@carno and trandate=@trandate) set @bool = 1 else set @bool = 0"
			execute sp_executesql @cmd,N'@bool bit output,@carno nvarchar(20),@trandate nvarchar(10)',@bool=@bool output,@carno=@carno,@trandate=@trandate			
			if(@bool=1 and patindex('%trans%',@t_filter01)>0)
			begin
				set @str = '司機'+SPACE(8)
				+SPACE(2)+'起迄地點'+SPACE(12)
				+SPACE(2)+SPACE(6)+'收入'
				+SPACE(2)+SPACE(4)+'里程數'
				set @str = REPLACE(@str,SPACE(1),'&nbsp'+CHAR(59))
				insert into #z_tran01(n,gno,trandate,carkindno,carno,memo,rate1,tranmoney,oilmoney,profit)
				values(0,'3',@trandate,@carkindno,@carno,@str,@rate1,@tranmoney,@oilmoney,@profit)
				
				declare cursor_table2 cursor for
				select driver,straddr,total,miles from view_trans where carno=@carno and trandate=@trandate
				open cursor_table2
				fetch next from cursor_table2
				into @driver,@straddr,@total,@miles
				while(@@FETCH_STATUS <> -1)
				begin
					set @str = left(CAST(@driver+space(12) as varchar(12)),12)
					+SPACE(2)+ left(CAST(@straddr+space(20) as varchar(20)),20)
					+SPACE(2)+ RIGHT(space(10)+ reverse(substring(reverse(convert(varchar(15),CONVERT(money,isnull(@total,0)),1)),4,10)),10)
				 	+SPACE(2)+ RIGHT(space(10)+ reverse(substring(reverse(convert(varchar(15),CONVERT(money,isnull(@miles,0)),1)),4,10)),10)
				 	set @str = REPLACE(@str,SPACE(1),'&nbsp'+CHAR(59))
				 	insert into #z_tran01(n,gno,trandate,carkindno,carno,memo,rate1,tranmoney,oilmoney,profit)values(0.1,'0',@trandate,@carkindno,@carno,@str,@rate1,@tranmoney,@oilmoney,@profit)
				 	fetch next from cursor_table2
				 	into @driver,@straddr,@total,@miles
				end
				close cursor_table2
				deallocate cursor_table2
	
			end
			--加油明細
			set @bool = 0
			if exists(select noa from oil where carno=@carno and datea=@trandate )
				set @bool = 1
			else
				set @bool = 0
			if(@bool=1 and patindex('%oil%',@t_filter01)>0)
			begin	
				set @str = '站名'+SPACE(4)
				+SPACE(2)+SPACE(4)+'公升'
				+SPACE(2)+SPACE(4)+'單價'
				+SPACE(2)+SPACE(12)+'金額'
				+SPACE(2)+SPACE(4)+'里程數'
				+SPACE(2)+SPACE(2)+'上次里程數'
				+SPACE(2)+SPACE(2)+'本次里程數'

				set @str = REPLACE(@str,SPACE(1),'&nbsp'+CHAR(59))
				insert into #z_tran01(n,gno,trandate,carkindno,carno,memo,rate1,tranmoney,oilmoney,profit)values(0.2,'4',@trandate,@carkindno,@carno,@str,@rate1,@tranmoney,@oilmoney,@profit)

				declare cursor_table2 cursor for
				select oilstation,price,mount,[money],bmiles,emiles,miles from oil where carno=@carno and datea=@trandate order by datea,timea
				open cursor_table2
				fetch next from cursor_table2
				into @oilstation,@price,@mount,@money,@bmiles,@emiles,@miles
				while(@@FETCH_STATUS <> -1)
				begin
					set @str = left(CAST(@oilstation+space(8) as varchar(8)),8)
					+SPACE(2)+ RIGHT(space(8)+ Cast(CAST(@mount as decimal(10,2)) as varchar(8)),8) 
					+SPACE(2)+ RIGHT(space(8)+ Cast(CAST(@price as decimal(10,2)) as varchar(8)),8)
					+SPACE(2)+ RIGHT(space(16)+ dbo.getComma(@money,-1),16)
					+SPACE(2)+ RIGHT(space(10)+ dbo.getComma(@miles,-1),10) 
					+SPACE(2)+ RIGHT(space(12)+ dbo.getComma(@bmiles,-1),12)
					+SPACE(2)+ RIGHT(space(12)+ dbo.getComma(@emiles,-1),12)					
					set @str = REPLACE(@str,SPACE(1),'&nbsp'+CHAR(59))
					insert into #z_tran01(n,gno,trandate,carkindno,carno,memo,rate1,tranmoney,oilmoney,profit)values(0.21,'0',@trandate,@carkindno,@carno,@str,@rate1,@tranmoney,@oilmoney,@profit)

					fetch next from cursor_table2
					into @oilstation,@price,@mount,@money,@bmiles,@emiles,@miles
				end
				close cursor_table2
				deallocate cursor_table2
			end

			fetch next from cursor_table
			into @trandate,@carkindno,@carno,@rate1,@tranmoney,@oilmoney,@profit
		end
		close cursor_table
		deallocate cursor_table
	end
	----------------------------------------------------------------------------------------------
	-- 排除當日沒資料的 2017/05/02
	if not exists(select * from acomp where CHARINDEX('日光',acomp)>0)
	begin
		delete #z_tran01 where miles is null and tranmoney is null and drivermoney is null
			and oilmount is null and oilmoney is null and tolls is null and ticket is null
			and reserve is null
	end
	
	update #z_tran01 set gno='5' where gno='1' and profit<0
	select @cmd = ''
	select @cmd = cast(COUNT(1) as nvarchar)+'車次' from #z_tran01 where gno='1' or gno='5'
	if @t_sort01 = 'trandate'
	begin
		insert into #z_tran01
		select -1,'6','','','','','',LEFT(trandate,6)+'小計'
		,SUM(ISNULL(miles,0)),SUM(ISNULL(tranmoney,0)),SUM(ISNULL(drivermoney,0))
		,SUM(ISNULL(oilmount,0)),SUM(ISNULL(oilmoney,0)),SUM(ISNULL(tolls,0))
		,SUM(ISNULL(ticket,0)),SUM(ISNULL(reserve,0)),SUM(ISNULL(profit,0))
		,'' memo
		,case when sum(isnull(tranmoney,0))!=0 then round(sum(ISNULL(oilmoney,0))/sum(isnull(tranmoney,0))*100,0) else 0 end
		from #z_tran01
		where (gno='1' or gno='5')
		group by LEFT(trandate,6)
		
		select a.*,trandate dd,c.kind 類別,b.caryear 年份,b.cylinder 汽缸
		,case when a.oilmount=0 then null else cast(a.miles/a.oilmount as decimal(10,3)) end kml
		,cast(a.rate1 as nvarchar)+'%' 耗油比
		,dbo.getComma(miles,-1) 公里數
		,cast(case when isnull(oilmount,0)=0 then 0 else round(isnull(miles,0)/isnull(oilmount,0),2) end as nvarchar) 公里升
		,dbo.getComma(tranmoney ,-1) 收入
		,dbo.getComma(drivermoney ,-1) 薪資
		,dbo.getComma(oilmoney ,-1) 油費
		,dbo.getComma(oilmount ,-1) 油量
		,dbo.getComma(tolls ,-1) 通行費
		,dbo.getComma(ticket ,-1) 罰款
		,dbo.getComma(a.reserve ,-1) 寄櫃費
		,dbo.getComma(a.profit ,-1) 淨利
		,isnull(a.memo,'')+case when len(ISNULL(a.memo,''))>0 then CHAR(59) else '' end +isnull(e.memo,'') mmm
		,@cmd times
		from #z_tran01 a
		left join car2 b on a.carno=b.carno
		left join carKind c on b.carkindno=c.noa
		left join driver d on a.driverno=d.noa
		left join carpresents e on a.carno=e.carno and a.trandate=e.datea
		order  by  a.trandate,a.carkindno,b.caryear,a.carno,n
	end
	if @t_sort01 = 'rate1'
	begin
		select a.*,trandate dd,c.kind 類別,b.caryear 年份,b.cylinder 汽缸
		,case when a.oilmount=0 then null else cast(a.miles/a.oilmount as decimal(10,3)) end kml
		,cast(a.rate1 as nvarchar)+'%' 耗油比
		,dbo.getComma(miles,-1) 公里數
		,cast(case when isnull(oilmount,0)=0 then 0 else round(isnull(miles,0)/isnull(oilmount,0),2) end as nvarchar) 公里升
		,dbo.getComma(tranmoney ,-1) 收入
		,dbo.getComma(drivermoney ,-1) 薪資
		,dbo.getComma(oilmoney ,-1) 油費
		,dbo.getComma(oilmount ,-1) 油量
		,dbo.getComma(tolls ,-1) 通行費
		,dbo.getComma(ticket ,-1) 罰款
		,dbo.getComma(a.reserve ,-1) 寄櫃費
		,dbo.getComma(a.profit ,-1) 淨利
		,isnull(a.memo,'')+case when len(ISNULL(a.memo,''))>0 then CHAR(59) else '' end +isnull(e.memo,'') mmm
		,@cmd times
		,case when gno='2' then -999 when a.rate1=0 and a.oilmoney!=0 then (9999) else a.rate1 end sort01
		from #z_tran01 a
		left join car2 b on a.carno=b.carno
		left join carKind c on b.carkindno=c.noa
		left join driver d on a.driverno=d.noa
		left join carpresents e on a.carno=e.carno and a.trandate=e.datea
		order  by  sort01 desc,a.trandate,a.carkindno,b.caryear,a.carno,n
	end
	if @t_sort01 = 'tranmoney'
	begin
		select a.*,trandate dd,c.kind 類別,b.caryear 年份,b.cylinder 汽缸
		,case when a.oilmount=0 then null else cast(a.miles/a.oilmount as decimal(10,3)) end kml
		,cast(a.rate1 as nvarchar)+'%' 耗油比
		,dbo.getComma(miles,-1) 公里數
		,cast(case when isnull(oilmount,0)=0 then 0 else round(isnull(miles,0)/isnull(oilmount,0),2) end as nvarchar) 公里升
		,dbo.getComma(tranmoney ,-1) 收入
		,dbo.getComma(drivermoney ,-1) 薪資
		,dbo.getComma(oilmoney ,-1) 油費
		,dbo.getComma(oilmount ,-1) 油量
		,dbo.getComma(tolls ,-1) 通行費
		,dbo.getComma(ticket ,-1) 罰款
		,dbo.getComma(a.reserve ,-1) 寄櫃費
		,dbo.getComma(a.profit ,-1) 淨利
		,isnull(a.memo,'')+case when len(ISNULL(a.memo,''))>0 then CHAR(59) else '' end +isnull(e.memo,'') mmm
		,@cmd times
		from #z_tran01 a
		left join car2 b on a.carno=b.carno
		left join carKind c on b.carkindno=c.noa
		left join driver d on a.driverno=d.noa
		left join carpresents e on a.carno=e.carno and a.trandate=e.datea
		order  by  (case when a.gno='2' then 9 else 1 end),a.tranmoney desc,a.trandate,a.carkindno,b.caryear,a.carno,n
	end
	if @t_sort01 = 'caryear'
	begin
		select a.*,trandate dd,c.kind 類別,b.caryear 年份,b.cylinder 汽缸
		,case when a.oilmount=0 then null else cast(a.miles/a.oilmount as decimal(10,3)) end kml
		,cast(a.rate1 as nvarchar)+'%' 耗油比
		,dbo.getComma(miles,-1) 公里數
		,cast(case when isnull(oilmount,0)=0 then 0 else round(isnull(miles,0)/isnull(oilmount,0),2) end as nvarchar) 公里升
		,dbo.getComma(tranmoney ,-1) 收入
		,dbo.getComma(drivermoney ,-1) 薪資
		,dbo.getComma(oilmoney ,-1) 油費
		,dbo.getComma(oilmount ,-1) 油量
		,dbo.getComma(tolls ,-1) 通行費
		,dbo.getComma(ticket ,-1) 罰款
		,dbo.getComma(a.reserve ,-1) 寄櫃費
		,dbo.getComma(a.profit ,-1) 淨利
		,isnull(a.memo,'')+case when len(ISNULL(a.memo,''))>0 then CHAR(59) else '' end +isnull(e.memo,'') mmm
		,@cmd times
		from #z_tran01 a
		left join car2 b on a.carno=b.carno
		left join carKind c on b.carkindno=c.noa
		left join driver d on a.driverno=d.noa
		left join carpresents e on a.carno=e.carno and a.trandate=e.datea
		order  by  (case when a.gno='2' then 9 else 1 end),isnull(b.caryear,'') desc,a.carkindno,a.carno,a.trandate,n
	end
	if @t_sort01 = 'driverno'
	begin
		select a.*,trandate dd,c.kind 類別,b.caryear 年份,b.cylinder 汽缸
		,case when a.oilmount=0 then null else cast(a.miles/a.oilmount as decimal(10,3)) end kml
		,cast(a.rate1 as nvarchar)+'%' 耗油比
		,dbo.getComma(miles,-1) 公里數
		,cast(case when isnull(oilmount,0)=0 then 0 else round(isnull(miles,0)/isnull(oilmount,0),2) end as nvarchar) 公里升
		,dbo.getComma(tranmoney ,-1) 收入
		,dbo.getComma(drivermoney ,-1) 薪資
		,dbo.getComma(oilmoney ,-1) 油費
		,dbo.getComma(oilmount ,-1) 油量
		,dbo.getComma(tolls ,-1) 通行費
		,dbo.getComma(ticket ,-1) 罰款
		,dbo.getComma(a.reserve ,-1) 寄櫃費
		,dbo.getComma(a.profit ,-1) 淨利
		,isnull(a.memo,'')+case when len(ISNULL(a.memo,''))>0 then CHAR(59) else '' end +isnull(e.memo,'') mmm
		,@cmd times
		from #z_tran01 a
		left join car2 b on a.carno=b.carno
		left join carKind c on b.carkindno=c.noa
		left join driver d on a.driverno=d.noa
		left join carpresents e on a.carno=e.carno and a.trandate=e.datea
		order  by  (case when a.gno='2' then 9 else 1 end),a.driverno,a.carkindno,a.carno,a.trandate,n
	end
	if @t_sort01 = 'profit'
	begin
		select a.*,trandate dd,c.kind 類別,b.caryear 年份,b.cylinder 汽缸
		,case when a.oilmount=0 then null else cast(a.miles/a.oilmount as decimal(10,3)) end kml
		,cast(a.rate1 as nvarchar)+'%' 耗油比
		,dbo.getComma(miles,-1) 公里數
		,cast(case when isnull(oilmount,0)=0 then 0 else round(isnull(miles,0)/isnull(oilmount,0),2) end as nvarchar) 公里升
		,dbo.getComma(tranmoney ,-1) 收入
		,dbo.getComma(drivermoney ,-1) 薪資
		,dbo.getComma(oilmoney ,-1) 油費
		,dbo.getComma(oilmount ,-1) 油量
		,dbo.getComma(tolls ,-1) 通行費
		,dbo.getComma(ticket ,-1) 罰款
		,dbo.getComma(a.reserve ,-1) 寄櫃費
		,dbo.getComma(a.profit ,-1) 淨利
		,isnull(a.memo,'')+case when len(ISNULL(a.memo,''))>0 then CHAR(59) else '' end +isnull(e.memo,'') mmm
		,@cmd times
		from #z_tran01 a
		left join car2 b on a.carno=b.carno
		left join carKind c on b.carkindno=c.noa
		left join driver d on a.driverno=d.noa
		left join carpresents e on a.carno=e.carno and a.trandate=e.datea
		order  by  (case when a.gno='2' then 9 else 1 end),a.profit desc,a.trandate,a.carkindno,b.caryear,a.carno,n
	end
	----------------------------------------------------------------------------------------------
	drop table #listDate
	drop table #z_tran01;
	
z_tran_ds02:--z_tran_ds02
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_name nvarchar(20)
	
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_baddrno nvarchar(20)
	declare @t_eaddrno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	
	declare @t_carkind  nvarchar(max)
	declare @t_carteam  nvarchar(max)
	declare @t_calctypes  nvarchar(max)
	
	declare @t_rate01 nvarchar(10)
	declare @t_filter01 nvarchar(max)
	declare @t_option01 nvarchar(max)
	declare @t_sort01 nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_name = '[2]'
	set @t_bdate = case when '#non'=[3] then '' else [3] end
	set @t_edate = case when '#non'=[4] then CHAR(255) else [4] end
	set @t_btrandate = case when '#non'=[5] then '' else [5] end
	set @t_etrandate = case when '#non'=[6] then CHAR(255) else [6] end
	
	set @t_bcustno = case when '#non'=[7] then '' else [7] end
	set @t_ecustno = case when '#non'=[8] then CHAR(255) else [8] end
	set @t_baddrno = case when '#non'=[9] then '' else [9] end
	set @t_eaddrno = case when '#non'=[10] then CHAR(255) else [10] end
	set @t_bdriverno = case when '#non'=[11] then '' else [11] end
	set @t_edriverno = case when '#non'=[12] then CHAR(255) else [12] end	
	set @t_carno = case when '#non'=[13] then '' else [13] end
	set @t_po = case when '#non'=[14] then '' else [14] end
	set @t_carkind  = case when '#non'=[15] then '' else [15] end
	set @t_carteam  = case when '#non'=[16] then '' else [16] end
	set @t_calctypes  = case when '#non'=[17] then '' else [17] end	
	set @t_rate01  = case when '#non'=[18] then '' else [18] end
	set @t_filter01  = case when '#non'=[19] then '' else [19] end
	set @t_option01  = case when '#non'=[20] then '' else [20] end
	set @t_sort01  = case when '#non'=[21] then '' else [21] end
	----------------------------------------------------------------------------------------------
	set @t_btrandate = case when len(@t_btrandate)=0 then @t_accy+'/01/01' else @t_btrandate end
	set @t_etrandate = case when @t_etrandate=CHAR(255) then @t_accy+'/12/31' else @t_etrandate end
	----------------------------------------------------------------------------------------------
	declare @ncarno int
	set @ncarno = 15 -- 一頁顯示幾台車
	declare @carno nvarchar(20)
	declare @datea nvarchar(10)
	declare @field nvarchar(20)
	declare @miles float
	declare @carkindno nvarchar(20)
	declare @carkind nvarchar(20)
	declare @caryear nvarchar(20)
	------------------------------------------------------------------------------------------
	declare @string nvarchar(max)
	declare @n int
	
	----------------------------------------------------------------------------------------------
	--日期列表
	declare @t_date nvarchar(10)
	declare @t_date1 nvarchar(10)
	declare @t_date2 nvarchar(10)

	set @t_date1 = convert(nvarchar(4),convert(int,LEFT(@t_btrandate,3))+1911)+'-'+SUBSTRING(@t_btrandate,5,2)+'-'+RIGHT(@t_btrandate,2)
	set @t_date2 = convert(nvarchar(4),convert(int,LEFT(@t_etrandate,3))+1911)+'-'+SUBSTRING(@t_etrandate,5,2)+'-'+RIGHT(@t_etrandate,2)
	set @t_date=@t_date1

	if(isdate(@t_date1)=0 or isdate(@t_date2)=0)
	begin
		print '日期錯誤'
		return	
	end
	--if(DATEDIFF(MM,@t_date1,@t_date2)>2)
	--begin
	--	print '查詢區間不可超過三個月'
	--	return	
	--end
	IF OBJECT_ID('tempdb..#listDate')is not null
	BEGIN
		drop table #listDate
	END
	create table #listDate(
		[date] nvarchar(20)
	)

	while (@t_date between @t_date1 and @t_date2)
	begin
		insert into #listDate select right('00'+convert(nvarchar(3),convert(int,YEAR(@t_date))-1911),3)+'/'+right('0'+convert(nvarchar(2),convert(int,MONTH(@t_date))),2)+'/'+right('0'+convert(nvarchar(2),convert(int,DAY(@t_date))),2)
		set @t_date= convert(date,DATEADD(DD,1,@t_date),111)
	end
	------------------------------------------------------------------------------------------------
	declare @tmp1 table(
		carno nvarchar(20),
		trandate nvarchar(20),
		miles float
	)
	
	insert into @tmp1
	select a.carno,a.trandate,sum(ISNULL(f.miles,0))
	from view_trans a
	left join car2 b on a.carno=b.carno
	left join calctypes c on c.noa+c.noq=a.calctype 
	left join carKind e on b.carkindno=e.noa 
	outer apply(select sum(ISNULL(miles,0)) miles from oil where carno=a.carno and datea=a.trandate) f 
	where len(ISNULL(a.carno,''))>0 and isnull(c.isoutside,0)=0 --判斷是不是公司車 
	and (patindex('%option01%',@t_option01)=0 or (patindex('%option01%',@t_option01)>0 and isnull(b.option01,0)=1))
	and (len(@t_carkind)=0 or CHARINDEX(','+b.carkindno+',',','+@t_carkind+',')>0)
	and (a.trandate between @t_btrandate and @t_etrandate)
	and (len(@t_carno)=0 or a.carno=@t_carno)
	and ISNULL(f.miles,0)!=0
	group by a.carno,a.trandate
	
	execute sp_executesql @cmd,N'@t_option01 nvarchar(max),@t_btrandate nvarchar(10),@t_etrandate nvarchar(10),@t_carno nvarchar(20)'
	,@t_option01=@t_option01,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate,@t_carno=@t_carno
	-------------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_trana03')is not null 
	BEGIN 
		set @cmd = 'drop table #z_trana03' 
		EXECUTE sp_executesql @cmd 
	END 
	create table #z_trana03( 
		n int,
		gno nvarchar(10),
		pno nvarchar(10),
		datea nvarchar(10)
	)
	CREATE INDEX noa ON #z_trana03 (n,datea)
	
	set @n = 1
	while(@n<=@ncarno)
	begin
		set @cmd = "ALTER TABLE #z_trana03 ADD aa"+RIGHT("00"+CAST(@n as nvarchar),2)+" nvarchar(20) NULL"
		+",bb"+RIGHT("00"+CAST(@n as nvarchar),2)+" nvarchar(20) NULL"
		+",cc"+RIGHT("00"+CAST(@n as nvarchar),2)+" nvarchar(20) NULL"
		+",dd"+RIGHT("00"+CAST(@n as nvarchar),2)+" nvarchar(20) NULL"
		execute sp_executesql @cmd
		set @n = @n + 1
	end
	-------------------------------------------------------------------------------------------------
	--車輛欄位對應
	declare @tmp2 table(
		n int,
		field nvarchar(10),
		carno nvarchar(20),
		carkindno nvarchar(20),
		carkind nvarchar(20),
		caryear nvarchar(10)
	)
	insert into @tmp2
	select null,null,a.carno,isnull(b.carkindno,''),isnull(c.kind,''),isnull(b.caryear,'') from @tmp1 a
	left join car2 b on a.carno=b.carno
	left join carKind c on b.carkindno=c.noa
	group by a.carno,isnull(b.carkindno,''),isnull(c.kind,''),isnull(b.caryear,'')
	order by isnull(b.carkindno,''),isnull(b.caryear,''),a.carno
	
	set @n = 0
	declare cursor_table cursor for
	select carno from @tmp2
	open cursor_table
	fetch next from cursor_table
	into @carno
	while(@@FETCH_STATUS <> -1)
	begin
		update @tmp2 set n = floor(@n/@ncarno)+1,field= right("00"+cast(@n%@ncarno+1 as nvarchar),2) where carno=@carno
		set @n = @n + 1
		fetch next from cursor_table
		into @carno
	end
	close cursor_table
	deallocate cursor_table
	------------------------------------------------------------------------------------------------
	--總計欄位
	declare @tmp3 table(
		n int,
		field nvarchar(10)
	)
	insert into @tmp3 select floor(@n/@ncarno)+1, right("00"+cast(@n%@ncarno+1 as nvarchar),2)
	------------------------------------------------------------------------------------------------
	declare @count int
	set @count = floor(@n/@ncarno)+1
	while @count > 0
	begin
		insert into #z_trana03(n,gno,pno,datea)values(@count,'1','2','車輛小計')
		declare cursor_table cursor for
		select [date] from #listDate
		open cursor_table
		fetch next from cursor_table
		into @datea
		while(@@FETCH_STATUS <> -1)
		begin
			insert into #z_trana03(n,gno,pno,datea)values(@count,'0','1',@datea)
			declare cursor_table2 cursor for
			select n,field,carno,carkind,caryear from @tmp2
			open cursor_table2
			fetch next from cursor_table2
			into @n,@field,@carno,@carkind,@caryear
			while(@@FETCH_STATUS <> -1)
			begin
				set @cmd = "update #z_trana03 set aa"+@field+"=@carkind"
				+",bb"+@field+"=@caryear"
				+",cc"+@field+"=@carno"
				+" where n=@n"			
				execute sp_executesql @cmd,N'@n int,@carkind nvarchar(20),@caryear nvarchar(20),@carno nvarchar(20)'
				,@n=@n,@carkind=@carkind,@caryear=@caryear,@carno=@carno
				
				fetch next from cursor_table2
				into @n,@field,@carno,@carkind,@caryear
			end
			close cursor_table2
			deallocate cursor_table2
			
			select @n=null,@field=null
			select @n = n, @field = field from @tmp3 
			set @cmd = "update #z_trana03 set aa"+@field+"=''"
			+",bb"+@field+"='日小計'"
			+",cc"+@field+"=''"
			+" where n=@n"			
			execute sp_executesql @cmd,N'@n int,@carkind nvarchar(20),@caryear nvarchar(20),@carno nvarchar(20)'
			,@n=@n,@carkind=@carkind,@caryear=@caryear,@carno=@carno
			
			fetch next from cursor_table
			into @datea
		end
		close cursor_table
		deallocate cursor_table
		set @count= @count - 1
	end
	---------------------------------------------------------------------------------------
	--每日
	declare cursor_table cursor for
	select a.carno,a.trandate,a.miles,b.n,b.field,b.carkindno,b.carkind,b.caryear from @tmp1 a
	left join @tmp2 b on a.carno=b.carno
	open cursor_table
	fetch next from cursor_table
	into @carno,@datea,@miles,@n,@field,@carkindno,@carkind,@caryear
	while(@@FETCH_STATUS <> -1)
	begin
		set @cmd = "update #z_trana03 set dd"+@field+"=reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(@miles,0)),1)),4,12))"
		+" where n=@n and datea=@datea"
		execute sp_executesql @cmd,N'@n int,@datea nvarchar(10),@miles float'
		,@n=@n,@datea=@datea,@miles=@miles
		fetch next from cursor_table
		into @carno,@datea,@miles,@n,@field,@carkindno,@carkind,@caryear
	end
	close cursor_table
	deallocate cursor_table
	--日小計
	declare cursor_table cursor for
	select b.n,b.field,a.trandate,SUM(ISNULL(a.miles,0)) from @tmp1 a,@tmp3 b  
	group by b.n,b.field,a.trandate
	open cursor_table
	fetch next from cursor_table
	into @n,@field,@datea,@miles
	while(@@FETCH_STATUS <> -1)
	begin
		set @cmd = "update #z_trana03 set dd"+@field+"=reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(@miles,0)),1)),4,12))"
		+" where n=@n and datea=@datea"
		execute sp_executesql @cmd,N'@n int,@datea nvarchar(10),@miles float'
		,@n=@n,@datea=@datea,@miles=@miles
		fetch next from cursor_table
		into @n,@field,@datea,@miles
	end
	close cursor_table
	deallocate cursor_table
	--車輛小計
	declare cursor_table cursor for
	select a.carno,SUM(ISNULL(a.miles,0)),b.n,b.field,b.carkindno,b.carkind,b.caryear from @tmp1 a
	left join @tmp2 b on a.carno=b.carno
	group by a.carno,b.n,b.field,b.carkindno,b.carkind,b.caryear
	open cursor_table
	fetch next from cursor_table
	into @carno,@miles,@n,@field,@carkindno,@carkind,@caryear
	while(@@FETCH_STATUS <> -1)
	begin
		set @cmd = "update #z_trana03 set dd"+@field+"=reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(@miles,0)),1)),4,12))"
		+" where n=@n and gno='1'"
		execute sp_executesql @cmd,N'@n int,@datea nvarchar(10),@miles float'
		,@n=@n,@datea=@datea,@miles=@miles
		fetch next from cursor_table
		into @carno,@miles,@n,@field,@carkindno,@carkind,@caryear
	end
	close cursor_table
	deallocate cursor_table
	
	select @n=null,@field=null,@miles=0
	select @n=n,@field=field from @tmp3
	select @miles=SUM(ISNULL(miles,0)) from @tmp1
	set @cmd = "update #z_trana03 set dd"+@field+"=reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(@miles,0)),1)),4,12))"
	+" where n=@n and gno='1'"
	execute sp_executesql @cmd,N'@n int,@datea nvarchar(10),@miles float'
	,@n=@n,@datea=@datea,@miles=@miles
	
	select * from #z_trana03 order by n,pno,datea
	drop table #z_trana03
	drop table #listDate;
	
z_tran_ds03:--z_tran_ds03
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_name nvarchar(20)
	
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_baddrno nvarchar(20)
	declare @t_eaddrno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	
	declare @t_carkind  nvarchar(max)
	declare @t_carteam  nvarchar(max)
	declare @t_calctypes  nvarchar(max)
	
	declare @t_rate01 nvarchar(10)
	declare @t_filter01 nvarchar(max)
	declare @t_option01 nvarchar(max)
	declare @t_sort01 nvarchar(max)
	declare @t_sort03 nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_name = '[2]'
	set @t_bdate = case when '#non'=[3] then '' else [3] end
	set @t_edate = case when '#non'=[4] then CHAR(255) else [4] end
	set @t_btrandate = case when '#non'=[5] then '' else [5] end
	set @t_etrandate = case when '#non'=[6] then CHAR(255) else [6] end
	
	set @t_bcustno = case when '#non'=[7] then '' else [7] end
	set @t_ecustno = case when '#non'=[8] then CHAR(255) else [8] end
	set @t_baddrno = case when '#non'=[9] then '' else [9] end
	set @t_eaddrno = case when '#non'=[10] then CHAR(255) else [10] end
	set @t_bdriverno = case when '#non'=[11] then '' else [11] end
	set @t_edriverno = case when '#non'=[12] then CHAR(255) else [12] end	
	set @t_carno = case when '#non'=[13] then '' else [13] end
	set @t_po = case when '#non'=[14] then '' else [14] end
	set @t_carkind  = case when '#non'=[15] then '' else [15] end
	set @t_carteam  = case when '#non'=[16] then '' else [16] end
	set @t_calctypes  = case when '#non'=[17] then '' else [17] end	
	set @t_rate01  = case when '#non'=[18] then '' else [18] end
	set @t_filter01  = case when '#non'=[19] then '' else [19] end
	set @t_option01  = case when '#non'=[20] then '' else [20] end
	set @t_sort01  = case when '#non'=[21] then '' else [21] end
	set @t_sort03  = case when '#non'=[22] then '' else [22] end
	-----------------------------------------------------------------------------------
	declare @string nvarchar(max)
	declare @n int
	--解析要計算的種類
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	----------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_trana02')is not null 
	BEGIN 
		set @cmd = 'drop table #z_trana02' 
		EXECUTE sp_executesql @cmd 
	END 
	create table #z_trana02( 
		carkindno nvarchar(20), 
		carkind nvarchar(20), 
		carno nvarchar(20), 
		mon nvarchar(10), 
		caryear nvarchar(10),--年份

		inmoney float,--收入 
		tranmiles float,--公里數 
		outmoney float,--司機運費
		carplus float,--司機加項
		carminus float,--司機減項
		
		oilmoney float,--油費 
		oilmount float,--油量 
		oilmiles float,--公里數
		
		fixa1 float,--修理費
		fixa2 float,--板修理
		tire1 float,--輪胎費
		tire2 float,--板輪胎
		stuff1 float,--材料費
		stuff2 float,--板材料

		tolls float,--通行費 
		reserve float,--寄櫃費
		 
		tax float,--保牌燃費
		depreciation float,--折舊
		profit float--淨利 
	) 
	---------------------------------------------------------------------------------- 
	declare @carkindno nvarchar(20) 
	declare @carkind nvarchar(20) 
	declare @caryear nvarchar(10) 
	declare @carno nvarchar(20) 
	declare @mon nvarchar(10) 
	declare @inmoney float 
	declare @outmoney float 
	declare @tranmiles float 
	declare @reserve float 

	set @cmd = 
	" select ISNULL(e.noa,'') carkindno,ISNULL(e.kind,'') carkind,ISNULL(b.caryear,'') caryear,isnull(a.carno,'') carno,left(isnull(a.trandate,''),6) mon"+ 
	" ,SUM(ISNULL(a.total,0)) inmoney,SUM(ISNULL(a.total2,0)) inmoney,SUM(ISNULL(a.miles,0)) tranmiles,SUM(ISNULL(a.reserve,0)) reserve"+ 
	" from view_trans"+@t_accy+" a"+ 
	" left join car2 b on a.carno=b.carno"+ 
	" left join calctypes c on c.noa+c.noq=a.calctype "+ 
	" left join #carkind d on b.carkindno=d.noa"+ 
	" left join carKind e on d.noa=e.noa"+ 
	" where isnull(c.isoutside,0)=0"+ --判斷是不是公司車 
	" and d.noa is not null"+ 
	" and (a.trandate between @t_btrandate and @t_etrandate)"+ 
	" and (len(@t_carno)=0 or a.carno=@t_carno)"+ 
	" group by ISNULL(e.noa,''),ISNULL(e.kind,''),ISNULL(b.caryear,''),isnull(a.carno,''),left(isnull(a.trandate,''),6)"+ 
	" order by carkindno,carkind,caryear,carno,mon"
	
	insert into #z_trana02(carkindno,carkind,caryear,carno,mon,inmoney,outmoney,tranmiles,reserve)
	execute sp_executesql @cmd,N'@t_btrandate nvarchar(10),@t_etrandate nvarchar(10),@t_carno nvarchar(20)' 
	,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate,@t_carno=@t_carno 
	------------------------------------------------------------------------------------ 
	--carchg
	declare @carplus float
	declare @carminus float
	
	declare cursor_table cursor for
	select ISNULL(e.noa,'') carkindno,ISNULL(e.kind,'') carkind,ISNULL(b.caryear,'') caryear
	,a.carno,left(a.datea,6),sum(isnull(a.plusmoney,0))
	,sum(case when len(isnull(a.tggno,''))=0 then isnull(a.minusmoney,0) else 0 end)--非代收、代付 
	from carchg a
	left join car2 b on a.carno=b.carno
	left join #carkind d on b.carkindno=d.noa
	left join carKind e on d.noa=e.noa
	left join driver f on a.driverno=f.noa
	where d.noa is not null
	and (a.datea between @t_btrandate and @t_etrandate)
	and (len(@t_carno)=0 or a.carno=@t_carno)
	and ISNULL(f.cartype,'')='公司車'
	group by ISNULL(e.noa,''),ISNULL(e.kind,''),ISNULL(b.caryear,''),a.carno,left(a.datea,6)
	open cursor_table
	fetch next from cursor_table
	into @carkindno,@carkind,@caryear,@carno,@mon,@carplus,@carminus
	while(@@FETCH_STATUS <> -1)
	begin
		if exists(select * from #z_trana02 where carno=@carno and mon=@mon)
			update #z_trana02 set carplus=@carplus,carminus=@carminus where carno=@carno and mon=@mon
		else
			insert into #z_trana02(carkindno,carkind,caryear,carno,mon,carplus,carminus)
			values(@carkindno,@carkind,@caryear,@carno,@mon,@carplus,@carminus)

		fetch next from cursor_table
		into @carkindno,@carkind,@caryear,@carno,@mon,@carplus,@carminus
	end
	close cursor_table
	deallocate cursor_table
	------------------------------------------------------------------------------------ 
	--OIL
	declare @oilmount float
	declare @oilmoney float
	declare @oilmiles float
	
	declare cursor_table cursor for
	select ISNULL(e.noa,'') carkindno,ISNULL(e.kind,'') carkind,ISNULL(b.caryear,'') caryear,isnull(a.carno,'') carno,left(isnull(a.datea,''),6) mon
	,sum(ISNULL(a.mount,0)) oilmount,sum(ISNULL(a.[money],0)) oilmoney,sum(ISNULL(a.miles,0)) oilmiles
	from oil a
	left join car2 b on a.carno=b.carno
	left join #carkind d on b.carkindno=d.noa
	left join carKind e on d.noa=e.noa
	where d.noa is not null
	and (a.datea between @t_btrandate and @t_etrandate)
	and (len(@t_carno)=0 or a.carno=@t_carno)
	group by ISNULL(e.noa,''),ISNULL(e.kind,''),ISNULL(b.caryear,''),isnull(a.carno,''),left(isnull(a.datea,''),6)
	order by carkindno,carkind,caryear,carno,mon
	open cursor_table
	fetch next from cursor_table
	into @carkindno,@carkind,@caryear,@carno,@mon,@oilmount,@oilmoney,@oilmiles
	while(@@FETCH_STATUS <> -1)
	begin
		if exists(select * from #z_trana02 where carno=@carno and mon=@mon)
			update #z_trana02 set oilmount=@oilmount,oilmoney=@oilmoney,oilmiles=@oilmiles where carno=@carno and mon=@mon
		else
			insert into #z_trana02(carkindno,carkind,caryear,carno,mon,oilmount,oilmoney,oilmiles)
			values(@carkindno,@carkind,@caryear,@carno,@mon,@oilmount,@oilmoney,@oilmiles)

		fetch next from cursor_table
		into @carkindno,@carkind,@caryear,@carno,@mon,@oilmount,@oilmoney,@oilmiles
	end
	close cursor_table
	deallocate cursor_table
	
	------------------------------------------------------------------------------------
	--ETC
	declare @tolls float
	
	declare cursor_table cursor for
	select ISNULL(e.noa,'') carkindno,ISNULL(e.kind,'') carkind,ISNULL(b.caryear,'') caryear,isnull(a.carno,'') carno,left(isnull(a.datea,''),6) mon
	,SUM(isnull(a.[money],0)) tolls
	from etc a
	left join car2 b on a.carno=b.carno
	left join #carkind d on b.carkindno=d.noa
	left join carKind e on d.noa=e.noa
	where (a.typea='ETC' or a.typea='CASH') and (d.noa is not null)
	and (a.datea between @t_btrandate and @t_etrandate)
	and (len(@t_carno)=0 or a.carno=@t_carno)
	group by ISNULL(e.noa,''),ISNULL(e.kind,''),ISNULL(b.caryear,''),isnull(a.carno,''),left(isnull(a.datea,''),6)
	order by carkindno,carkind,caryear,carno,mon
	open cursor_table
	fetch next from cursor_table
	into @carkindno,@carkind,@caryear,@carno,@mon,@tolls
	while(@@FETCH_STATUS <> -1)
	begin
		if exists(select * from #z_trana02 where carno=@carno and mon=@mon)
			update #z_trana02 set tolls=@tolls where carno=@carno and mon=@mon
		else
			insert into #z_trana02(carkindno,carkind,caryear,carno,mon,tolls)
			values(@carkindno,@carkind,@caryear,@carno,@mon,@tolls)

		fetch next from cursor_table
		into @carkindno,@carkind,@caryear,@carno,@mon,@tolls
	end
	close cursor_table
	deallocate cursor_table
	--------------------------------------------------------------------------------------
	--維修
	declare @fixa1 float
	declare @fixa2 float
	declare @tire1 float
	declare @tire2 float
	declare @stuff1 float
	declare @stuff2 float
	
	declare cursor_table cursor for
	select ISNULL(e.noa,'') carkindno,ISNULL(e.kind,'') carkind,ISNULL(b.caryear,'') caryear,isnull(a.carno,'') carno,left(isnull(a.fixadate,''),6) mon
	,sum(case when len(isnull(a.carplateno,''))=0 then ISNULL(a.wmoney,0)-ISNULL(a.discount,0) else 0 end) fixa1
	,sum(case when len(isnull(a.carplateno,''))>0 then ISNULL(a.wmoney,0)-ISNULL(a.discount,0) else 0 end) fixa2
	,sum(case when len(isnull(a.carplateno,''))=0 then ISNULL(a.cmoney,0) else 0 end) tire1
	,sum(case when len(isnull(a.carplateno,''))>0 then ISNULL(a.cmoney,0) else 0 end) tire2
	,sum(case when len(isnull(a.carplateno,''))=0 then ISNULL(a.dmoney,0) else 0 end) tire1
	,sum(case when len(isnull(a.carplateno,''))>0 then ISNULL(a.dmoney,0) else 0 end) tire2
	from fixa a
	left join car2 b on a.carno=b.carno
	left join #carkind d on b.carkindno=d.noa
	left join carKind e on d.noa=e.noa
	where  d.noa is not null
	and (a.fixadate between @t_btrandate and @t_etrandate)
	and (len(@t_carno)=0 or a.carno=@t_carno)
	group by ISNULL(e.noa,''),ISNULL(e.kind,''),ISNULL(b.caryear,''),isnull(a.carno,''),left(isnull(a.fixadate,''),6)
	order by carkindno,carkind,caryear,carno,mon
	open cursor_table
	fetch next from cursor_table
	into @carkindno,@carkind,@caryear,@carno,@mon,@fixa1,@fixa2,@tire1,@tire2,@stuff1,@stuff2
	while(@@FETCH_STATUS <> -1)
	begin
		if exists(select * from #z_trana02 where carno=@carno and mon=@mon)
			update #z_trana02 set fixa1=@fixa1,fixa2=@fixa2,tire1=@tire1,tire2=@tire2,stuff1=@stuff1,stuff2=@stuff2 where carno=@carno and mon=@mon
		else
			insert into #z_trana02(carkindno,carkind,caryear,carno,mon,fixa1,fixa2,tire1,tire2,stuff1,stuff2)
			values(@carkindno,@carkind,@caryear,@carno,@mon,@fixa1,@fixa2,@tire1,@tire2,@stuff1,@stuff2)

		fetch next from cursor_table
		into @carkindno,@carkind,@caryear,@carno,@mon,@fixa1,@fixa2,@tire1,@tire2,@stuff1,@stuff2
	end
	close cursor_table
	deallocate cursor_table
	--fixout
	declare cursor_table cursor for
	select ISNULL(e.noa,'') carkindno,ISNULL(e.kind,'') carkind,ISNULL(b.caryear,'') caryear,isnull(a.carno,'') carno,left(isnull(a.outdate,''),6) mon
	,sum(case when len(isnull(a.carplateno,''))=0 then ISNULL(a.[wmoney],0) else 0 end) fixa1
	,sum(case when len(isnull(a.carplateno,''))>0 then ISNULL(a.[wmoney],0) else 0 end) fixa2
	,sum(case when len(isnull(a.carplateno,''))=0 then ISNULL(a.[cmoney],0) else 0 end) tire1
	,sum(case when len(isnull(a.carplateno,''))>0 then ISNULL(a.[cmoney],0) else 0 end) tire2
	,sum(case when len(isnull(a.carplateno,''))=0 then ISNULL(a.[dmoney],0) else 0 end) stuff1
	,sum(case when len(isnull(a.carplateno,''))>0 then ISNULL(a.[dmoney],0) else 0 end) stuff2
	from fixout a
	left join car2 b on a.carno=b.carno
	left join #carkind d on b.carkindno=d.noa
	left join carKind e on d.noa=e.noa
	where  d.noa is not null
	and (a.outdate between @t_btrandate and @t_etrandate)
	and (len(@t_carno)=0 or a.carno=@t_carno)
	group by ISNULL(e.noa,''),ISNULL(e.kind,''),ISNULL(b.caryear,''),isnull(a.carno,''),left(isnull(a.outdate,''),6)
	order by carkindno,carkind,caryear,carno,mon
	open cursor_table
	fetch next from cursor_table
	into @carkindno,@carkind,@caryear,@carno,@mon,@fixa1,@fixa2,@tire1,@tire2,@stuff1,@stuff2
	while(@@FETCH_STATUS <> -1)
	begin
		if exists(select * from #z_trana02 where carno=@carno and mon=@mon)
			update #z_trana02 set fixa1=@fixa1,fixa2=@fixa2,tire1=@tire1,tire2=@tire2,stuff1=@stuff1,stuff2=@stuff2 where carno=@carno and mon=@mon
		else
			insert into #z_trana02(carkindno,carkind,caryear,carno,mon,fixa1,fixa2,tire1,tire2,stuff1,stuff2)
			values(@carkindno,@carkind,@caryear,@carno,@mon,@fixa1,@fixa2,@tire1,@tire2,@stuff1,@stuff2)

		fetch next from cursor_table
		into @carkindno,@carkind,@caryear,@carno,@mon,@fixa1,@fixa2,@tire1,@tire2,@stuff1,@stuff2
	end
	close cursor_table
	deallocate cursor_table
	
	--------------------------------------------------------------------------------------
	----保牌燃費,折舊 
	declare @tax float
	declare @depreciation float
	
	declare cursor_table cursor for
	select ISNULL(e.noa,'') carkindno,ISNULL(e.kind,'') carkind,ISNULL(b.caryear,'') caryear,isnull(f.carno,'') carno,isnull(a.mon,'') mon
	,sum(ISNULL(a.tax,0)) tax,sum(ISNULL(a.depreciation,0)) depreciation
	from carts a
	left join cart f on f.noa=a.noa
	left join car2 b on f.carno=b.carno
	left join #carkind d on b.carkindno=d.noa
	left join carKind e on d.noa=e.noa
	where d.noa is not null
	and (a.mon between left(@t_btrandate,6) and left(@t_etrandate,6))
	and (len(@t_carno)=0 or f.carno=@t_carno)
	group by ISNULL(e.noa,''),ISNULL(e.kind,''),ISNULL(b.caryear,''),isnull(f.carno,''),isnull(a.mon,'')
	order by carkindno,carkind,caryear,carno,mon
	open cursor_table
	fetch next from cursor_table
	into @carkindno,@carkind,@caryear,@carno,@mon,@tax,@depreciation
	while(@@FETCH_STATUS <> -1)
	begin
		if exists(select * from #z_trana02 where carno=@carno and mon=@mon)
			update #z_trana02 set tax=@tax,depreciation=@depreciation where carno=@carno and mon=@mon
		else
			insert into #z_trana02(carkindno,carkind,caryear,carno,mon,tax,depreciation)
			values(@carkindno,@carkind,@caryear,@carno,@mon,@tax,@depreciation)

		fetch next from cursor_table
		into @carkindno,@carkind,@caryear,@carno,@mon,@tax,@depreciation
	end
	close cursor_table
	deallocate cursor_table
	----------------------------------------------------------------------------------------
	update #z_trana02 set profit=ISNULL(inmoney,0)-ISNULL(outmoney,0)+ISNULL(carminus,0)-ISNULL(carplus,0)
	-ISNULL(oilmoney,0)
	-ISNULL(fixa1,0)-ISNULL(fixa2,0)-ISNULL(tire1,0)-ISNULL(tire2,0)-ISNULL(stuff1,0)-ISNULL(stuff2,0)
	-ISNULL(tolls,0)-ISNULL(reserve,0)-ISNULL(tax,0)-ISNULL(depreciation,0)
	delete #z_trana02 where len(isnull(@t_carno,''))>0 and carno!=@t_carno
	--只顯示特定車牌
	if patindex('%option01%',@t_option01)>0
	begin
		declare cursor_table cursor for
		select a.carno,isnull(b.option01,0) from #z_trana02 a left join car2 b on a.carno=b.carno
		open cursor_table
		fetch next from cursor_table
		into @carno,@n
		while(@@FETCH_STATUS <> -1)
		begin
			if @n = 0
				delete #z_trana02 where carno=@carno
			fetch next from cursor_table
			into @carno,@n
		end
		close cursor_table
		deallocate cursor_table
	end
	set @cmd = "交運日期："+@t_btrandate + '～'+@t_etrandate
	if @t_sort03='carkind'
	begin
		select 
		ROW_NUMBER()over(order by (case when gno='0' then '1' else '9'end),carkindno,carkind,caryear,carno) nn
		,case when gno='1' then '1'
			when ISNULL(profit,0)<0 then '2'
			else '0' end gno
		,case when gno='0' then '1' else '9' end pno
		,carkindno ck1
		,carkind ck2
		,carno
		,caryear cy
		,case when ISNULL(inmoney,0)=0 then '' else cast(round((isnull(oilmoney,0)/inmoney)*100,0) as nvarchar)+'%' end rate1
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(inmoney,0)),1)),4,12)) mm01	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmount,0)),1)),4,12)) mm02
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmoney,0)),1)),4,12)) mm03
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(outmoney,0)),1)),4,12)) mm04
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(carplus,0)),1)),4,12)) mm05
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(carminus,0)),1)),4,12)) mm06
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(fixa1,0)),1)),4,12)) mm07
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(fixa2,0)),1)),4,12)) mm08
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tire1,0)),1)),4,12)) mm09
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tire2,0)),1)),4,12)) mm10
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(stuff2,0)),1)),4,12)) mm11
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(stuff2,0)),1)),4,12)) mm12
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tolls,0)),1)),4,12)) mm13
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(reserve,0)),1)),4,12)) mm14	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tax,0)),1)),4,12)) mm15
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(depreciation,0)),1)),4,12)) mm16
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(profit	,0)),1)),4,12)) mm17
		,@cmd titlea		
		from(
			select '0' gno,carkindno,carkind,carno,caryear
			,SUM(ISNULL(inmoney,0)) inmoney,SUM(ISNULL(outmoney,0)) outmoney
			,SUM(ISNULL(carplus,0)) carplus,SUM(ISNULL(carminus,0)) carminus,SUM(ISNULL(tranmiles,0)) tranmiles
			,SUM(ISNULL(oilmoney,0)) oilmoney,SUM(ISNULL(oilmount,0)) oilmount,SUM(ISNULL(oilmiles,0)) oilmiles
			,SUM(ISNULL(fixa1,0)) fixa1,SUM(ISNULL(fixa2,0)) fixa2
			,SUM(ISNULL(tire1,0)) tire1,SUM(ISNULL(tire2,0)) tire2
			,SUM(ISNULL(stuff1,0)) stuff1,SUM(ISNULL(stuff2,0)) stuff2
			,SUM(ISNULL(tolls,0)) tolls,SUM(ISNULL(reserve,0)) reserve
			,SUM(ISNULL(tax,0)) tax,sum(ISNULL(depreciation,0)) depreciation,SUM(ISNULL(profit,0)) profit	
			from #z_trana02 
			group by carkindno,carkind,carno,caryear
			union all
			select '1' gno,'','','',''
			,SUM(ISNULL(inmoney,0)) inmoney,SUM(ISNULL(outmoney,0)) outmoney
			,SUM(ISNULL(carplus,0)) carplus,SUM(ISNULL(carminus,0)) carminus,SUM(ISNULL(tranmiles,0)) tranmiles
			,SUM(ISNULL(oilmoney,0)) oilmoney,SUM(ISNULL(oilmount,0)) oilmount,SUM(ISNULL(oilmiles,0)) oilmiles
			,SUM(ISNULL(fixa1,0)) fixa1,SUM(ISNULL(fixa2,0)) fixa2
			,SUM(ISNULL(tire1,0)) tire1,SUM(ISNULL(tire2,0)) tire2
			,SUM(ISNULL(stuff1,0)) stuff1,SUM(ISNULL(stuff2,0)) stuff2
			,SUM(ISNULL(tolls,0)) tolls,SUM(ISNULL(reserve,0)) reserve
			,SUM(ISNULL(tax,0)) tax,sum(ISNULL(depreciation,0)) depreciation,SUM(ISNULL(profit,0)) profit
			from #z_trana02  ) a	
		order by pno,carkindno,carkind,caryear,carno
	end
	else if @t_sort03='caryear'
	begin
		select 
		ROW_NUMBER()over(order by (case when gno='0' then '1' else '9'end),caryear,carkindno,carkind,carno) nn
		,case when gno='1' then '1'
			when ISNULL(profit,0)<0 then '2'
			else '0' end gno
		,case when gno='0' then '1' else '9' end pno
		,carkindno ck1
		,carkind ck2
		,carno
		,caryear cy
		,case when ISNULL(inmoney,0)=0 then '' else cast(round((isnull(oilmoney,0)/inmoney)*100,0) as nvarchar)+'%' end rate1
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(inmoney,0)),1)),4,12)) mm01	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmount,0)),1)),4,12)) mm02
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmoney,0)),1)),4,12)) mm03
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(outmoney,0)),1)),4,12)) mm04
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(carplus,0)),1)),4,12)) mm05
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(carminus,0)),1)),4,12)) mm06
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(fixa1,0)),1)),4,12)) mm07
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(fixa2,0)),1)),4,12)) mm08
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tire1,0)),1)),4,12)) mm09
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tire2,0)),1)),4,12)) mm10
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(stuff2,0)),1)),4,12)) mm11
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(stuff2,0)),1)),4,12)) mm12
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tolls,0)),1)),4,12)) mm13
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(reserve,0)),1)),4,12)) mm14	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tax,0)),1)),4,12)) mm15
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(depreciation,0)),1)),4,12)) mm16
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(profit	,0)),1)),4,12)) mm17
		,@cmd titlea		
		from(
			select '0' gno,carkindno,carkind,carno,caryear
			,SUM(ISNULL(inmoney,0)) inmoney,SUM(ISNULL(outmoney,0)) outmoney
			,SUM(ISNULL(carplus,0)) carplus,SUM(ISNULL(carminus,0)) carminus,SUM(ISNULL(tranmiles,0)) tranmiles
			,SUM(ISNULL(oilmoney,0)) oilmoney,SUM(ISNULL(oilmount,0)) oilmount,SUM(ISNULL(oilmiles,0)) oilmiles
			,SUM(ISNULL(fixa1,0)) fixa1,SUM(ISNULL(fixa2,0)) fixa2
			,SUM(ISNULL(tire1,0)) tire1,SUM(ISNULL(tire2,0)) tire2
			,SUM(ISNULL(stuff1,0)) stuff1,SUM(ISNULL(stuff2,0)) stuff2
			,SUM(ISNULL(tolls,0)) tolls,SUM(ISNULL(reserve,0)) reserve
			,SUM(ISNULL(tax,0)) tax,sum(ISNULL(depreciation,0)) depreciation,SUM(ISNULL(profit,0)) profit
			from #z_trana02 
			group by carkindno,carkind,carno,caryear
			union all
			select '1' gno,'','','',''
			,SUM(ISNULL(inmoney,0)) inmoney,SUM(ISNULL(outmoney,0)) outmoney
			,SUM(ISNULL(carplus,0)) carplus,SUM(ISNULL(carminus,0)) carminus,SUM(ISNULL(tranmiles,0)) tranmiles
			,SUM(ISNULL(oilmoney,0)) oilmoney,SUM(ISNULL(oilmount,0)) oilmount,SUM(ISNULL(oilmiles,0)) oilmiles
			,SUM(ISNULL(fixa1,0)) fixa1,SUM(ISNULL(fixa2,0)) fixa2
			,SUM(ISNULL(tire1,0)) tire1,SUM(ISNULL(tire2,0)) tire2
			,SUM(ISNULL(stuff1,0)) stuff1,SUM(ISNULL(stuff2,0)) stuff2
			,SUM(ISNULL(tolls,0)) tolls,SUM(ISNULL(reserve,0)) reserve
			,SUM(ISNULL(tax,0)) tax,sum(ISNULL(depreciation,0)) depreciation,SUM(ISNULL(profit,0)) profit
			from #z_trana02  ) a	
		order by pno,caryear,carkindno,carkind,carno
	end
	else if @t_sort03='rate1'
	begin
		select 
		ROW_NUMBER()over(order by (case when gno='0' then '1' else '9'end),case when ISNULL(inmoney,0)=0 then '' else cast(round((isnull(oilmoney,0)/inmoney)*100,0) as nvarchar)+'%' end  desc,carkindno,carkind,caryear,carno) nn
		,case when gno='1' then '1'
			when ISNULL(profit,0)<0 then '2'
			else '0' end gno
		,case when gno='0' then '1' else '9' end pno
		,carkindno ck1
		,carkind ck2
		,carno
		,caryear cy
		,case when ISNULL(inmoney,0)=0 then '' else cast(round((isnull(oilmoney,0)/inmoney)*100,0) as nvarchar)+'%' end rate1
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(inmoney,0)),1)),4,12)) mm01	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmount,0)),1)),4,12)) mm02
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmoney,0)),1)),4,12)) mm03
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(outmoney,0)),1)),4,12)) mm04
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(carplus,0)),1)),4,12)) mm05
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(carminus,0)),1)),4,12)) mm06
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(fixa1,0)),1)),4,12)) mm07
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(fixa2,0)),1)),4,12)) mm08
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tire1,0)),1)),4,12)) mm09
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tire2,0)),1)),4,12)) mm10
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(stuff2,0)),1)),4,12)) mm11
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(stuff2,0)),1)),4,12)) mm12
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tolls,0)),1)),4,12)) mm13
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(reserve,0)),1)),4,12)) mm14	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tax,0)),1)),4,12)) mm15
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(depreciation,0)),1)),4,12)) mm16
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(profit	,0)),1)),4,12)) mm17
		,@cmd titlea		
		from(
			select '0' gno,carkindno,carkind,carno,caryear
			,SUM(ISNULL(inmoney,0)) inmoney,SUM(ISNULL(outmoney,0)) outmoney
			,SUM(ISNULL(carplus,0)) carplus,SUM(ISNULL(carminus,0)) carminus,SUM(ISNULL(tranmiles,0)) tranmiles
			,SUM(ISNULL(oilmoney,0)) oilmoney,SUM(ISNULL(oilmount,0)) oilmount,SUM(ISNULL(oilmiles,0)) oilmiles
			,SUM(ISNULL(fixa1,0)) fixa1,SUM(ISNULL(fixa2,0)) fixa2
			,SUM(ISNULL(tire1,0)) tire1,SUM(ISNULL(tire2,0)) tire2
			,SUM(ISNULL(stuff1,0)) stuff1,SUM(ISNULL(stuff2,0)) stuff2
			,SUM(ISNULL(tolls,0)) tolls,SUM(ISNULL(reserve,0)) reserve
			,SUM(ISNULL(tax,0)) tax,sum(ISNULL(depreciation,0)) depreciation,SUM(ISNULL(profit,0)) profit
			from #z_trana02 
			group by carkindno,carkind,carno,caryear
			union all
			select '1' gno,'','','',''
			,SUM(ISNULL(inmoney,0)) inmoney,SUM(ISNULL(outmoney,0)) outmoney
			,SUM(ISNULL(carplus,0)) carplus,SUM(ISNULL(carminus,0)) carminus,SUM(ISNULL(tranmiles,0)) tranmiles
			,SUM(ISNULL(oilmoney,0)) oilmoney,SUM(ISNULL(oilmount,0)) oilmount,SUM(ISNULL(oilmiles,0)) oilmiles
			,SUM(ISNULL(fixa1,0)) fixa1,SUM(ISNULL(fixa2,0)) fixa2
			,SUM(ISNULL(tire1,0)) tire1,SUM(ISNULL(tire2,0)) tire2
			,SUM(ISNULL(stuff1,0)) stuff1,SUM(ISNULL(stuff2,0)) stuff2
			,SUM(ISNULL(tolls,0)) tolls,SUM(ISNULL(reserve,0)) reserve
			,SUM(ISNULL(tax,0)) tax,sum(ISNULL(depreciation,0)) depreciation,SUM(ISNULL(profit,0)) profit
			from #z_trana02  ) a	
		order by pno,rate1 desc,carkindno,carkind,caryear,carno
	end
	else if @t_sort03='profit'
	begin
		select 
		ROW_NUMBER()over(order by (case when gno='0' then '1' else '9'end),profit desc,carkindno,carkind,caryear,carno) nn
		,case when gno='1' then '1'
			when ISNULL(profit,0)<0 then '2'
			else '0' end gno
		,case when gno='0' then '1' else '9' end pno
		,carkindno ck1
		,carkind ck2
		,carno
		,caryear cy
		,case when ISNULL(inmoney,0)=0 then '' else cast(round((isnull(oilmoney,0)/inmoney)*100,0) as nvarchar)+'%' end rate1
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(inmoney,0)),1)),4,12)) mm01	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmount,0)),1)),4,12)) mm02
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmoney,0)),1)),4,12)) mm03
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(outmoney,0)),1)),4,12)) mm04
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(carplus,0)),1)),4,12)) mm05
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(carminus,0)),1)),4,12)) mm06
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(fixa1,0)),1)),4,12)) mm07
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(fixa2,0)),1)),4,12)) mm08
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tire1,0)),1)),4,12)) mm09
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tire2,0)),1)),4,12)) mm10
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(stuff2,0)),1)),4,12)) mm11
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(stuff2,0)),1)),4,12)) mm12
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tolls,0)),1)),4,12)) mm13
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(reserve,0)),1)),4,12)) mm14	
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tax,0)),1)),4,12)) mm15
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(depreciation,0)),1)),4,12)) mm16
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(profit	,0)),1)),4,12)) mm17
		,@cmd titlea		
		from(
			select '0' gno,carkindno,carkind,carno,caryear
			,SUM(ISNULL(inmoney,0)) inmoney,SUM(ISNULL(outmoney,0)) outmoney
			,SUM(ISNULL(carplus,0)) carplus,SUM(ISNULL(carminus,0)) carminus,SUM(ISNULL(tranmiles,0)) tranmiles
			,SUM(ISNULL(oilmoney,0)) oilmoney,SUM(ISNULL(oilmount,0)) oilmount,SUM(ISNULL(oilmiles,0)) oilmiles
			,SUM(ISNULL(fixa1,0)) fixa1,SUM(ISNULL(fixa2,0)) fixa2
			,SUM(ISNULL(tire1,0)) tire1,SUM(ISNULL(tire2,0)) tire2
			,SUM(ISNULL(stuff1,0)) stuff1,SUM(ISNULL(stuff2,0)) stuff2
			,SUM(ISNULL(tolls,0)) tolls,SUM(ISNULL(reserve,0)) reserve
			,SUM(ISNULL(tax,0)) tax,sum(ISNULL(depreciation,0)) depreciation,SUM(ISNULL(profit,0)) profit
			from #z_trana02 
			group by carkindno,carkind,carno,caryear
			union all
			select '1' gno,'','','',''
			,SUM(ISNULL(inmoney,0)) inmoney,SUM(ISNULL(outmoney,0)) outmoney
			,SUM(ISNULL(carplus,0)) carplus,SUM(ISNULL(carminus,0)) carminus,SUM(ISNULL(tranmiles,0)) tranmiles
			,SUM(ISNULL(oilmoney,0)) oilmoney,SUM(ISNULL(oilmount,0)) oilmount,SUM(ISNULL(oilmiles,0)) oilmiles
			,SUM(ISNULL(fixa1,0)) fixa1,SUM(ISNULL(fixa2,0)) fixa2
			,SUM(ISNULL(tire1,0)) tire1,SUM(ISNULL(tire2,0)) tire2
			,SUM(ISNULL(stuff1,0)) stuff1,SUM(ISNULL(stuff2,0)) stuff2
			,SUM(ISNULL(tolls,0)) tolls,SUM(ISNULL(reserve,0)) reserve
			,SUM(ISNULL(tax,0)) tax,sum(ISNULL(depreciation,0)) depreciation,SUM(ISNULL(profit,0)) profit
			from #z_trana02  ) a	
		order by pno,profit desc,carkindno,carkind,caryear,carno
	end;
	
z_tran_ds04:--z_tran_ds04
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_name nvarchar(20)
	
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_baddrno nvarchar(20)
	declare @t_eaddrno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	
	declare @t_carkind  nvarchar(max)
	declare @t_carteam  nvarchar(max)
	declare @t_calctypes  nvarchar(max)
	
	declare @t_rate01 nvarchar(10)
	declare @t_filter01 nvarchar(max)
	declare @t_option01 nvarchar(max)
	declare @t_sort01 nvarchar(max)
	declare @t_sort03 nvarchar(max)
	declare @t_filter04 nvarchar(max)
	declare @t_sort04 nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_name = '[2]'
	set @t_bdate = case when '#non'=[3] then '' else [3] end
	set @t_edate = case when '#non'=[4] then CHAR(255) else [4] end
	set @t_btrandate = case when '#non'=[5] then '' else [5] end
	set @t_etrandate = case when '#non'=[6] then CHAR(255) else [6] end
	
	set @t_bcustno = case when '#non'=[7] then '' else [7] end
	set @t_ecustno = case when '#non'=[8] then CHAR(255) else [8] end
	set @t_baddrno = case when '#non'=[9] then '' else [9] end
	set @t_eaddrno = case when '#non'=[10] then CHAR(255) else [10] end
	set @t_bdriverno = case when '#non'=[11] then '' else [11] end
	set @t_edriverno = case when '#non'=[12] then CHAR(255) else [12] end	
	set @t_carno = case when '#non'=[13] then '' else [13] end
	set @t_po = case when '#non'=[14] then '' else [14] end
	set @t_carkind  = case when '#non'=[15] then '' else [15] end
	set @t_carteam  = case when '#non'=[16] then '' else [16] end
	set @t_calctypes  = case when '#non'=[17] then '' else [17] end	
	set @t_rate01  = case when '#non'=[18] then '' else [18] end
	set @t_filter01  = case when '#non'=[19] then '' else [19] end
	set @t_option01  = case when '#non'=[20] then '' else [20] end
	set @t_sort01  = case when '#non'=[21] then '' else [21] end
	set @t_sort03  = case when '#non'=[22] then '' else [22] end
	set @t_filter04  = case when '#non'=[23] then '' else [23] end
	set @t_sort04  = case when '#non'=[24] then '' else [24] end
	-----------------------------------------------------------------------------------
	declare @string nvarchar(max)
	declare @n int
	--解析要計算的種類
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(20)
	)
	set @string = @t_carteam
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	IF OBJECT_ID('tempdb..#calctypes')is not null
	BEGIN
		set @cmd = 'drop table #calctypes'
		EXECUTE sp_executesql @cmd
	END
	create table #calctypes(
		noa nvarchar(20)
	)
	set @string = @t_calctypes
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctypes select @string
			end
			break
		end
		insert into #calctypes select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	----------------------------------------------------------------------------------------------
	--出車單
	IF OBJECT_ID('tempdb..#tmp1')is not null
	BEGIN
		set @cmd = 'drop table #tmp1'
		EXECUTE sp_executesql @cmd
	END
	create table #tmp1(
		p bit, -- 最後是否顯示
		tranno nvarchar(20),
		trannoq nvarchar(10),
		trandate nvarchar(20),
		custno nvarchar(20),
		carno nvarchar(20),
		driverno nvarchar(20),
		outside bit, --外車
		po nvarchar(40),
		addrno nvarchar(20),
		addr nvarchar(40),
		inmoney float,
		outmoney float,
		reserve float
	)
	set @cmd = 
	" select 1,a.noa,a.noq,a.trandate,a.custno,a.carno,a.driverno,isnull(b.isoutside,0),isnull(a.po,'')"+
	" ,isnull(a.straddrno,''),isnull(a.straddr,''),a.total,a.total2,a.reserve "+
	" from view_trans"+@t_accy+" a"+
	" left join calctypes b on a.calctype = b.noa+b.noq"+
	" left join car2 c on a.carno=c.carno"+
	" left join #carkind d on c.carkindno=d.noa"+
	" left join #carteam e on a.carteamno=e.noa"+
	" left join #calctypes f on a.calctype=f.noa"+
	" where not (isnull(a.total,0)=0 and isnull(a.total2,0)=0 and isnull(a.reserve,0)=0)"+
	" and (a.trandate between @t_btrandate and @t_etrandate)"+
	" and (a.custno between @t_bcustno and @t_ecustno )"+
	" and (a.straddrno between @t_baddrno and @t_eaddrno )"+
	" and (a.driverno between @t_bdriverno and @t_edriverno )"+
	" and (len(@t_carno)=0 or isnull(a.carno,'')=@t_carno)"+
	" and (len(@t_po)=0 or isnull(a.po,'')=@t_po)"+
	" and (d.noa is not null or exists(select * from #carkind where noa='all'))"+
	" and e.noa is not null"+
	" and f.noa is not null"
	insert into #tmp1
	execute sp_executesql @cmd,N'@t_po nvarchar(20),@t_carno nvarchar(20),@t_bdriverno nvarchar(20),@t_edriverno nvarchar(20),@t_baddrno nvarchar(20),@t_eaddrno nvarchar(20),@t_btrandate nvarchar(10),@t_etrandate nvarchar(10),@t_bcustno nvarchar(10),@t_ecustno nvarchar(10)'
	,@t_po=@t_po,@t_carno=@t_carno,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_baddrno=@t_baddrno,@t_eaddrno=@t_eaddrno,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno
	
	--該時間內所有出車單都需計算
	set @cmd = 
	" select 0,a.noa,a.noq,a.trandate,a.custno,a.carno,a.driverno,isnull(d.isoutside,0),isnull(a.po,'')"+
	" ,isnull(a.straddrno,''),isnull(a.straddr,''),a.total,a.total2,a.reserve "+
	" from view_trans"+@t_accy+" a"+
	" left join #tmp1 b on a.noa=b.tranno and a.noq=b.trannoq"+
	" left join (select left(trandate,6) mon from #tmp1 group by left(trandate,6)) c on left(a.trandate,6) = c.mon 	"+
	" left join calctypes d on a.calctype = d.noa+d.noq"+
	" where b.tranno is null and c.mon is not null"+
	" and not(isnull(a.total,0)=0 and isnull(a.total2,0)=0 and isnull(a.reserve,0)=0)"+
	" order by a.noa"
	insert into #tmp1
	execute sp_executesql @cmd,N'@t_btrandate nvarchar(10),@t_etrandate nvarchar(10),@t_bcustno nvarchar(10),@t_ecustno nvarchar(10)'
	,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno

	--客戶加減項
	declare @tmp2 table(
		mon nvarchar(10),
		custno nvarchar(20),
		plusmoney float,
		minusmoney float
	)
	insert into @tmp2
	select left(a.datea,6),a.custno,sum(isnull(a.plusmoney,0)),sum(isnull(a.minusmoney,0)) from custchg a
	left join (select custno,LEFT(trandate,6) mon from #tmp1 group by custno,LEFT(trandate,6)) b on a.custno=b.custno and left(a.datea,6)=b.mon
	where b.custno is not null and not (ISNULL(a.plusmoney,0)=0 and ISNULL(a.minusmoney,0)=0)
	group by left(a.datea,6),a.custno
	
	--達成金額
	declare @tmp3 table(
		mon nvarchar(10),
		driverno nvarchar(20),
		bonus float
	)
	insert into @tmp3
	select a.noa,a.driverno,a.bonus from carsals a
	left join (select LEFT(trandate,6) mon from #tmp1 group by LEFT(trandate,6)) b on a.noa=b.mon
	where b.mon is not null and ISNULL(a.bonus,0)!=0
	
	--司機加項
	declare @tmp4 table(
		mon nvarchar(10),
		driverno nvarchar(20),
		plusmoney float
	)
	insert into @tmp4
	select left(a.datea,6),a.driverno,SUM(ISNULL(a.plusmoney,0)) from carchg a
	left join (select LEFT(trandate,6) mon from #tmp1 group by LEFT(trandate,6)) b on left(a.datea,6)=b.mon
	where b.mon is not null and ISNULL(a.plusmoney,0)!=0
	group by left(a.datea,6),a.driverno
	
	--維修
	declare @tmp5 table(
		mon nvarchar(10),
		carno nvarchar(20),
		fixamoney float,
		tiremoney float
	)
	insert into @tmp5
	select left(a.fixadate,6),carno,SUM(ISNULL(a.wmoney,0)),SUM(ISNULL(a.cmoney,0)) from fixa a
	left join (select LEFT(trandate,6) mon from #tmp1 group by LEFT(trandate,6)) b on left(a.fixadate,6)=b.mon
	where b.mon is not null and not(ISNULL(a.wmoney,0)=0 and ISNULL(a.cmoney,0)=0)
	group by left(a.fixadate,6),carno
	
	--輪胎、零件領料
	declare @tmp6 table(
		mon nvarchar(10),
		carno nvarchar(20),
		tiremoney float
	)
	insert into @tmp6
	select left(a.outdate,6),carno,SUM(ISNULL(a.[money],0)) from fixout a
	left join (select LEFT(trandate,6) mon from #tmp1 group by LEFT(trandate,6)) b on left(a.outdate,6)=b.mon
	where b.mon is not null and not ISNULL(a.[money],0)=0
	group by left(a.outdate,6),carno
	
	--油費
	declare @tmp7 table(
		mon nvarchar(10),
		carno nvarchar(20),
		oilmoney float
	)
	insert into @tmp7
	select left(a.datea,6),carno,SUM(ISNULL(a.[money],0)) from oil a
	left join (select LEFT(trandate,6) mon from #tmp1 group by LEFT(trandate,6)) b on left(a.datea,6)=b.mon
	where b.mon is not null and not ISNULL(a.[money],0)=0
	group by left(a.datea,6),carno
	--通行費 
	declare @tmp8 table(
		mon nvarchar(10),
		carno nvarchar(20),
		tolls float
	)
	insert into @tmp8
	select left(a.datea,6),carno,SUM(ISNULL(a.[money],0)) from etc a
	left join (select LEFT(trandate,6) mon from #tmp1 group by LEFT(trandate,6)) b on left(a.datea,6)=b.mon
	where b.mon is not null and not ISNULL(a.[money],0)=0 and (typea='ETC' or typea='CASH')
	group by left(a.datea,6),carno
	--罰款 
	declare @tmp9 table(
		mon nvarchar(10),
		driverno nvarchar(20),
		ticket float
	)
	insert into @tmp9
	select left(a.datea,6),a.driverno,SUM(ISNULL(a.comppay,0)) from carborr a
	left join (select LEFT(trandate,6) mon from #tmp1 group by LEFT(trandate,6)) b on left(a.datea,6)=b.mon
	where b.mon is not null and not ISNULL(a.comppay,0)=0 
	group by left(a.datea,6),a.driverno
	--保牌燃費,折舊
	declare @tmp10 table(
		mon nvarchar(10),
		carno nvarchar(20),
		tax float,
		depreciation float
	)
	insert into @tmp10
	select a.mon,b.carno,sum(isnull(a.tax,0)),sum(isnull(a.depreciation,0)) from carts a
	left join cart b on a.noa = b.noa	
	left join (select LEFT(trandate,6) mon from #tmp1 group by LEFT(trandate,6)) c on c.mon=a.mon
	where c.mon is not null and not (ISNULL(a.tax,0)=0 and ISNULL(a.depreciation,0)=0)
	group by a.mon,b.carno
	----------------------------------------------------------------------------------------------------------	
	declare @tmp table( 
		sel int,
		gno nvarchar(3),
		pno int,
		csortkey nvarchar(max),
		nsortkey float,
		p bit,
		tranno nvarchar(20),
		trannoq nvarchar(10),
		custno nvarchar(20),
		carno nvarchar(20),
		driverno nvarchar(20),
		outside bit, --0 公司車, 1 外車
		trandate nvarchar(20),
		tranmon nvarchar(10),
		po nvarchar(40),
		addrno nvarchar(20),
		addr nvarchar(40),
		--收入--
		inmoney float,   --運費收入
		
		--支出--
		-------公司車,外車
		outmoney float,  --業績獎金
		reserve float, --寄櫃費
		
		-----依當月運費收入比例分攤
		custplus float, --客戶加項
		custminus float, --客戶減項
		
		
		-----依當月業績獎金比例分攤
		bonus float,  --達成金額
		carplus float, --司機加項
		fixa float, --維修
		tire float, --輪胎
		oilmoney float, --油費
		tolls float,--通行費 
		ticket float,--罰款 
		tax float,--保牌燃費
		depreciation float,--折舊
		
		--金額修正
		tmoney float,
		
		--淨利
		profit float
	) 
	--客戶收入
	declare @tmpCust table(
		custno nvarchar(20),
		mon nvarchar(10),
		inmoney float
	)
	insert into @tmpCust
	select a.custno,LEFT(a.trandate,6),sum(isnull(a.inmoney,0))
	from #tmp1 a
	group by a.custno,LEFT(a.trandate,6)
	--車輛收入
	declare @tmpCar table(
		carno nvarchar(20),
		mon nvarchar(10),
		outmoney float
	)
	insert into @tmpCar
	select a.carno,LEFT(a.trandate,6),sum(isnull(a.outmoney,0))
	from #tmp1 a
	group by a.carno,LEFT(a.trandate,6)
	--司機收入
	declare @tmpDriver table(
		driverno nvarchar(20),
		mon nvarchar(10),
		outmoney float
	)
	insert into @tmpDriver
	select a.driverno,LEFT(a.trandate,6),sum(isnull(a.outmoney,0))
	from #tmp1 a
	group by a.driverno,LEFT(a.trandate,6)
	
	declare @p bit
	declare @tranno nvarchar(20)
	declare @trannoq nvarchar(10)
	declare @trandate nvarchar(10)
	declare @tranmon nvarchar(10)
	declare @po nvarchar(40)
	declare @addrno nvarchar(20)
	declare @addr nvarchar(40)
	declare @custno nvarchar(20)
	declare @carno nvarchar(20)
	declare @driverno nvarchar(20)
	declare @outside bit
	declare @inmoney float
	declare @outmoney float
	declare @reserve float
	declare @custplus float
	declare @custminus float
	declare @bonus float
	declare @carplus float
	declare @fixa float
	declare @tire float
	declare @oilmoney float
	declare @tolls float
	declare @ticket float
	declare @tax float
	declare @depreciation float
	
	declare @cust_inmoney float
	declare @car_outmoney float
	declare @driver_outmoney float
	declare @tot_custplus float
	declare @tot_custminus float
	declare @tot_bonus float
	declare @tot_carplus float
	declare @tot_fixa float
	declare @tot_tire float
	declare @tot_oilmoney float
	declare @tot_tolls float
	declare @tot_ticket float
	declare @tot_tax float
	declare @tot_depreciation float
	declare @tmoney float
	declare @profit float
	
	declare cursor_table cursor for
	select p,tranno,trannoq,trandate,po,addrno,addr,custno,carno,driverno,outside,isnull(inmoney,0),isnull(outmoney,0),isnull(reserve,0) from #tmp1 
	open cursor_table
	fetch next from cursor_table
	into @p,@tranno,@trannoq,@trandate,@po,@addrno,@addr,@custno,@carno,@driverno,@outside,@inmoney,@outmoney,@reserve
	while(@@FETCH_STATUS <> -1)
	begin
		select @tranmon = LEFT(@trandate,6),@cust_inmoney = 0, @car_outmoney = 0, @driver_outmoney = 0
		,@tot_custplus = 0, @tot_custminus = 0
		,@tot_bonus = 0, @tot_carplus = 0, @tot_fixa = 0, @tot_tire = 0, @tot_oilmoney = 0, @tot_tolls = 0
		,@tot_ticket = 0, @tot_tax = 0, @tot_depreciation = 0
		
		select @cust_inmoney = inmoney from @tmpCust where custno=@custno and mon = @tranmon
		select @car_outmoney = outmoney from @tmpCar where carno=@carno and mon = @tranmon
		select @driver_outmoney = outmoney from @tmpDriver where driverno=@driverno and mon = @tranmon
		
		select @tot_custplus = plusmoney, @tot_custminus = minusmoney from @tmp2 where custno=@custno and mon = @tranmon 	
		select @tot_bonus = bonus from @tmp3 where driverno=@driverno and mon=@tranmon
		select @tot_carplus = plusmoney from @tmp4 where driverno=@driverno and mon=@tranmon
		select @tot_fixa = fixamoney,@tot_tire = tiremoney from @tmp5 where carno=@carno and mon=@tranmon
		select @tot_tire = isnull(@tot_tire,0)+isnull(tiremoney,0) from @tmp6 where carno=@carno and mon=@tranmon
		select @tot_oilmoney = oilmoney from @tmp7 where carno=@carno and mon=@tranmon
		select @tot_tolls = tolls from @tmp8 where carno=@carno and mon=@tranmon
		select @tot_ticket = ticket from @tmp9 where driverno=@driverno and mon=@tranmon
		select @tot_tax = tax, @tot_depreciation = depreciation from @tmp10 where carno=@carno and mon=@tranmon
		
		select @custplus = 0, @custminus = 0
		,@bonus = 0, @carplus = 0, @fixa = 0, @tire = 0, @oilmoney = 0, @tolls = 0
		,@ticket = 0, @tax = 0, @depreciation = 0
		--依運費比較算出 客戶加減項
		if ISNULL(@cust_inmoney,0)!=0
		begin--誤差稍後再修正
			select @custplus = ROUND(@inmoney/@cust_inmoney*@tot_custplus,0)
			,@custminus = ROUND(@inmoney/@cust_inmoney*@tot_custminus,0)
		end
		
		--依司機業績算出 達成獎金
		if ISNULL(@driver_outmoney,0)!=0
		begin--誤差稍後再修正
			select @bonus = ROUND(@outmoney/@driver_outmoney*@tot_bonus,0)
		end
		--依司機業績算出 司機加項
		if ISNULL(@driver_outmoney,0)!=0
		begin--誤差稍後再修正
			select @carplus = ROUND(@outmoney/@driver_outmoney*@tot_carplus,0)
		end
		--依車輛業績算出 維修、輪胎
		if ISNULL(@car_outmoney,0)!=0
		begin--誤差稍後再修正
			select @fixa = ROUND(@outmoney/@car_outmoney*@tot_fixa,0)
			,@tire = ROUND(@outmoney/@car_outmoney*@tot_tire,0)
		end
		--依車輛業績算出 油費
		if ISNULL(@car_outmoney,0)!=0
		begin--誤差稍後再修正
			select @oilmoney = ROUND(@outmoney/@car_outmoney*@tot_oilmoney,0)
		end
		--依車輛業績算出 通行費
		if ISNULL(@car_outmoney,0)!=0
		begin--誤差稍後再修正
			select @tolls = ROUND(@outmoney/@car_outmoney*@tot_tolls,0)
		end
		--依司機業績算出 罰單(公司付)
		if ISNULL(@driver_outmoney,0)!=0
		begin--誤差稍後再修正
			select @ticket = ROUND(@outmoney/@driver_outmoney*@tot_ticket,0)
		end
		--依車輛業績算出 稅費、折舊
		if ISNULL(@car_outmoney,0)!=0
		begin--誤差稍後再修正
			select @tax = ROUND(@outmoney/@car_outmoney*@tot_tax,0)
			,@depreciation = ROUND(@outmoney/@car_outmoney*@tot_depreciation,0)
		end
		
		insert into @tmp(p,tranno,trannoq,trandate,tranmon,po,addrno,addr,custno,carno,driverno,outside,inmoney,outmoney,reserve
		,custplus,custminus,bonus,carplus,fixa,tire,oilmoney,tolls,ticket,tax,depreciation)
		values(@p,@tranno,@trannoq,@trandate,@tranmon,@po,@addrno,@addr,@custno,@carno,@driverno,@outside,@inmoney,@outmoney,@reserve
		,@custplus,@custminus,@bonus,@carplus,@fixa,@tire,@oilmoney,@tolls,@ticket,@tax,@depreciation)

		fetch next from cursor_table
		into @p,@tranno,@trannoq,@trandate,@po,@addrno,@addr,@custno,@carno,@driverno,@outside,@inmoney,@outmoney,@reserve
	end
	close cursor_table
	deallocate cursor_table
	--客戶加項先忽略
	update @tmp set profit = inmoney - outmoney - reserve     -- custplus 
	- custminus - bonus - carplus 
	- fixa - tire - oilmoney - tolls - ticket - tax - depreciation
	--金額四捨五入問題 暫不計算
	
	delete @tmp where p=0	
	--排序 & 總計
	declare @csortkey nvarchar(max)
	declare @nsortkey float

	declare cursor_table cursor for
	select custno,sum(isnull(inmoney,0)),sum(isnull(outmoney,0)),sum(isnull(reserve,0))
	,sum(isnull(custplus,0)),sum(isnull(custminus,0)),sum(isnull(bonus,0)),sum(isnull(carplus,0))
	,sum(isnull(fixa,0)),sum(isnull(tire,0)),sum(isnull(oilmoney,0)),sum(isnull(tolls,0)),sum(isnull(ticket,0))
	,sum(isnull(tax,0)),sum(isnull(depreciation,0)),sum(isnull(tmoney,0)),sum(isnull(profit,0))
	from @tmp group by custno
	open cursor_table
	fetch next from cursor_table
	into @custno,@inmoney,@outmoney,@reserve,@custplus,@custminus,@bonus,@carplus,@fixa,@tire,@oilmoney
		,@tolls,@ticket,@tax,@depreciation,@tmoney,@profit
	while(@@FETCH_STATUS <> -1)
	begin
		select @csortkey='',@nsortkey=-999999999
		if(@t_sort04='custno')
		begin
			set @csortkey=@custno
		end
		if(@t_sort04='inmoney')
		begin
			set @nsortkey=@inmoney
		end
		if(@t_sort04='profit')
		begin
			set @nsortkey=@profit
		end
		update @tmp set gno='1',pno=2,csortkey = @csortkey,nsortkey = @nsortkey where custno=@custno
		insert into @tmp(gno,pno,csortkey,nsortkey,custno,tranno,inmoney,outmoney,reserve,custplus,custminus
			,bonus,carplus,fixa,tire,oilmoney,tolls,ticket,tax,depreciation,tmoney,profit)
		values('2',1,@csortkey,@nsortkey,@custno,CHAR(255),@inmoney,@outmoney,@reserve,@custplus,@custminus
		,@bonus,@carplus,@fixa,@tire,@oilmoney,@tolls,@ticket,@tax,@depreciation,@tmoney,@profit)
		
		fetch next from cursor_table
		into @custno,@inmoney,@outmoney,@reserve,@custplus,@custminus,@bonus,@carplus,@fixa,@tire,@oilmoney
		,@tolls,@ticket,@tax,@depreciation,@tmoney,@profit
	end
	close cursor_table
	deallocate cursor_table

	insert into @tmp
	select null,'3',3,char(255),-9999999999,null,null,null,null,null,null,null,null,null,null,null,null
	,sum(isnull(inmoney,0)),sum(isnull(outmoney,0)),sum(isnull(reserve,0))
	,sum(isnull(custplus,0)),sum(isnull(custminus,0)),sum(isnull(bonus,0)),sum(isnull(carplus,0))
	,sum(isnull(fixa,0)),sum(isnull(tire,0)),sum(isnull(oilmoney,0)),sum(isnull(tolls,0)),sum(isnull(ticket,0))
	,sum(isnull(tax,0)),sum(isnull(depreciation,0)),sum(isnull(tmoney,0)),sum(isnull(profit,0))
	from @tmp where gno='1'
	
	if(patindex("%trans%",@t_filter04)>0)
	begin		
		update @tmp set gno = '4' where gno='1' and profit<0
		update @tmp set gno = '5' where gno='2' and profit<0
	end
	else
	begin
		delete @tmp where gno='1'
		update @tmp set gno = '5' where gno='2' and profit<0
	end
	
	set @cmd = "交運日期："+@t_btrandate + '～'+@t_etrandate
	
	declare @sel int
	set @sel = 1
	if(@t_sort04='inmoney' or @t_sort04='profit')
	begin
		declare cursor_table cursor for
		select custno from @tmp where gno='2' or gno='5' order by nsortkey desc
		open cursor_table
		fetch next from cursor_table
		into @custno
		while(@@FETCH_STATUS <> -1)
		begin
			update @tmp set sel = @sel where (gno='2' or gno='5') and custno=@custno
			set @sel = @sel + 1
			fetch next from cursor_table
			into @custno
		end
		close cursor_table
		deallocate cursor_table
		
		select a.*
		,isnull(b.comp,'') comp
		,isnull(b.nick,'') nick
		,@cmd titlea
		,a.trandate dd
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.inmoney,0)),1)),4,12)) a01
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.outmoney,0)),1)),4,12)) a02
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.reserve,0)),1)),4,12)) a03
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.custplus,0)),1)),4,12)) a04
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.custminus,0)),1)),4,12)) a05
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.bonus,0)),1)),4,12)) a06
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.carplus,0)),1)),4,12)) a07
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.fixa,0)),1)),4,12)) a08
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.tire,0)),1)),4,12)) a09
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.oilmoney,0)),1)),4,12)) a10
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.tolls,0)),1)),4,12)) a11
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.ticket,0)),1)),4,12)) a12
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.tax,0)),1)),4,12)) a13
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.depreciation,0)),1)),4,12)) a14
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.tmoney,0)),1)),4,12)) a15
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.profit,0)),1)),4,12)) a16
		from @tmp a
		left join cust b on a.custno=b.noa
		order by nsortkey desc,pno
	end
	else
	begin
		declare cursor_table cursor for
		select custno from @tmp where gno='2' or gno='5' order by csortkey
		open cursor_table
		fetch next from cursor_table
		into @custno
		while(@@FETCH_STATUS <> -1)
		begin
			update @tmp set sel = @sel where (gno='2' or gno='5') and custno=@custno
			set @sel = @sel + 1
			fetch next from cursor_table
			into @custno
		end
		close cursor_table
		deallocate cursor_table
		
		select a.*
		,isnull(b.comp,'') comp
		,isnull(b.nick,'') nick
		,@cmd titlea
		,a.trandate dd
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.inmoney,0)),1)),4,12)) a01
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.outmoney,0)),1)),4,12)) a02
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.reserve,0)),1)),4,12)) a03
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.custplus,0)),1)),4,12)) a04
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.custminus,0)),1)),4,12)) a05
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.bonus,0)),1)),4,12)) a06
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.carplus,0)),1)),4,12)) a07
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.fixa,0)),1)),4,12)) a08
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.tire,0)),1)),4,12)) a09
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.oilmoney,0)),1)),4,12)) a10
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.tolls,0)),1)),4,12)) a11
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.ticket,0)),1)),4,12)) a12
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.tax,0)),1)),4,12)) a13
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.depreciation,0)),1)),4,12)) a14
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.tmoney,0)),1)),4,12)) a15
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.profit,0)),1)),4,12)) a16
		from @tmp a
		left join cust b on a.custno=b.noa
		order by csortkey,pno
	end
	drop table #tmp1;
	
z_tran_ds05:--z_tran_ds05
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_name nvarchar(20)
	
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_baddrno nvarchar(20)
	declare @t_eaddrno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	
	declare @t_carkind  nvarchar(max)
	declare @t_carteam  nvarchar(max)
	declare @t_calctypes  nvarchar(max)
	
	declare @t_rate01 nvarchar(10)
	declare @t_filter01 nvarchar(max)
	declare @t_option01 nvarchar(max)
	declare @t_sort01 nvarchar(max)
	declare @t_sort03 nvarchar(max)
	declare @t_filter04 nvarchar(max)
	declare @t_sort04 nvarchar(max)
	declare @t_sort05 nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_name = '[2]'
	set @t_bdate = case when '#non'=[3] then '' else [3] end
	set @t_edate = case when '#non'=[4] then CHAR(255) else [4] end
	set @t_btrandate = case when '#non'=[5] then '' else [5] end
	set @t_etrandate = case when '#non'=[6] then CHAR(255) else [6] end
	
	set @t_bcustno = case when '#non'=[7] then '' else [7] end
	set @t_ecustno = case when '#non'=[8] then CHAR(255) else [8] end
	set @t_baddrno = case when '#non'=[9] then '' else [9] end
	set @t_eaddrno = case when '#non'=[10] then CHAR(255) else [10] end
	set @t_bdriverno = case when '#non'=[11] then '' else [11] end
	set @t_edriverno = case when '#non'=[12] then CHAR(255) else [12] end	
	set @t_carno = case when '#non'=[13] then '' else [13] end
	set @t_po = case when '#non'=[14] then '' else [14] end
	set @t_carkind  = case when '#non'=[15] then '' else [15] end
	set @t_carteam  = case when '#non'=[16] then '' else [16] end
	set @t_calctypes  = case when '#non'=[17] then '' else [17] end	
	set @t_rate01  = case when '#non'=[18] then '' else [18] end
	set @t_filter01  = case when '#non'=[19] then '' else [19] end
	set @t_option01  = case when '#non'=[20] then '' else [20] end
	set @t_sort01  = case when '#non'=[21] then '' else [21] end
	set @t_sort03  = case when '#non'=[22] then '' else [22] end
	set @t_filter04  = case when '#non'=[23] then '' else [23] end
	set @t_sort04  = case when '#non'=[24] then '' else [24] end
	set @t_sort05  = case when '#non'=[25] then '' else [25] end
	----------------------------------------------------------------------------------------
	--解析要計算的種類
	declare @string nvarchar(max)
	declare @n int
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(20)
	)
	set @string = @t_carteam
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(20)
	)
	set @string = @t_calctypes
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	----------------------------------------------------------------------------------------------
	declare @count int
	declare @mount float
	declare @total float
	declare @mount2 float
	declare @total2 float
	declare @drivermoney float
	declare @inmount float
	declare @pton float
	declare @outmount float
	declare @pton2 float
	declare @driverno nvarchar(20)
	declare @carno nvarchar(20)
	declare @noa nvarchar(20)
	declare @x_key nvarchar(20)
	----------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#t_tran_ds05')is not null
	BEGIN
		set @cmd = 'drop table #t_tran_ds05'
		EXECUTE sp_executesql @cmd
	END
	create table #t_tran_ds05(
		gno nvarchar(3),
		trandate nvarchar(10),
		datea nvarchar(10),
		custno nvarchar(20),
		comp nvarchar(40),
		driverno nvarchar(20),
		namea nvarchar(20),
		carno nvarchar(20),
		straddrno nvarchar(20),
		addr nvarchar(40),
		product nvarchar(40),
		inmount float,
		pton float,
		mount decimal(10,3),
		price float,
		total float,
		outmount decimal(10,3),
		pton2 decimal(10,3),
		mount2 decimal(10,3),
		price2 float,
		price3 float,
		discount decimal(10,3),
		total2 float,
		drivermoney float,
		po nvarchar(30),
		caseno nvarchar(30),
		cc  nvarchar(20),
		tt  nvarchar(20),
		noa  nvarchar(20),
		carcount int
	)
	set @cmd = 
		" select  '0',a.trandate,a.datea,a.custno,left(a.comp,4),a.driverno,a.driver,a.carno,a.straddrno,a.straddr,a.product,"+
		" a.inmount,a.pton,a.mount,a.price,a.total,a.outmount,a.pton2,a.mount2,a.price2,a.price3,a.discount,a.total2,round((price2+price3)*mount2,0)"+
		",a.po,a.caseno,e.typea,d.team,a.noa,0"+
		" from  view_trans"+@t_accy+"  a"+
		" left join #carteam  b on a.carteamno=b.noa"+	
		" left join #calctype c on a.calctype=c.noa"+
		" left join carteam  d on a.carteamno=d.noa"+	
		" left join calctypes e on a.calctype=e.noa+e.noq"+
		" where "+
		" (a.datea  between  @t_bdate  and  @t_edate) and "+
		" (a.trandate  between  @t_btrandate  and  @t_etrandate) and "+
		" (a.custno  between  @t_bcustno   and  @t_ecustno) and "+
		" (a.driverno  between  @t_bdriverno   and  @t_edriverno) and "+
		" (len(@t_carno)=0  or  a.carno=@t_carno) and "+
		" (len(@t_po)=0  or  a.po=@t_po) and "+
		" (a.straddrno between @t_baddrno and @t_eaddrno) and"+
		" (b.noa  is  not  null) and (c.noa  is  not  null)"
	if @t_sort05='carno'  or @t_sort05='noa' or @t_sort05='driverno' 
		set  @cmd  =  @cmd+" order  by  a.driverno,a.carno,a.noa"
	else
		set  @cmd  =  @cmd+" order  by  a.driverno,a.carno,a.["+@t_sort05+"],a.noa"
	insert into #t_tran_ds05
	execute sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_btrandate nvarchar(10),@t_etrandate nvarchar(10),@t_bcustno nvarchar(20),@t_ecustno nvarchar(20),@t_bdriverno  nvarchar(20),@t_edriverno  nvarchar(20),@t_carno  nvarchar(20),@t_po  nvarchar(20),@t_baddrno  nvarchar(20),@t_eaddrno  nvarchar(20)',
		@t_bdate=@t_bdate,@t_edate=@t_edate,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_po=@t_po,@t_baddrno=@t_baddrno,@t_eaddrno=@t_eaddrno
		
	select @count=count(1),@mount=SUM(ISNULL(mount,0)),@mount2=SUM(ISNULL(mount2,0)),@total2=SUM(ISNULL(total2,0)),@drivermoney=SUM(ISNULL(drivermoney,0))
	,@outmount=SUM(isnull(outmount,0)),@pton2=SUM(ISNULL(pton2,0))
	,@inmount=SUM(ISNULL(inmount,0)),@pton=SUM(ISNULL(pton,0))
	,@total=SUM(ISNULL(total,0)) from #t_tran_ds05
	insert into #t_tran_ds05 (gno,driverno,carno,carcount,mount,total,mount2,total2,drivermoney,outmount,pton2,inmount,pton)
	values('2',CHAR(255),CHAR(255),@count,@mount,@total,@mount2,@total2,@drivermoney,@outmount,@pton2,@inmount,@pton) 
	
	
	if @t_sort05='carno'  or @t_sort05='noa' or @t_sort05='driverno' 
	begin 
		declare cursor_table cursor for
		select driverno,carno,count(1),max(noa),sum(isnull(mount,0)),sum(isnull(total,0)),sum(isnull(mount2,0)),sum(isnull(total2,0)),SUM(ISNULL(drivermoney,0))
		,SUM(isnull(outmount,0)),SUM(ISNULL(pton2,0)) 
		,SUM(isnull(inmount,0)),SUM(ISNULL(pton,0)) 
		from #t_tran_ds05 where gno='0' group  by  driverno,carno
		open cursor_table
		fetch next from cursor_table
		into @driverno,@carno,@count,@noa,@mount,@total,@mount2,@total2,@drivermoney,@outmount,@pton2,@inmount,@pton
		while(@@FETCH_STATUS <> -1)
		begin
			insert  into #t_tran_ds05(gno,driverno,carno,carcount,noa,mount,total,mount2,total2,drivermoney,outmount,pton2,inmount,pton)
			values('1',@driverno,@carno,@count,@noa+CHAR(255),@mount,@total,@mount2,@total2,@drivermoney,@outmount,@pton2,@inmount,@pton)		
			fetch next from cursor_table
			into @driverno,@carno,@count,@noa,@mount,@total,@mount2,@total2,@drivermoney,@outmount,@pton2,@inmount,@pton
		end
		close cursor_table
		deallocate cursor_table
	end
	else
	begin
		declare cursor_table cursor for
		select driverno,carno from #t_tran_ds05 where gno='0'  group  by  driverno,carno
		open cursor_table
		fetch next from cursor_table
		into @driverno,@carno
		while(@@FETCH_STATUS <> -1)
		begin
			set @x_key=''
			set @cmd="select @x_key=cast(max("+@t_sort05+") as  nvarchar) from  #t_tran_ds05 where driverno=@driverno and carno=@carno"
			execute sp_executesql @cmd,N'@driverno nvarchar(20),@carno  nvarchar(20),@x_key nvarchar(max) output',@driverno=@driverno,@carno=@carno,@x_key=@x_key output 
			
			set @noa=''
			set @cmd="select @noa=max(noa) from  #t_tran_ds05 where driverno=@driverno and carno=@carno and "+@t_sort05+"=@x_key"
			execute sp_executesql @cmd,N'@driverno nvarchar(20),@carno  nvarchar(20),@x_key nvarchar(max),@noa nvarchar(20) output',@driverno=@driverno,@carno=@carno,@x_key=@x_key,@noa=@noa output
			select @mount2=0,@total2=0
			select @count=count(1),@mount=sum(isnull(mount,0)),@mount2=sum(isnull(mount2,0)),@total2=sum(isnull(total2,0)),@drivermoney=sum(isnull(drivermoney,0)) 
			,@outmount=SUM(isnull(outmount,0)),@pton2=SUM(ISNULL(pton2,0)),@inmount=SUM(isnull(inmount,0)),@pton=SUM(ISNULL(pton,0))
			from #t_tran_ds05 where gno='0' and driverno=@driverno and carno=@carno
			
			set @cmd="insert  into  #t_tran_ds05(gno,driverno,carno,carcount,"+@t_sort05+",noa,mount,mount2,total2,drivermoney,outmount,pton2,inmount,pton)values('1',@driverno,@carno,@count,char(255),CHAR(255),@mount,@mount2,@total2,@drivermoney,@outmount,@pton2,@inmount,@pton)"
			execute sp_executesql @cmd,N'@driverno nvarchar(20),@carno  nvarchar(20),@mount2  float,@total2  float,@drivermoney float,@outmount float,@pton2 float,@inmount float,@pton float,@mount float,@count int'
			,@driverno=@driverno,@carno=@carno,@mount2=@mount2,@total2=@total2,@drivermoney=@drivermoney,@outmount=@outmount,@pton2=@pton2,@inmount=@inmount,@pton=@pton,@mount=@mount,@count=@count	
			
			fetch next from cursor_table
			into @driverno,@carno
		end
		close cursor_table
		deallocate cursor_table
	end
	
	if len(@t_bdate)>0
		set  @string  =  '登錄日期：'+@t_bdate+'～'+@t_edate
	else
		set  @string   =  '交運日期：'+@t_btrandate+'～'+@t_etrandate
		
	if @t_sort05='carno'  or @t_sort05='noa' or @t_sort05='driverno' 
	begin
		set @cmd = 
			" select @string titlea, gno,trandate  aa,custno bb,driverno mm,namea cc,carno dd,carcount ss,straddrno,addr,product ee,inmount pp1,pton qq1,mount ff1,outmount pp2,pton2 qq2,mount2 ff2,"+
			" case when price2=0 then price3 else price2 end gg,discount hh,"+
			" reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total2),1)),4,12)) ii,"+
			" caseno jj,case when right(noa,1)=char(255) then '' else noa  end kk, "+
			" reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,drivermoney),1)),4,12)) dm,"+
			" reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) ff3"+
			" from  #t_tran_ds05  order  by driverno,carno,gno,noa"
	end
	else
	begin
		set @cmd = " select @string titlea, gno,trandate  aa,custno bb,driverno mm,namea cc,carno dd,carcount ss,straddrno,addr,product ee,inmount pp1,pton qq1,mount ff1,outmount pp2,pton2 qq2,mount2 ff2,"+
			" case when price2=0 then price3 else price2 end gg,discount hh,"+
			" reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total2),1)),4,12)) ii,"+
			" caseno jj,noa kk, "+
			" reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,drivermoney),1)),4,12)) dm,"+
			" reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) ff3"+
			" from  #t_tran_ds05  order  by driverno,carno,gno,["+@t_sort05+"],noa"
	end
	EXECUTE sp_executesql @cmd,N'@string nvarchar(max)',@string=@string
	drop table #t_tran_ds05
	drop table #carkind
	drop table #calctype
	drop table #carteam;
	
z_tran_ds06:--z_tran_ds06
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_name nvarchar(20)
	
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_baddrno nvarchar(20)
	declare @t_eaddrno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	
	declare @t_carkind  nvarchar(max)
	declare @t_carteam  nvarchar(max)
	declare @t_calctypes  nvarchar(max)
	
	declare @t_rate01 nvarchar(10)
	declare @t_filter01 nvarchar(max)
	declare @t_option01 nvarchar(max)
	declare @t_sort01 nvarchar(max)
	declare @t_sort03 nvarchar(max)
	declare @t_filter04 nvarchar(max)
	declare @t_sort04 nvarchar(max)
	declare @t_sort05 nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_name = '[2]'
	set @t_bdate = case when '#non'=[3] then '' else [3] end
	set @t_edate = case when '#non'=[4] then CHAR(255) else [4] end
	set @t_btrandate = case when '#non'=[5] then '' else [5] end
	set @t_etrandate = case when '#non'=[6] then CHAR(255) else [6] end
	
	set @t_bcustno = case when '#non'=[7] then '' else [7] end
	set @t_ecustno = case when '#non'=[8] then CHAR(255) else [8] end
	set @t_baddrno = case when '#non'=[9] then '' else [9] end
	set @t_eaddrno = case when '#non'=[10] then CHAR(255) else [10] end
	set @t_bdriverno = case when '#non'=[11] then '' else [11] end
	set @t_edriverno = case when '#non'=[12] then CHAR(255) else [12] end	
	set @t_carno = case when '#non'=[13] then '' else [13] end
	set @t_po = case when '#non'=[14] then '' else [14] end
	set @t_carkind  = case when '#non'=[15] then '' else [15] end
	set @t_carteam  = case when '#non'=[16] then '' else [16] end
	set @t_calctypes  = case when '#non'=[17] then '' else [17] end	
	set @t_rate01  = case when '#non'=[18] then '' else [18] end
	set @t_filter01  = case when '#non'=[19] then '' else [19] end
	set @t_option01  = case when '#non'=[20] then '' else [20] end
	set @t_sort01  = case when '#non'=[21] then '' else [21] end
	set @t_sort03  = case when '#non'=[22] then '' else [22] end
	set @t_filter04  = case when '#non'=[23] then '' else [23] end
	set @t_sort04  = case when '#non'=[24] then '' else [24] end
	set @t_sort05  = case when '#non'=[25] then '' else [25] end
	----------------------------------------------------------------------------------------
	declare @string nvarchar(max)
	declare @n int
	----------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_tran27')is not null
	BEGIN
		set @cmd = 'drop table #z_tran27'
		EXECUTE sp_executesql @cmd
	END
	create table  #z_tran27(
		tranno nvarchar(20),
		custno nvarchar(20),
		datea nvarchar(10),
		trandate nvarchar(10),
		straddrno nvarchar(20),
		straddr nvarchar(40),
		carno nvarchar(20),
		productno nvarchar(20),
		product nvarchar(20),
		mount float,
		price float,
		[money] float,
		custorde nvarchar(40),
		po nvarchar(40),
		caseno nvarchar(20)
	)
	insert into #z_tran27(tranno,custno,datea,trandate,straddrno,straddr,carno,productno,product
		,mount,price,[money],custorde,po,caseno)
	select a.noa,a.custno,a.datea,a.trandate,a.straddrno,a.straddr,a.carno
	,a.uccno,a.product,a.mount,a.price,a.total,a.custorde,a.po
	,a.caseno
	 from  view_trans a 
	 left join carteam  d on a.carteamno=d.noa	
	 left join calctypes e on a.calctype=e.noa+e.noq
	 left join cust f on f.noa = a.custno 
	 where 
	 (isnull(a.datea,'') between @t_bdate and @t_edate) and
	 (isnull(a.trandate,'') between @t_btrandate and @t_etrandate) and 
	 (isnull(a.custno,'') between @t_bcustno and @t_ecustno) and
	 (isnull(a.driverno,'') between @t_bdriverno and @t_edriverno) and
	 (len(@t_carno) = 0 or a.carno = @t_carno) and
	 (len(@t_po)=0 or a.po = @t_po) and
	 (a.straddrno between @t_baddrno and @t_eaddrno)
	 and (len(@t_carteam)>0 or CHARINDEX(','+a.carteamno+',',','+@t_carteam+',')>0)
	 and (len(@t_calctypes)>0 or CHARINDEX(','+a.calctype+',',','+@t_calctypes+',')>0)

	declare @tmp table(
		gno nvarchar(10),
		pno nvarchar(10),
		custno nvarchar(20),
		tranno nvarchar(20),
		
		comp nvarchar(20),
		serial nvarchar(10),
		cust_addr nvarchar(40),
		cust_tel nvarchar(40),
		cust_fax nvarchar(40),
		
		trandate nvarchar(10),
		addrno nvarchar(20),
		addr nvarchar(20),
		carno nvarchar(20),
		product nvarchar(20),
		mount decimal(15,3),
		price decimal(10,3),
		[money] float,
		custorde nvarchar(40),
		caseno nvarchar(40)
	)
	declare @custno nvarchar(20)
	declare @cust nvarchar(20)
	declare @serial nvarchar(10)
	declare @cust_addr nvarchar(40)
	declare @cust_tel nvarchar(40)
	declare @cust_fax nvarchar(40)
	
	declare @tranno nvarchar(20)
	declare @trandate nvarchar(10)
	declare @addrno nvarchar(20)
	declare @addr nvarchar(40)
	declare @carno nvarchar(20)
	declare @product nvarchar(20)
	declare @mount float
	declare @price float
	declare @money float
	declare @custorde nvarchar(40)
	declare @caseno nvarchar(20)
	
	declare cursor_table cursor for
	select custno from #z_tran27 group by custno
	open cursor_table
	fetch next from cursor_table
	into @custno
	while(@@FETCH_STATUS <> -1)
	begin
		select @cust='',@serial='',@cust_addr='',@cust_tel='',@cust_fax=''
		select @cust=comp,@serial=serial,@cust_addr=addr_home,@cust_tel=tel,@cust_fax=fax
		from cust where noa=@custno

		declare cursor_table2 cursor for
		select tranno,trandate,straddrno,straddr,carno,product,mount,price,[money],isnull(custorde,''),isnull(caseno,'') 
		from #z_tran27 where custno=@custno
		open cursor_table2
		fetch next from cursor_table2
		into @tranno,@trandate,@addrno,@addr,@carno,@product,@mount,@price,@money,@custorde ,@caseno
		while(@@FETCH_STATUS <> -1)
		begin
			insert into @tmp
			(gno,pno,custno,comp,serial,cust_addr,cust_tel,cust_fax
			,tranno,trandate,addrno,addr,carno,product,mount,price,[money],custorde,caseno)
			values('0','1',@custno,@cust,@serial,@cust_addr,@cust_tel,@cust_fax
			,@tranno,@trandate,@addrno,@addr,@carno,@product,@mount,@price,@money,@custorde,@caseno)
			
			fetch next from cursor_table2
			into @tranno,@trandate,@addrno,@addr,@carno,@product,@mount,@price,@money,@custorde,@caseno
		end
		close cursor_table2
		deallocate cursor_table2
		--日小計     2013/04/01  說不要,不顯示
		--declare cursor_table2 cursor for
		--select trandate,sum(mount),sum([money]) from #z_tran27 
		--where custno=@custno group by trandate having count(1)>1
		--open cursor_table2
		--fetch next from cursor_table2
		--into @trandate,@mount,@money
		--while(@@FETCH_STATUS <> -1)
		--begin
		--	insert into @tmp
		--	(gno,pno,acomp,custno,comp,serial,cust_addr,cust_tel,cust_fax
		--	,trandate,mount,[money])
		--	values('1','2',@t_cno,@custno,@cust,@serial,@cust_addr,@cust_tel,@cust_fax
		--	,@trandate,@mount,@money)
			
		--	fetch next from cursor_table2
		--	into @trandate,@mount,@money
		--end
		--close cursor_table2
		--deallocate cursor_table2
		
		--總計
		select @mount=0, @money=0
		select @mount=sum(mount),@money=sum([money]) from #z_tran27 where custno=@custno
		insert into @tmp
		(gno,pno,custno,comp,serial,cust_addr,cust_tel,cust_fax
		,trandate,mount,[money])
		values('2','3',@custno,@cust,@serial,@cust_addr,@cust_tel,@cust_fax
		,CHAR(255),@mount,@money)
	
		fetch next from cursor_table
		into @custno
	end
	close cursor_table
	deallocate cursor_table
	select * 
	,trandate dd
	,product pp
	,dbo.getComma(mount,-1) mt
	,dbo.getComma(price,-1) mp
	,dbo.getComma([money],-1) mm
	from @tmp order by custno,trandate,pno,tranno
	
	drop table #z_tran27;
	
z_tran_ds07:--z_tran_ds07
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_name nvarchar(20)
	
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_baddrno nvarchar(20)
	declare @t_eaddrno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	
	declare @t_carkind  nvarchar(max)
	declare @t_carteam  nvarchar(max)
	declare @t_calctypes  nvarchar(max)
	
	declare @t_rate01 nvarchar(10)
	declare @t_filter01 nvarchar(max)
	declare @t_option01 nvarchar(max)
	declare @t_sort01 nvarchar(max)
	declare @t_sort03 nvarchar(max)
	declare @t_filter04 nvarchar(max)
	declare @t_sort04 nvarchar(max)
	declare @t_sort05 nvarchar(max)
	declare @t_option07 nvarchar(max)
	declare @z_plusmoney  nvarchar(max)
	declare @z_minusmoney  nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_name = '[2]'
	set @t_bdate = case when '#non'=[3] then '' else [3] end
	set @t_edate = case when '#non'=[4] then CHAR(255) else [4] end
	set @t_btrandate = case when '#non'=[5] then '' else [5] end
	set @t_etrandate = case when '#non'=[6] then CHAR(255) else [6] end
	
	set @t_bcustno = case when '#non'=[7] then '' else [7] end
	set @t_ecustno = case when '#non'=[8] then CHAR(255) else [8] end
	set @t_baddrno = case when '#non'=[9] then '' else [9] end
	set @t_eaddrno = case when '#non'=[10] then CHAR(255) else [10] end
	set @t_bdriverno = case when '#non'=[11] then '' else [11] end
	set @t_edriverno = case when '#non'=[12] then CHAR(255) else [12] end	
	set @t_carno = case when '#non'=[13] then '' else [13] end
	set @t_po = case when '#non'=[14] then '' else [14] end
	set @t_carkind  = case when '#non'=[15] then '' else [15] end
	set @t_carteam  = case when '#non'=[16] then '' else [16] end
	set @t_calctypes  = case when '#non'=[17] then '' else [17] end	
	set @t_rate01  = case when '#non'=[18] then '' else [18] end
	set @t_filter01  = case when '#non'=[19] then '' else [19] end
	set @t_option01  = case when '#non'=[20] then '' else [20] end
	set @t_sort01  = case when '#non'=[21] then '' else [21] end
	set @t_sort03  = case when '#non'=[22] then '' else [22] end
	set @t_filter04  = case when '#non'=[23] then '' else [23] end
	set @t_sort04  = case when '#non'=[24] then '' else [24] end
	set @t_sort05  = case when '#non'=[25] then '' else [25] end
	set @t_option07  = case when '#non'=[26] then '' else [26] end
	set @z_plusmoney  = case when '#non'=[27] then '' else [27] end
	set @z_minusmoney  = case when '#non'=[28] then '' else [28] end
	----------------------------------------------------------------------------------------------
	declare @string nvarchar(max) 
	declare @n int 
	declare @carno nvarchar(20) 
	declare @datea nvarchar(10) 
	declare @carkindno nvarchar(20) 
	declare @carkind	nvarchar(20) 
	declare @miles float 
	declare @tranmoney float 
	declare @drivermoney float 
	declare @reserve float 
	declare @mount float 
	declare @money float 

	declare @custno nvarchar(20) 
	declare @comp nvarchar(20) 
	declare @total float 
	declare @total2 float 
	declare @total3 float 
	declare @diff float 
	declare @trdmoney1 float 
	declare @trdmoney2 float 
	declare @trdmoney3 float 
	declare @unpay float 
	declare @total4 float 
	declare @plusmoney float 
	declare @minusmoney float 
	---------------------------------------------------------------------------------------------- 
	
	----------------------------------------------------------------------------------------------
	declare @tmp table(
		gno nvarchar(3),
		custno nvarchar(20),
		comp nvarchar(20),
		mon  nvarchar(10),
		total float,
		total2 float,--公司
		total3 float,--外車
		diff  float,
		trdmoney1  float,--當月請款
		trdmoney2  float,--上月請款 
		trdmoney3  float,--下月請款 
		unpay  float,		
		total4 float, --外車實發 
		plusmoney float,
		minusmoney float
	)
	
	set @cmd = " select  '0',a.custno,b.nick,left(a.datea,6),SUM(isnull(a.total,0)),"
	if  len(@t_option07)>0
		set @cmd = @cmd+" SUM(case when  e.isoutside=1 then 0 else isnull(a.total2,0) end),"+
						" SUM(case when  e.isoutside=1 then isnull(a.total2,0) else 0 end),"+
						" SUM(isnull(a.total,0)-isnull(a.total2,0)),"
	else
		set @cmd = @cmd+" SUM(case when  e.isoutside=1 then 0 else isnull(round(a.mount2*(a.price2+a.price3),0),0) end),"+
						" SUM(case when  e.isoutside=1 then isnull(round(a.mount2*(a.price2+a.price3),0),0) else 0 end),"+
						" SUM(isnull(a.total,0)-isnull(round(a.mount2*(a.price2+a.price3),0),0)),"
	set @cmd = @cmd+
		" sum(case  when isnull(g.mon,'')=left(a.datea,6) then isnull(f.tranmoney,0) else  0  end),"+
		" sum(case  when isnull(g.mon,'')<left(a.datea,6) then isnull(f.tranmoney,0) else  0  end),"+
		" sum(case  when isnull(g.mon,'')>left(a.datea,6) then isnull(f.tranmoney,0) else  0  end),"+
		" sum(case when len(isnull(f.noa,''))=0 then a.total else 0  end)  unpay,"+
		" SUM(case when  e.isoutside=1 then isnull(a.total2,0) else 0 end),"+
		" 0 plus,0 minus"+
		" from  view_trans a"+
		" left join cust b on a.custno=b.noa"+
		" left join calctypes e on a.calctype=e.noa+e.noq"+
		" left join view_trds f on a.noa=f.tranno and a.noq=f.trannoq"+
		" left join view_trd g on f.accy=g.accy and f.noa=g.noa"+ 
		" where "+
		" (a.datea between  @t_bdate and  @t_edate) and "+
		" (a.trandate between  @t_btrandate and  @t_etrandate) and "+
		" (a.custno  between  @t_bcustno   and  @t_ecustno) and "+
		" (isnull(a.driverno,'')  between  @t_bdriverno   and  @t_edriverno) and "+
		" (len(@t_carno)=0  or  a.carno=@t_carno) and "+
		" (len(@t_po)=0  or  a.po=@t_po) "+
		" and (a.straddrno between @t_baddrno and @t_eaddrno)"+
		" and (len(@t_carteam)>0 or CHARINDEX(','+a.carteamno+',',','+@t_carteam+',')>0)"+
		" and (len(@t_calctypes)>0 or CHARINDEX(','+a.calctype+',',','+@t_calctypes+',')>0)"+
		" group by a.custno,b.nick,left(a.datea,6)"
	insert into @tmp
	execute sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_btrandate nvarchar(10),@t_etrandate nvarchar(10),@t_bcustno nvarchar(20),@t_ecustno nvarchar(20),@t_bdriverno  nvarchar(20),@t_edriverno  nvarchar(20),@t_carno  nvarchar(20),@t_po  nvarchar(20),@t_baddrno  nvarchar(20),@t_eaddrno  nvarchar(20),@t_carteam nvarchar(max),@t_calctypes nvarchar(max)',
		@t_bdate=@t_bdate,@t_edate=@t_edate,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_po=@t_po,@t_baddrno=@t_baddrno,@t_eaddrno=@t_eaddrno,@t_carteam=@t_carteam,@t_calctypes=@t_calctypes
	-------------------------------------------------------------------------------------------------------------------
	declare cursor_table cursor for
	select custno,comp,count(1),sum(total),sum(total2),sum(total3),sum(diff) 
	,sum(trdmoney1),sum(trdmoney2),sum(trdmoney3),sum(unpay),sum(total4),sum(plusmoney),sum(minusmoney)
	from @tmp group by custno,comp
	open cursor_table
	fetch next from cursor_table
	into @custno,@comp,@n,@total,@total2,@total3,@diff,@trdmoney1,@trdmoney2,@trdmoney3,@unpay,@total4,@plusmoney,@minusmoney
	while(@@FETCH_STATUS <> -1)
	begin
		if @n>1
		begin
			insert into @tmp(gno,custno,comp,mon,total,total2,total3,diff,trdmoney1,trdmoney2,trdmoney3,unpay,total4,plusmoney,minusmoney)
			values('0',@custno,@comp,'小計：',@total,@total2,@total3,@diff,@trdmoney1,@trdmoney2,@trdmoney3,@unpay,@total4,@plusmoney,@minusmoney)	
		end
		insert into @tmp(gno,custno)values('1',@custno)
		fetch next from cursor_table
		into @custno,@comp,@n,@total,@total2,@total3,@diff,@trdmoney1,@trdmoney2,@trdmoney3,@unpay,@total4,@plusmoney,@minusmoney
	end
	close cursor_table
	deallocate cursor_table

	insert into @tmp select '2',CHAR(255),'',CHAR(255),SUM(total),SUM(total2),SUM(total3),SUM(diff),SUM(trdmoney1),SUM(trdmoney2),SUM(trdmoney3),SUM(unpay),SUM(total4),SUM(plusmoney),SUM(minusmoney) from @tmp where gno='0' and mon!='小計：'
	
	declare @noa nvarchar(20)
	declare @carteam nvarchar(20)
	set @cmd = ''
	declare cursor_table cursor for
	select a.noa,a.team from carteam a where len(@t_carteam)=0 or charindex(','+a.noa+',',','+@t_carteam+',')>0
	open cursor_table
	fetch next from cursor_table
	into @noa,@carteam
	while(@@FETCH_STATUS <> -1)
	begin
		set @cmd = @cmd+case when len(@cmd)>0 then ',' else '' end + @carteam
		fetch next from cursor_table
		into @noa,@carteam
	end
	close cursor_table
	deallocate cursor_table
	set @cmd = '【'+@cmd+'】'
	
	declare @plus float = 0
	declare @minus float = 0
	begin try
		set @plus = cast(@z_plusmoney as float)
		set @minus = cast(@z_minusmoney as float)
	end try
	begin catch
		set @plus = 0
		set @minus = 0
	end catch

	if len(@t_bdate)>0
		set  @cmd  =  '登錄日期：'+@t_bdate+'～'+@t_edate +'&nbsp'+char(59)+'&nbsp'+char(59)+ @cmd
	else
		set  @cmd  =  '交運日期：'+@t_btrandate+'～'+@t_etrandate+'&nbsp'+char(59)+'&nbsp'+char(59)+ @cmd
	select gno,@cmd titlea,custno cc,comp dd,mon
		,dbo.getComma( total,-1) total
		,dbo.getComma( total2,-1) total2
		,dbo.getComma( total3,-1) total3
		,dbo.getComma( diff,-1) diff
		,dbo.getComma( trdmoney1,-1) trdm1
		,dbo.getComma( trdmoney2,-1) trdm2
		,dbo.getComma( trdmoney3,-1) trdm3
		,dbo.getComma( unpay,-1) unpay
		,dbo.getComma( total4,-1) total4
		,dbo.getComma( plusmoney,-1) plusmoney
		,dbo.getComma( minusmoney,-1) minusmoney
		,dbo.getComma( total4,-1) +' + '+ 
			dbo.getComma( @plus,-1) +' - '+
			dbo.getComma( @minus,-1) +' = '+
			dbo.getComma( total4+@plus-@minusmoney,-1) total5
	from @tmp order by custno,gno,mon;
----------------------------------------------------------------------------------------------------
z_tran_nv01:--z_tran_nv01
	SET QUOTED_IDENTIFIER OFF
	declare @t_bdriverno nvarchar(20) = case when '#non'=[11] then '' else [11] end
	declare @t_edriverno nvarchar(20) = case when '#non'=[12] then CHAR(255) else [12] end	
	declare @t_carno nvarchar(20) = case when '#non'=[13] then '' else [13] end
	declare @t_bmon nvarchar(20) = case when '#non'=[44] then '' else [44] end
	declare @t_emon nvarchar(20) = case when '#non'=[45] then CHAR(255) else [45] end		

declare @tmp table(
	noa nvarchar(50),
	caryear nvarchar(50),
	suspdate nvarchar(50),
	driverno nvarchar(50),
	driver nvarchar(50)
)
insert @tmp
select a.noa,caryear,suspdate,driverno,driver from car2 a
left join driver b on a.driverno=b.noa
where (a.noa=@t_carno or len(@t_carno)=0)

declare @tmpa table(
	gno nvarchar(1),
	carno nvarchar(50),
	caryear nvarchar(10),
	driverno nvarchar(50),
	driver nvarchar(50),
	total float,
	product nvarchar(max)
)
insert @tmpa 
select '9',a.noa,a.caryear,b.driverno,case when len(b.driverno)!=0 then b.driver else '無司機' end,total,
case when len(a.suspdate)!=0 then '停駛/'+a.suspdate
else(select case when ISNULL(product,'')!='' then '/'+product end from view_trans where carno=a.noa group by product order by product FOR XML PATH(''))end
from @tmp a
left join view_trans b on a.noa=b.carno
where (left(b.datea,6) between @t_bmon and @t_emon)
and(a.noa=@t_carno or len(@t_carno)=0)
and(b.driverno between @t_bdriverno and @t_edriverno)

insert @tmpa 
select '0',carno,caryear,driverno,driver,sum(isnull(total,0)),substring(product,2,len(product))
from @tmpa
group by carno,caryear,driverno,driver,product

delete @tmpa where gno='9'

declare @tmpb table(
	gno nvarchar(1),
	carno nvarchar(50),
	driverno nvarchar(50),
	driver nvarchar(50),
	f1 float,--新人教育費
	f2 float,--車險
	f3 float,--燃料費
	f4 float,--牌照費
	f5 float,--攤提
	f6 float,--司機團保
	f7 float,--油資
	f8 float,--通行費
	f9 float,--公會
	f10 float,--GPS
	f11 float,--其他費用
	f12 float,--零件出售
	f13 float,--輪胎出售
	f14 float,--勞健保
	f15 float,--維修
	f16 float--輪胎
)
insert @tmpb
select '9',carno,driverno,driver
,case when acc2 like '%新人教育%' then isnull(plusmoney,0)-isnull(minusmoney,0) end
,case when acc2 like '%車險%'then isnull(plusmoney,0)-isnull(minusmoney,0) end
,case when acc2 like '%燃料費%'then isnull(plusmoney,0)-isnull(minusmoney,0) end
,case when acc2 like '%牌照費%'then isnull(plusmoney,0)-isnull(minusmoney,0) end
,case when acc2 like '%攤提%'then isnull(plusmoney,0)-isnull(minusmoney,0) end
,case when acc2 like '%司機團保%'then isnull(plusmoney,0)-isnull(minusmoney,0) end
,case when acc2 like '%油資%'then isnull(plusmoney,0)-isnull(minusmoney,0) end
,case when acc2 like '%通行費%'then isnull(plusmoney,0)-isnull(minusmoney,0) end
,case when acc2 like '%公會%'then isnull(plusmoney,0)-isnull(minusmoney,0) end
,case when acc2 like '%GPS%'then isnull(plusmoney,0)-isnull(minusmoney,0) end
,case when acc2 like '%其他費用%' or len(acc2)=0 then isnull(plusmoney,0)-isnull(minusmoney,0) end
,case when acc2 like '%零件出售%'then isnull(plusmoney,0)-isnull(minusmoney,0) end
,case when acc2 like '%輪胎出售%'then isnull(plusmoney,0)-isnull(minusmoney,0) end
,'','',''
from carchg
where isnull(carno,'')!=''
and (left(datea,6) between @t_bmon and @t_emon)
and(carno=@t_carno or len(@t_carno)=0)
and(driverno between @t_bdriverno and @t_edriverno)


insert @tmpb(gno,carno,driverno,driver,f14)
select '9',c.noa,a.noa,a.namea,(isnull(b.re_person,0)+ISNULL(b.la_person,0)+ISNULL(b.he_person,0))*-1
from driver a
left join salinsures b on a.noa=b.noa
left join @tmp c on a.noa=c.driverno
where isnull(c.noa,'')!=''
and (mon between @t_bmon and @t_emon)
and(c.noa=@t_carno or len(@t_carno)=0)
and(driverno between @t_bdriverno and @t_edriverno)
group by c.noa,a.noa,a.namea,b.re_person,b.la_person,b.he_person

insert @tmpb(gno,carno,driverno,driver,f15,f16)
select '9',carno,driverno,driver,wmoney,cmoney
from fixa
where isnull(carno,'')!=''
and (mon between @t_bmon and @t_emon)
and(carno=@t_carno or len(@t_carno)=0)
and(driverno between @t_bdriverno and @t_edriverno)

insert @tmpb
select '0',carno,driverno,driver,SUM(ISNULL(f1,0)),SUM(ISNULL(f2,0)),SUM(ISNULL(f3,0)),SUM(ISNULL(f4,0))
,SUM(ISNULL(f5,0)),SUM(ISNULL(f6,0)),SUM(ISNULL(f7,0)),SUM(ISNULL(f8,0)),SUM(ISNULL(f9,0)),SUM(ISNULL(f10,0))
,SUM(ISNULL(f11,0)),SUM(ISNULL(f12,0)),SUM(ISNULL(f13,0)),SUM(ISNULL(f14,0)),SUM(ISNULL(f15,0)),SUM(ISNULL(f16,0))
from @tmpb
group by carno,driverno,driver

delete @tmpb where gno='9'

declare @result table(
	gno nvarchar(1),
	rr int,
	carno nvarchar(50),
	caryear nvarchar(10),
	driverno nvarchar(50),
	driver nvarchar(50),
	total float,
	product nvarchar(max),
	f01 float,--新人教育費
	f2 float,--車險
	f3 float,--燃料費
	f4 float,--牌照費
	f5 float,--攤提
	f6 float,--司機團保
	f7 float,--油資
	f8 float,--通行費
	f9 float,--公會
	f10 float,--GPS
	f11 float,--其他費用
	f12 float,--零件出售
	f13 float,--輪胎出售
	f14 float,--勞健保
	f15 float,--維修
	f16 float,--輪胎
	t1 float,--小計
	t2 float--總計
)
insert @result(gno,carno,driverno,driver,caryear,product,total,f01,f2,f3,f4,f5,f6,f7,f8,f9,f10,f11,f12,f13,f14,f15,f16)
select '0',a.carno,a.driverno,a.driver,MAX(caryear),MAX(product),SUM(total),SUM(f1),SUM(f2),SUM(f3),SUM(f4),SUM(f5),SUM(f6),SUM(f7),SUM(f8),SUM(f9),SUM(f10),SUM(f11),SUM(f12),SUM(f13),SUM(f14),SUM(f15),SUM(f16)
from (select noa carno,driverno,driver,caryear,'' product,0 total,0 f1,0 f2,0 f3,0 f4,0 f5,0 f6,0 f7,0 f8,0 f9,0 f10,0 f11,0 f12,0 f13,0 f14,0 f15,0 f16 from @tmp
	union all
	select carno,driverno,driver,'' caryear,product,total,0 f1,0 f2,0 f3,0 f4,0 f5,0 f6,0 f7,0 f8,0 f9,0 f10,0 f11,0 f12,0 f13,0 f14,0 f15,0 f16 from @tmpa
	union all
	select carno,driverno,driver,'' caryear,'' product,0 total,f1,f2,f3,f4,f5,f6,f7,f8,f9,f10,f11,f12,f13,f14,f15,f16  from @tmpb)a
group by a.carno,a.driverno,a.driver

update a
set rr=rx
from (select ROW_NUMBER()over(partition by gno order by carno)rx,rr from @result)a

update @result
set t1=total+f01+f2+f3+f4+f5+f6+f7+f8+f9+f10+f11+f14+f15+f16,t2=total+f01+f2+f3+f4+f5+f6+f7+f8+f9+f10+f11+f12+f13+f14+f15+f16

select
dbo.getComma(total,0),dbo.getComma(t1,0)t1,dbo.getComma(t2,0)t2,dbo.getComma(f01*-1,0)f1,dbo.getComma(f2*-1,0)f2,dbo.getComma(f3*-1,0)f3
,dbo.getComma(f4*-1,0)f4,dbo.getComma(f5*-1,0)f5,dbo.getComma(f6*-1,0)f6
,dbo.getComma(f7*-1,0)f7,dbo.getComma(f8*-1,0)f8,dbo.getComma(f9*-1,0)f9
,dbo.getComma(f10*-1,0)f10,dbo.getComma(f11*-1,0)f11,dbo.getComma(f12*-1,0)f12
,dbo.getComma(f13*-1,0)f13,dbo.getComma(f14*-1,0)f14,dbo.getComma(f15*-1,0)f15,dbo.getComma(f16*-1,0)f16
, * from @result
;